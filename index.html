<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搬砖人生</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #4cc9f0;
            margin-bottom: 10px;
        }
        
        .countdown {
            font-size: 18px;
            color: #f72585;
            margin-bottom: 20px;
        }
        
        .auth-form {
            background-color: #16213e;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #a8dadc;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #457b9d;
            border-radius: 5px;
            background-color: #1d3557;
            color: white;
            font-size: 16px;
        }
        
        button {
            background-color: #f72585;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #b5179e;
        }
        
        .tab-container {
            display: none;
            background-color: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .active-tab {
            display: block;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #a8dadc;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-right: 5px;
        }
        
        .tab-btn.active {
            border-bottom: 3px solid #f72585;
            color: white;
        }
        
        .game-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background-color: #1d3557;
            padding: 15px;
            border-radius: 8px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            color: #4cc9f0;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 14px;
            color: #a8dadc;
        }
        
        .game-card {
            background-color: #1d3557;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        
        .game-title {
            color: #4cc9f0;
            margin-bottom: 10px;
        }
        
        .game-desc {
            color: #a8dadc;
            font-size: 14px;
        }
        
        .upgrade-btn {
            background-color: #4895ef;
            margin-top: 10px;
        }
        
        .upgrade-btn:hover {
            background-color: #3a7bd5;
        }
        
        .payment-methods {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .payment-method {
            text-align: center;
            padding: 15px;
            background-color: #1d3557;
            border-radius: 8px;
            width: 45%;
        }
        
        .payment-method img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
            max-height: 200px;
        }
        
        .admin-panel {
            background-color: #1d3557;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .admin-section {
            margin-bottom: 20px;
        }
        
        .admin-section h3 {
            color: #f72585;
            margin-bottom: 10px;
        }
        
        .user-list {
            list-style: none;
        }
        
        .user-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #16213e;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .leaderboard th, .leaderboard td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        .leaderboard th {
            background-color: #1d3557;
            color: #4cc9f0;
        }
        
        .leaderboard tr:nth-child(even) {
            background-color: rgba(29, 53, 87, 0.5);
        }
        
        .rank-1 { color: gold; font-weight: bold; }
        .rank-2 { color: silver; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }
        
        /* 大逃杀游戏样式 */
        .escape-room {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .room-card {
            background-color: #457b9d;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .room-card:hover {
            background-color: #1d3557;
            transform: translateY(-3px);
        }
        
        .room-card.selected {
            background-color: #f72585;
            border: 2px solid white;
        }
        
        .escape-stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .escape-stat {
            background-color: #1d3557;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
        }
        
        .escape-button {
            width: 100%;
            margin: 10px 0;
        }
        
        .escape-players {
            margin-top: 10px;
            font-size: 12px;
            color: #a8dadc;
        }
        
        /* 交易市场样式 */
        .market-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #333;
        }
        
        .market-action {
            display: flex;
            gap: 10px;
        }
        
        /* 排行榜标签样式 */
        .rank-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .rank-tab {
            padding: 8px 15px;
            background: none;
            border: none;
            color: #a8dadc;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-right: 5px;
        }
        
        .rank-tab.active {
            border-bottom: 3px solid #f72585;
            color: white;
        }
        
        /* 邀请好友列表样式 */
        .invited-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
        }
        
        .invited-user {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        
        .invited-user:last-child {
            border-bottom: none;
        }
        
        /* 上传按钮样式 */
        .upload-btn {
            background-color: #4895ef;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .upload-btn:hover {
            background-color: #3a7bd5;
        }
        
        /* 机器人样式 */
        .bot-tag {
            background-color: #6c757d;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 登录/注册表单 -->
        <div id="auth-container">
            <header>
                <h1>搬砖人生</h1>
                <div class="countdown" id="countdown">开服时间: 2025年5月1日</div>
            </header>
            
            <div class="auth-form" id="login-form">
                <h2>登录</h2>
                <div class="form-group">
                    <label for="login-username">用户名</label>
                    <input type="text" id="login-username" placeholder="输入用户名">
                </div>
                <div class="form-group">
                    <label for="login-password">密码</label>
                    <input type="password" id="login-password" placeholder="输入密码">
                </div>
                <button id="login-btn">登录</button>
                <p style="text-align: center; margin-top: 15px; color: #a8dadc;">
                    还没有账号? <a href="#" id="show-register" style="color: #4cc9f0;">立即注册</a>
                </p>
            </div>
            
            <div class="auth-form" id="register-form" style="display: none;">
                <h2>注册</h2>
                <div class="form-group">
                    <label for="reg-username">用户名</label>
                    <input type="text" id="reg-username" placeholder="输入用户名">
                </div>
                <div class="form-group">
                    <label for="reg-password">密码</label>
                    <input type="password" id="reg-password" placeholder="输入密码(至少6位)">
                </div>
                <div class="form-group">
                    <label for="reg-invite">邀请码(可选)</label>
                    <input type="text" id="reg-invite" placeholder="输入邀请码(可选)">
                </div>
                <button id="register-btn">注册</button>
                <p style="text-align: center; margin-top: 15px; color: #a8dadc;">
                    已有账号? <a href="#" id="show-login" style="color: #4cc9f0;">立即登录</a>
                </p>
            </div>
        </div>
        
        <!-- 主游戏界面 (默认隐藏) -->
        <div id="game-container" style="display: none;">
            <header>
                <h1>搬砖人生</h1>
                <div class="countdown" id="game-countdown"></div>
                <p id="user-info">�迎, <span id="username-display"></span> | 会员: <span id="vip-status">否</span></p>
            </header>
            
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="home">首页</button>
                <button class="tab-btn" data-tab="upgrade">升级</button>
                <button class="tab-btn" data-tab="games">小游戏</button>
                <button class="tab-btn" data-tab="market">交易市场</button>
                <button class="tab-btn" data-tab="vip">会员</button>
                <button class="tab-btn" data-tab="withdraw">提现</button>
                <button class="tab-btn" data-tab="invite">邀请</button>
                <button class="tab-btn" data-tab="rankings">排行榜</button>
                <button class="tab-btn" id="logout-btn">退出</button>
            </div>
            
            <!-- 首页 -->
            <div class="tab-container active-tab" id="home-tab">
                <div class="game-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="coin-display">0</div>
                        <div class="stat-label">砖块币</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="point-display">0</div>
                        <div class="stat-label">升级积分</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="level-display">1</div>
                        <div class="stat-label">等级</div>
                    </div>
                </div>
                
                <div class="game-card" id="mine-coins">
                    <h3 class="game-title">砖块矿场</h3>
                    <p class="game-desc">每小时自动生产5个砖块币，最多积累24小时</p>
                    <button id="collect-btn">收集砖块币</button>
                    <div id="mine-progress" style="margin-top: 10px;">
                        <div style="background-color: #333; height: 20px; border-radius: 10px;">
                            <div id="progress-bar" style="background-color: #4cc9f0; height: 100%; width: 0%; border-radius: 10px;"></div>
                        </div>
                        <p id="progress-text" style="text-align: center; margin-top: 5px;">0/5 砖块币</p>
                    </div>
                </div>
                
                <div class="game-card">
                    <h3 class="game-title">公告</h3>
                    <div id="announcement">
                        <p>1. 邀请好友升级到5级，邀请50人可联系管理员领取888红包</p>
                        <p>2. 排行榜每周刷新，前三名有现金奖励</p>
                        <p>3. 管理员微信: 19042507597</p>
                    </div>
                </div>
            </div>
            
            <!-- 升级 -->
            <div class="tab-container" id="upgrade-tab">
                <h2>升级系统</h2>
                <p>当前等级: <span id="current-level">1</span>/60</p>
                <p>升级所需积分: <span id="next-level-cost">0.3</span></p>
                <p>当前积分: <span id="current-points">0</span></p>
                <button id="upgrade-btn" class="upgrade-btn">升级</button>
                
                <h3 style="margin-top: 20px;">等级奖励</h3>
                <ul>
                    <li>1-5级: 每次升级免费</li>
                    <li>6-20级: 每次升级需要1积分</li>
                    <li>21-40级: 每次升级需要3积分</li>
                    <li>41-60级: 每次升级需要5积分</li>
                </ul>
            </div>
            
            <!-- 小游戏 -->
            <div class="tab-container" id="games-tab">
                <h2>小游戏</h2>
                <p>通过小游戏赚取升级积分</p>
                
                <div class="game-card" data-game="clicker">
                    <h3 class="game-title">点击赚积分</h3>
                    <p class="game-desc">每次点击获得0.01积分，消耗1砖块币/次</p>
                    <button class="play-game-btn">开始游戏</button>
                </div>
                
                <div class="game-card" data-game="memory">
                    <h3 class="game-title">记忆匹配</h3>
                    <p class="game-desc">匹配卡片获得积分，消耗2砖块币/次</p>
                    <button class="play-game-btn">开始游戏</button>
                </div>
                
                <div class="game-card" data-game="quiz">
                    <h3 class="game-title">知识问答</h3>
                    <p class="game-desc">回答正确获得积分，消耗3砖块币/次</p>
                    <button class="play-game-btn">开始游戏</button>
                </div>
                
                <!-- 新增大逃杀游戏 -->
                <div class="game-card" data-game="escape">
                    <h3 class="game-title">能量石-大谜杀</h3>
                    <p class="game-desc">选择房间躲避外星人，幸存者瓜分被杀房间的能量石</p>
                    <button class="play-game-btn">开始游戏</button>
                </div>
            </div>
            
            <!-- 交易市场 -->
            <div class="tab-container" id="market-tab">
                <h2>交易市场</h2>
                
                <div class="market-item">
                    <div>
                        <h3>砖块币兑换积分</h3>
                        <p>1砖块币 = 0.5积分</p>
                    </div>
                    <div class="market-action">
                        <input type="number" id="coin-to-point" min="1" max="100" value="1" style="width: 60px;">
                        <button id="exchange-coin-point">兑换</button>
                    </div>
                </div>
                
                <div class="market-item">
                    <div>
                        <h3>能量石兑换砖块币</h3>
                        <p>1能量石 = 1砖块币</p>
                    </div>
                    <div class="market-action">
                        <input type="number" id="stone-to-coin" min="1" max="100" value="1" style="width: 60px;">
                        <button id="exchange-stone-coin">兑换</button>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">交易记录</h3>
                <div id="market-history" style="margin-top: 10px;">
                    <p>暂无交易记录</p>
                </div>
            </div>
            
            <!-- 会员 -->
            <div class="tab-container" id="vip-tab">
                <h2>会员特权</h2>
                <div class="payment-methods">
                    <div class="payment-method">
                        <h3>支付宝</h3>
                        <img src="alipay_qr.jpg" alt="支付宝收款码" id="alipay-qr">
                        <p>支持信用卡/花呗付款</p>
                    </div>
                    <div class="payment-method">
                        <h3>微信支付</h3>
                        <img src="wechat_qr.jpg" alt="微信收款码" id="wechat-qr">
                        <p>扫码支付<span id="vip-price">32</span>元开通会员</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">会员特权</h3>
                <ul>
                    <li>每日额外获得10砖块币</li>
                    <li>小游戏消耗减少50%</li>
                    <li>提现手续费降低</li>
                    <li>专属会员标识</li>
                </ul>
                
                <button id="apply-vip" style="margin-top: 20px;">申请开通会员</button>
            </div>
            
            <!-- 提现 -->
            <div class="tab-container" id="withdraw-tab">
                <h2>提现申请</h2>
                <p>当前可提现砖块币: <span id="withdraw-coin">0</span></p>
                <div class="form-group">
                    <label for="withdraw-amount">提现金额</label>
                    <input type="number" id="withdraw-amount" placeholder="输入提现金额">
                </div>
                <div class="form-group">
                    <label for="withdraw-method">提现方式</label>
                    <select id="withdraw-method" style="width: 100%; padding: 12px; background-color: #1d3557; color: white; border: 1px solid #457b9d; border-radius: 5px;">
                        <option value="alipay">支付宝</option>
                        <option value="wechat">微信支付</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="withdraw-account">收款账号</label>
                    <input type="text" id="withdraw-account" placeholder="输入支付宝/微信账号">
                </div>
                <button id="submit-withdraw">提交提现申请</button>
                
                <h3 style="margin-top: 20px;">提现规则</h3>
                <ul>
                    <li>最低提现金额: 100砖块币</li>
                    <li>提现手续费: <span id="withdraw-fee">10</span>%</li>
                    <li>处理时间: 24小时内</li>
                </ul>
                
                <h3 style="margin-top: 20px;">提现记录</h3>
                <div id="withdraw-history" style="margin-top: 10px;">
                    <p>暂无提现记录</p>
                </div>
            </div>
            
            <!-- 邀请 -->
            <div class="tab-container" id="invite-tab">
                <h2>邀请好友</h2>
                <p>您的专属邀请码: <strong id="invite-code">LOADING...</strong></p>
                <p>已邀请好友: <span id="invited-count">0</span>人</p>
                <p>其中达到5级的: <span id="invited-level5">0</span>人</p>
                
                <h3 style="margin-top: 20px;">邀请奖励</h3>
                <ul>
                    <li>每邀请1人获得1砖块币</li>
                    <li>好友达到5级，额外获得5砖块币</li>
                    <li>邀请50人达到5级，联系管理员领取888红包</li>
                </ul>
                
                <button id="copy-invite" style="margin-top: 20px;">复制邀请链接</button>
                
                <h3 style="margin-top: 20px;">邀请好友列表</h3>
                <div class="invited-list" id="invited-list">
                    <p>暂无邀请好友</p>
                </div>
            </div>
            
            <!-- 排行榜 -->
            <div class="tab-container" id="rankings-tab">
                <h2>排行榜</h2>
                
                <div class="rank-tabs">
                    <button class="rank-tab active" data-rank="level">等级排行</button>
                    <button class="rank-tab" data-rank="invite">邀请排行</button>
                    <button class="rank-tab" data-rank="points">积分排行</button>
                </div>
                
                <div id="level-rank" class="rank-content">
                    <table class="leaderboard">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>用户名</th>
                                <th>等级</th>
                                <th>砖块币</th>
                            </tr>
                        </thead>
                        <tbody id="level-rank-body">
                            <tr>
                                <td colspan="4">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="invite-rank" class="rank-content" style="display: none;">
                    <table class="leaderboard">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>用户名</th>
                                <th>邀请人数</th>
                                <th>5级好友</th>
                            </tr>
                        </thead>
                        <tbody id="invite-rank-body">
                            <tr>
                                <td colspan="4">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="points-rank" class="rank-content" style="display: none;">
                    <table class="leaderboard">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>用户名</th>
                                <th>积分</th>
                                <th>等级</th>
                            </tr>
                        </thead>
                        <tbody id="points-rank-body">
                            <tr>
                                <td colspan="4">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 管理员面板 (默认隐藏) -->
        <div id="admin-container" style="display: none;">
            <header>
                <h1>搬砖人生 - 管理面板</h1>
                <button id="admin-logout" style="background-color: #f72585; padding: 8px 15px; margin-top: 10px;">退出管理</button>
            </header>
            
            <div class="admin-panel">
                <div class="admin-section">
                    <h3>系统设置</h3>
                    <div class="form-group">
                        <label for="vip-price-input">会员价格(元)</label>
                        <input type="number" id="vip-price-input" value="32" min="1">
                    </div>
                    <div class="form-group">
                        <label for="withdraw-fee-input">提现手续费(%)</label>
                        <input type="number" id="withdraw-fee-input" value="10" min="0" max="50">
                    </div>
                    <div class="form-group">
                        <label for="vip-fee-input">VIP提现手续费(%)</label>
                        <input type="number" id="vip-fee-input" value="5" min="0" max="50">
                    </div>
                    <button id="save-settings">保存设置</button>
                </div>
                
                <div class="admin-section">
                    <h3>支付二维码</h3>
                    <div class="form-group">
                        <label for="alipay-qr-input">支付宝二维码URL</label>
                        <input type="text" id="alipay-qr-input" placeholder="输入支付宝二维码URL">
                    </div>
                    <div class="form-group">
                        <label for="alipay-qr-upload">或上传支付宝二维码</label>
                        <input type="file" id="alipay-qr-upload" accept="image/*">
                        <button class="upload-btn" id="upload-alipay">上传</button>
                    </div>
                    <div class="form-group">
                        <label for="wechat-qr-input">微信二维码URL</label>
                        <input type="text" id="wechat-qr-input" placeholder="输入微信二维码URL">
                    </div>
                    <div class="form-group">
                        <label for="wechat-qr-upload">或上传微信二维码</label>
                        <input type="file" id="wechat-qr-upload" accept="image/*">
                        <button class="upload-btn" id="upload-wechat">上传</button>
                    </div>
                    <button id="update-qr">更新二维码</button>
                </div>
                
                <div class="admin-section">
                    <h3>会员申请</h3>
                    <ul class="user-list" id="vip-requests">
                        <li>加载中...</li>
                    </ul>
                </div>
                
                <div class="admin-section">
                    <h3>提现申请</h3>
                    <ul class="user-list" id="withdraw-requests">
                        <li>加载中...</li>
                    </ul>
                </div>
                
                <div class="admin-section">
                    <h3>用户管理</h3>
                    <div class="form-group">
                        <input type="text" id="search-user" placeholder="搜索用户名">
                    </div>
                    <ul class="user-list" id="user-list">
                        <li>加载中...</li>
                    </ul>
                </div>
                
                <div class="admin-section">
                    <h3>公告编辑</h3>
                    <div class="form-group">
                        <textarea id="announcement-edit" rows="4" style="width: 100%; padding: 10px; background-color: #1d3557; color: white; border: 1px solid #457b9d; border-radius: 5px;"></textarea>
                    </div>
                    <button id="save-announcement">保存公告</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 游戏模态框 -->
    <div class="modal" id="game-modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="game-modal-title">游戏名称</h2>
            <div id="game-modal-content">
                <!-- 游戏内容动态加载 -->
            </div>
        </div>
    </div>
    
    <script>
        // 游戏数据
        const gameData = {
            users: {},
            currentUser: null,
            adminUser: { username: "admin", password: "admin123" },
            announcements: [
                "邀请好友升级到5级，邀请50人可联系管理员领取888红包",
                "排行榜每周刷新，前三名有现金奖励",
                "管理员微信: 19042507597"
            ],
            vipPrice: 32,
            withdrawFee: 10,
            vipWithdrawFee: 5,
            paymentQR: {
                alipay: "alipay_qr.jpg",
                wechat: "wechat_qr.jpg"
            },
            vipRequests: [],
            withdrawRequests: [],
            escapeRooms: {
                rooms: ["量茶间", "太憩舱", "航指室", "星沙龙", "星洁室", "星悠室", "里空间", "音乐舱", "里悠室"],
                players: {},
                gameInProgress: false,
                countdown: 0,
                countdownInterval: null,
                bots: []
            },
            marketHistory: []
        };

        // DOM元素
        const elements = {
            authContainer: document.getElementById('auth-container'),
            gameContainer: document.getElementById('game-container'),
            adminContainer: document.getElementById('admin-container'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            showLogin: document.getElementById('show-login'),
            showRegister: document.getElementById('show-register'),
            loginBtn: document.getElementById('login-btn'),
            registerBtn: document.getElementById('register-btn'),
            loginUsername: document.getElementById('login-username'),
            loginPassword: document.getElementById('login-password'),
            regUsername: document.getElementById('reg-username'),
            regPassword: document.getElementById('reg-password'),
            regInvite: document.getElementById('reg-invite'),
            logoutBtn: document.getElementById('logout-btn'),
            adminLogout: document.getElementById('admin-logout'),
            usernameDisplay: document.getElementById('username-display'),
            vipStatus: document.getElementById('vip-status'),
            coinDisplay: document.getElementById('coin-display'),
            pointDisplay: document.getElementById('point-display'),
            levelDisplay: document.getElementById('level-display'),
            currentLevel: document.getElementById('current-level'),
            nextLevelCost: document.getElementById('next-level-cost'),
            currentPoints: document.getElementById('current-points'),
            upgradeBtn: document.getElementById('upgrade-btn'),
            collectBtn: document.getElementById('collect-btn'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            mineCoins: document.getElementById('mine-coins'),
            inviteCode: document.getElementById('invite-code'),
            invitedCount: document.getElementById('invited-count'),
            invitedLevel5: document.getElementById('invited-level5'),
            copyInvite: document.getElementById('copy-invite'),
            applyVip: document.getElementById('apply-vip'),
            withdrawCoin: document.getElementById('withdraw-coin'),
            withdrawAmount: document.getElementById('withdraw-amount'),
            withdrawMethod: document.getElementById('withdraw-method'),
            withdrawAccount: document.getElementById('withdraw-account'),
            submitWithdraw: document.getElementById('submit-withdraw'),
            withdrawFee: document.getElementById('withdraw-fee'),
            withdrawHistory: document.getElementById('withdraw-history'),
            vipRequests: document.getElementById('vip-requests'),
            withdrawRequests: document.getElementById('withdraw-requests'),
            userList: document.getElementById('user-list'),
            searchUser: document.getElementById('search-user'),
            announcementEdit: document.getElementById('announcement-edit'),
            saveAnnouncement: document.getElementById('save-announcement'),
            saveSettings: document.getElementById('save-settings'),
            vipPriceInput: document.getElementById('vip-price-input'),
            withdrawFeeInput: document.getElementById('withdraw-fee-input'),
            vipFeeInput: document.getElementById('vip-fee-input'),
            alipayQrInput: document.getElementById('alipay-qr-input'),
            wechatQrInput: document.getElementById('wechat-qr-input'),
            alipayQrUpload: document.getElementById('alipay-qr-upload'),
            wechatQrUpload: document.getElementById('wechat-qr-upload'),
            uploadAlipay: document.getElementById('upload-alipay'),
            uploadWechat: document.getElementById('upload-wechat'),
            updateQr: document.getElementById('update-qr'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            tabs: document.querySelectorAll('.tab-container'),
            countdown: document.getElementById('countdown'),
            gameCountdown: document.getElementById('game-countdown'),
            gameModal: document.getElementById('game-modal'),
            gameModalTitle: document.getElementById('game-modal-title'),
            gameModalContent: document.getElementById('game-modal-content'),
            playGameBtns: document.querySelectorAll('.play-game-btn'),
            invitedList: document.getElementById('invited-list'),
            coinToPoint: document.getElementById('coin-to-point'),
            exchangeCoinPoint: document.getElementById('exchange-coin-point'),
            stoneToCoin: document.getElementById('stone-to-coin'),
            exchangeStoneCoin: document.getElementById('exchange-stone-coin'),
            marketHistory: document.getElementById('market-history'),
            rankTabs: document.querySelectorAll('.rank-tab'),
            rankContents: document.querySelectorAll('.rank-content'),
            levelRankBody: document.getElementById('level-rank-body'),
            inviteRankBody: document.getElementById('invite-rank-body'),
            pointsRankBody: document.getElementById('points-rank-body'),
            vipPriceDisplay: document.getElementById('vip-price'),
            alipayQr: document.getElementById('alipay-qr'),
            wechatQr: document.getElementById('wechat-qr')
        };

        // 初始化游戏
        function initGame() {
            // 检查本地存储
            if (localStorage.getItem('pmGameData')) {
                const savedData = JSON.parse(localStorage.getItem('pmGameData'));
                Object.assign(gameData, savedData);
            }
            
            // 设置开服倒计时
            updateCountdown();
            setInterval(updateCountdown, 1000);
            
            // 事件监听器
            setupEventListeners();
            
            // 检查是否有已登录用户
            if (localStorage.getItem('pmCurrentUser')) {
                const username = localStorage.getItem('pmCurrentUser');
                if (gameData.users[username]) {
                    loginUser(username);
                } else if (username === 'admin') {
                    loginAdmin();
                }
            }
        }

        // 更新开服倒计时
        function updateCountdown() {
            const launchDate = new Date('2025-05-01T00:00:00');
            const now = new Date();
            
            if (now >= launchDate) {
                elements.countdown.textContent = "游戏已开服";
                elements.gameCountdown.textContent = "开服时间: 2025年5月1日";
                return;
            }
            
            const diff = launchDate - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            elements.countdown.textContent = `开服倒计时: ${days}天 ${hours}小时 ${minutes}分 ${seconds}秒`;
            elements.gameCountdown.textContent = `开服倒计时: ${days}天 ${hours}小时 ${minutes}分 ${seconds}秒`;
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 登录/注册切换
            elements.showLogin.addEventListener('click', (e) => {
                e.preventDefault();
                elements.loginForm.style.display = 'block';
                elements.registerForm.style.display = 'none';
            });
            
            elements.showRegister.addEventListener('click', (e) => {
                e.preventDefault();
                elements.loginForm.style.display = 'none';
                elements.registerForm.style.display = 'block';
            });
            
            // 登录按钮
            elements.loginBtn.addEventListener('click', () => {
                const username = elements.loginUsername.value.trim();
                const password = elements.loginPassword.value.trim();
                
                if (!username || !password) {
                    alert('请输入用户名和密码');
                    return;
                }
                
                // 检查管理员登录
                if (username === gameData.adminUser.username && password === gameData.adminUser.password) {
                    loginAdmin();
                    return;
                }
                
                // 检查普通用户
                if (!gameData.users[username]) {
                    alert('用户名不存在');
                    return;
                }
                
                if (gameData.users[username].password !== password) {
                    alert('密码错误');
                    return;
                }
                
                loginUser(username);
            });
            
            // 注册按钮
            elements.registerBtn.addEventListener('click', () => {
                const username = elements.regUsername.value.trim();
                const password = elements.regPassword.value.trim();
                const inviteCode = elements.regInvite.value.trim();
                
                if (!username || !password) {
                    alert('请输入用户名和密码');
                    return;
                }
                
                if (password.length < 6) {
                    alert('密码至少需要6位');
                    return;
                }
                
                if (gameData.users[username]) {
                    alert('用户名已存在');
                    return;
                }
                
                // 创建新用户
                const newUser = {
                    username,
                    password,
                    coins: 0,
                    points: 0,
                    level: 1,
                    isVIP: false,
                    lastMineTime: Date.now(),
                    minedCoins: 0,
                    inviteCode: generateInviteCode(),
                    invitedUsers: [],
                    invitedLevel5Users: [],
                    vipRequested: false,
                    withdrawHistory: [],
                    marketHistory: [],
                    energyStones: 0
                };
                
                gameData.users[username] = newUser;
                
                // 处理邀请码
                if (inviteCode) {
                    const inviter = findUserByInviteCode(inviteCode);
                    if (inviter) {
                        inviter.invitedUsers.push(username);
                        inviter.coins += 1; // 邀请奖励
                        
                        // 更新邀请者数据
                        gameData.users[inviter.username] = inviter;
                    }
                }
                
                // 保存数据
                saveGameData();
                
                alert('注册成功！');
                elements.loginForm.style.display = 'block';
                elements.registerForm.style.display = 'none';
                elements.loginUsername.value = username;
                elements.loginPassword.value = '';
            });
            
            // 退出登录
            elements.logoutBtn.addEventListener('click', logoutUser);
            elements.adminLogout.addEventListener('click', logoutAdmin);
            
            // 标签页切换
            elements.tabBtns.forEach(btn => {
                if (btn.id !== 'logout-btn') {
                    btn.addEventListener('click', () => {
                        const tabId = btn.getAttribute('data-tab');
                        switchTab(tabId);
                        
                        // 如果是排行榜标签，加载排行榜数据
                        if (tabId === 'rankings') {
                            loadRankings('level');
                        }
                    });
                }
            });
            
            // 排行榜标签切换
            elements.rankTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const rankType = tab.getAttribute('data-rank');
                    
                    // 更新标签状态
                    elements.rankTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // 更新内容显示
                    elements.rankContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    document.getElementById(`${rankType}-rank`).style.display = 'block';
                    
                    // 加载排行榜数据
                    loadRankings(rankType);
                });
            });
            
            // 关闭模态框
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.gameModal.style.display = 'none';
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', (e) => {
                if (e.target === elements.gameModal) {
                    elements.gameModal.style.display = 'none';
                }
            });
            
            // 收集砖块币
            elements.collectBtn.addEventListener('click', collectCoins);
            
            // 升级
            elements.upgradeBtn.addEventListener('click', upgradeLevel);
            
            // 小游戏按钮
            elements.playGameBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const gameCard = e.target.closest('.game-card');
                    const gameName = gameCard.getAttribute('data-game');
                    startGame(gameName);
                });
            });
            
            // 复制邀请链接
            elements.copyInvite.addEventListener('click', copyInviteLink);
            
            // 申请会员
            elements.applyVip.addEventListener('click', applyForVIP);
            
            // 提交提现申请
            elements.submitWithdraw.addEventListener('click', submitWithdrawRequest);
            
            // 管理员保存设置
            elements.saveSettings.addEventListener('click', saveAdminSettings);
            
            // 更新支付二维码
            elements.updateQr.addEventListener('click', updatePaymentQR);
            
            // 上传支付宝二维码
            elements.uploadAlipay.addEventListener('click', () => uploadQR('alipay'));
            
            // 上传微信二维码
            elements.uploadWechat.addEventListener('click', () => uploadQR('wechat'));
            
            // 保存公告
            elements.saveAnnouncement.addEventListener('click', saveAnnouncement);
            
            // 搜索用户
            elements.searchUser.addEventListener('input', searchUsers);
            
            // 交易市场兑换
            elements.exchangeCoinPoint.addEventListener('click', exchangeCoinToPoint);
            elements.exchangeStoneCoin.addEventListener('click', exchangeStoneToCoin);
        }

        // 上传二维码
        function uploadQR(type) {
            const fileInput = type === 'alipay' ? elements.alipayQrUpload : elements.wechatQrUpload;
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请先选择图片文件');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataURL = e.target.result;
                
                // 更新对应的输入框
                if (type === 'alipay') {
                    elements.alipayQrInput.value = dataURL;
                } else {
                    elements.wechatQrInput.value = dataURL;
                }
                
                alert('二维码已上传，请点击"更新二维码"保存');
            };
            reader.readAsDataURL(file);
        }

        // 生成邀请码
        function generateInviteCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // 通过邀请码查找用户
        function findUserByInviteCode(code) {
            for (const username in gameData.users) {
                if (gameData.users[username].inviteCode === code) {
                    return gameData.users[username];
                }
            }
            return null;
        }

        // 登录用户
        function loginUser(username) {
            gameData.currentUser = gameData.users[username];
            localStorage.setItem('pmCurrentUser', username);
            
            // 更新UI
            elements.authContainer.style.display = 'none';
            elements.gameContainer.style.display = 'block';
            elements.adminContainer.style.display = 'none';
            
            updateUserUI();
            startMiningTimer();
            loadInvitedList();
            loadWithdrawHistory();
            loadMarketHistory();
        }

        // 登录管理员
        function loginAdmin() {
            localStorage.setItem('pmCurrentUser', 'admin');
            
            // 更新UI
            elements.authContainer.style.display = 'none';
            elements.gameContainer.style.display = 'none';
            elements.adminContainer.style.display = 'block';
            
            // 加载管理员数据
            loadAdminData();
            
            // 设置表单初始值
            elements.vipPriceInput.value = gameData.vipPrice;
            elements.withdrawFeeInput.value = gameData.withdrawFee;
            elements.vipFeeInput.value = gameData.vipWithdrawFee;
            elements.alipayQrInput.value = gameData.paymentQR.alipay;
            elements.wechatQrInput.value = gameData.paymentQR.wechat;
            elements.announcementEdit.value = gameData.announcements.join('\n');
        }

        // 退出用户
        function logoutUser() {
            gameData.currentUser = null;
            localStorage.removeItem('pmCurrentUser');
            
            // 重置表单
            elements.loginUsername.value = '';
            elements.loginPassword.value = '';
            
            // 更新UI
            elements.authContainer.style.display = 'block';
            elements.gameContainer.style.display = 'none';
            elements.adminContainer.style.display = 'none';
            elements.loginForm.style.display = 'block';
            elements.registerForm.style.display = 'none';
        }

        // 退出管理员
        function logoutAdmin() {
            localStorage.removeItem('pmCurrentUser');
            
            // 更新UI
            elements.authContainer.style.display = 'block';
            elements.gameContainer.style.display = 'none';
            elements.adminContainer.style.display = 'none';
            elements.loginForm.style.display = 'block';
            elements.registerForm.style.display = 'none';
        }

        // 更新用户界面
        function updateUserUI() {
            const user = gameData.currentUser;
            
            elements.usernameDisplay.textContent = user.username;
            elements.vipStatus.textContent = user.isVIP ? '是' : '否';
            elements.vipStatus.style.color = user.isVIP ? '#4cc9f0' : '#f72585';
            
            elements.coinDisplay.textContent = user.coins;
            elements.pointDisplay.textContent = user.points.toFixed(2);
            elements.levelDisplay.textContent = user.level;
            elements.currentLevel.textContent = user.level;
            
            // 计算下一级所需积分
            let nextLevelCost = 0;
            if (user.level < 5) {
                nextLevelCost = user.level === 1 ? 0.3 : 0.1;
            } else if (user.level < 20) {
                nextLevelCost = 1;
            } else if (user.level < 40) {
                nextLevelCost = 3;
            } else if (user.level < 60) {
                nextLevelCost = 5;
            }
            
            elements.nextLevelCost.textContent = nextLevelCost;
            elements.currentPoints.textContent = user.points.toFixed(2);
            
            // 更新邀请信息
            elements.inviteCode.textContent = user.inviteCode;
            elements.invitedCount.textContent = user.invitedUsers.length;
            elements.invitedLevel5.textContent = user.invitedLevel5Users.length;
            
            // 更新可提现砖块币
            elements.withdrawCoin.textContent = user.coins;
            
            // 更新提现手续费
            elements.withdrawFee.textContent = user.isVIP ? gameData.vipWithdrawFee : gameData.withdrawFee;
            
            // 更新VIP价格显示
            elements.vipPriceDisplay.textContent = gameData.vipPrice;
        }

        // 加载邀请好友列表
        function loadInvitedList() {
            const user = gameData.currentUser;
            if (!user) return;
            
            if (user.invitedUsers.length === 0) {
                elements.invitedList.innerHTML = '<p>暂无邀请好友</p>';
                return;
            }
            
            elements.invitedList.innerHTML = '';
            user.invitedUsers.forEach(username => {
                if (gameData.users[username]) {
                    const invitedUser = gameData.users[username];
                    const div = document.createElement('div');
                    div.className = 'invited-user';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${username} (等级${invitedUser.level})`;
                    
                    const statusSpan = document.createElement('span');
                    statusSpan.textContent = invitedUser.level >= 5 ? '已达标' : '未达标';
                    statusSpan.style.color = invitedUser.level >= 5 ? '#4cc9f0' : '#f72585';
                    
                    div.appendChild(nameSpan);
                    div.appendChild(statusSpan);
                    elements.invitedList.appendChild(div);
                }
            });
        }

        // 加载提现记录
        function loadWithdrawHistory() {
            const user = gameData.currentUser;
            if (!user) return;
            
            if (user.withdrawHistory.length === 0) {
                elements.withdrawHistory.innerHTML = '<p>暂无提现记录</p>';
                return;
            }
            
            elements.withdrawHistory.innerHTML = '';
            user.withdrawHistory.forEach((wd, index) => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.style.padding = '5px';
                div.style.borderBottom = '1px solid #333';
                
                const method = wd.method === 'alipay' ? '支付宝' : '微信';
                const statusColor = wd.status === 'approved' ? '#4cc9f0' : 
                                  wd.status === 'rejected' ? '#f72585' : '#a8dadc';
                
                div.innerHTML = `
                    <p>${new Date(wd.date).toLocaleString()} - ${method} - ${wd.amount}砖块币</p>
                    <p>手续费: ${wd.fee.toFixed(2)} - 实际到账: ${wd.received.toFixed(2)}</p>
                    <p>状态: <span style="color: ${statusColor}">${
                        wd.status === 'approved' ? '已批准' : 
                        wd.status === 'rejected' ? '已拒绝' : '处理中'
                    }</span></p>
                `;
                
                elements.withdrawHistory.appendChild(div);
            });
        }

        // 加载交易记录
        function loadMarketHistory() {
            const user = gameData.currentUser;
            if (!user) return;
            
            if (user.marketHistory.length === 0) {
                elements.marketHistory.innerHTML = '<p>暂无交易记录</p>';
                return;
            }
            
            elements.marketHistory.innerHTML = '';
            user.marketHistory.forEach((tx, index) => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.style.padding = '5px';
                div.style.borderBottom = '1px solid #333';
                
                div.innerHTML = `
                    <p>${new Date(tx.date).toLocaleString()} - ${tx.type}</p>
                    <p>${tx.details}</p>
                `;
                
                elements.marketHistory.appendChild(div);
            });
        }

        // 开始挖矿计时器
        function startMiningTimer() {
            updateMiningProgress();
            setInterval(updateMiningProgress, 1000);
        }

        // 更新挖矿进度
        function updateMiningProgress() {
            const user = gameData.currentUser;
            if (!user) return;
            
            const now = Date.now();
            const elapsed = (now - user.lastMineTime) / 1000; // 秒
            const hoursElapsed = elapsed / 3600;
            
            // 每小时5个币，最多24小时(120个币)
            const maxCoins = 120;
            const coinsEarned = Math.min(hoursElapsed * 5, maxCoins);
            
            // 更新UI
            const progressPercent = (coinsEarned % 5 / 5) * 100;
            elements.progressBar.style.width = `${progressPercent}%`;
            elements.progressText.textContent = `${(coinsEarned % 5).toFixed(2)}/5 砖块币`;
            
            // 保存已挖矿但未收集的币
            user.minedCoins = coinsEarned;
            saveGameData();
        }

        // 收集砖块币
        function collectCoins() {
            const user = gameData.currentUser;
            if (!user) return;
            
            if (user.minedCoins <= 0) {
                alert('没有可收集的砖块币');
                return;
            }
            
            const coinsToAdd = Math.floor(user.minedCoins);
            user.coins += coinsToAdd;
            user.minedCoins -= coinsToAdd;
            user.lastMineTime = Date.now();
            
            updateUserUI();
            saveGameData();
            
            alert(`成功收集 ${coinsToAdd} 砖块币!`);
        }

        // 切换标签页
        function switchTab(tabId) {
            // 更新按钮状态
            elements.tabBtns.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 更新标签内容
            elements.tabs.forEach(tab => {
                if (tab.id === `${tabId}-tab`) {
                    tab.classList.add('active-tab');
                } else {
                    tab.classList.remove('active-tab');
                }
            });
        }

        // 加载排行榜数据
        function loadRankings(type) {
            let users = [];
            
            // 收集所有用户数据
            for (const username in gameData.users) {
                users.push({
                    username,
                    level: gameData.users[username].level,
                    coins: gameData.users[username].coins,
                    points: gameData.users[username].points,
                    invitedCount: gameData.users[username].invitedUsers.length,
                    invitedLevel5: gameData.users[username].invitedLevel5Users.length
                });
            }
            
            // 根据类型排序
            if (type === 'level') {
                users.sort((a, b) => b.level - a.level || b.coins - a.coins);
                updateRankingTable(elements.levelRankBody, users, 'level');
            } else if (type === 'invite') {
                users.sort((a, b) => b.invitedCount - a.invitedCount || b.invitedLevel5 - a.invitedLevel5);
                updateRankingTable(elements.inviteRankBody, users, 'invite');
            } else if (type === 'points') {
                users.sort((a, b) => b.points - a.points || b.level - a.level);
                updateRankingTable(elements.pointsRankBody, users, 'points');
            }
        }

        // 更新排行榜表格
        function updateRankingTable(tableElement, users, type) {
            tableElement.innerHTML = '';
            
            users.slice(0, 20).forEach((user, index) => {
                const row = document.createElement('tr');
                
                // 排名列
                const rankCell = document.createElement('td');
                if (index === 0) rankCell.className = 'rank-1';
                else if (index === 1) rankCell.className = 'rank-2';
                else if (index === 2) rankCell.className = 'rank-3';
                rankCell.textContent = index + 1;
                
                // 用户名列
                const nameCell = document.createElement('td');
                nameCell.textContent = user.username;
                
                // 根据类型添加其他列
                if (type === 'level') {
                    const levelCell = document.createElement('td');
                    levelCell.textContent = user.level;
                    
                    const coinCell = document.createElement('td');
                    coinCell.textContent = user.coins;
                    
                    row.appendChild(rankCell);
                    row.appendChild(nameCell);
                    row.appendChild(levelCell);
                    row.appendChild(coinCell);
                } else if (type === 'invite') {
                    const inviteCell = document.createElement('td');
                    inviteCell.textContent = user.invitedCount;
                    
                    const level5Cell = document.createElement('td');
                    level5Cell.textContent = user.invitedLevel5;
                    
                    row.appendChild(rankCell);
                    row.appendChild(nameCell);
                    row.appendChild(inviteCell);
                    row.appendChild(level5Cell);
                } else if (type === 'points') {
                    const pointsCell = document.createElement('td');
                    pointsCell.textContent = user.points.toFixed(2);
                    
                    const levelCell = document.createElement('td');
                    levelCell.textContent = user.level;
                    
                    row.appendChild(rankCell);
                    row.appendChild(nameCell);
                    row.appendChild(pointsCell);
                    row.appendChild(levelCell);
                }
                
                tableElement.appendChild(row);
            });
        }

        // 升级等级
        function upgradeLevel() {
            const user = gameData.currentUser;
            if (!user) return;
            
            // 检查是否已达到最高等级
            if (user.level >= 60) {
                alert('您已达到最高等级!');
                return;
            }
            
            // 计算升级所需积分
            let requiredPoints = 0;
            if (user.level < 5) {
                requiredPoints = user.level === 1 ? 0.3 : 0.1;
            } else if (user.level < 20) {
                requiredPoints = 1;
            } else if (user.level < 40) {
                requiredPoints = 3;
            } else if (user.level < 60) {
                requiredPoints = 5;
            }
            
            // 检查积分是否足够
            if (user.points < requiredPoints) {
                alert(`升级需要 ${requiredPoints} 积分，您当前只有 ${user.points.toFixed(2)} 积分`);
                return;
            }
            
            // 升级
            user.level++;
            user.points -= requiredPoints;
            
            // 检查是否有邀请者，如果达到5级，给邀请者奖励
            if (user.level === 5) {
                for (const username in gameData.users) {
                    const inviter = gameData.users[username];
                    if (inviter.invitedUsers.includes(user.username) && !inviter.invitedLevel5Users.includes(user.username)) {
                        inviter.invitedLevel5Users.push(user.username);
                        inviter.coins += 5; // 额外奖励
                        alert(`恭喜您达到5级！您的邀请人 ${inviter.username} 获得了5砖块币奖励`);
                        break;
                    }
                }
            }
            
            // 更新UI
            updateUserUI();
            loadInvitedList();
            saveGameData();
            
            alert(`升级成功! 当前等级: ${user.level}`);
        }

        // 开始小游戏
        function startGame(gameName) {
            const user = gameData.currentUser;
            if (!user) return;
            
            // 检查砖块币是否足够
            let cost = 1;
            if (gameName === 'memory') cost = 2;
            else if (gameName === 'quiz') cost = 3;
            else if (gameName === 'escape') cost = 5; // 大逃杀游戏入场费
            
            // VIP折扣
            if (user.isVIP) cost = Math.floor(cost * 0.5);
            
            if (user.coins < cost) {
                alert(`需要 ${cost} 砖块币才能玩这个游戏`);
                return;
            }
            
            // 扣除砖块币
            user.coins -= cost;
            updateUserUI();
            
            // 设置游戏模态框
            elements.gameModalTitle.textContent = getGameTitle(gameName);
            elements.gameModalContent.innerHTML = getGameHTML(gameName);
            
            // 显示模态框
            elements.gameModal.style.display = 'flex';
            
            // 设置游戏逻辑
            setupGameLogic(gameName);
        }

        // 获取游戏标题
        function getGameTitle(gameName) {
            switch (gameName) {
                case 'clicker': return '点击赚积分';
                case 'memory': return '记忆匹配';
                case 'quiz': return '知识问答';
                case 'escape': return '能量石-大谜杀';
                default: return '小游戏';
            }
        }

        // 获取游戏HTML
        function getGameHTML(gameName) {
            switch (gameName) {
                case 'clicker':
                    return `
                        <div style="text-align: center;">
                            <p>点击按钮赚取积分</p>
                            <button id="clicker-btn" style="font-size: 24px; padding: 20px 40px; margin: 20px 0;">点击我!</button>
                            <p>已获得积分: <span id="clicker-points">0</span></p>
                            <p>每次点击获得 0.01 积分</p>
                        </div>
                    `;
                case 'memory':
                    return `
                        <div style="text-align: center;">
                            <h3>记忆匹配游戏</h3>
                            <p>找出所有匹配的卡片</p>
                            <div id="memory-board" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0;"></div>
                            <p>剩余尝试次数: <span id="memory-attempts">10</span></p>
                            <p>已匹配: <span id="memory-matched">0</span>/8</p>
                        </div>
                    `;
                case 'quiz':
                    return `
                        <div style="text-align: center;">
                            <h3>知识问答</h3>
                            <div id="quiz-question" style="font-size: 18px; margin: 20px 0;"></div>
                            <div id="quiz-options" style="display: flex; flex-direction: column; gap: 10px;"></div>
                            <p>当前得分: <span id="quiz-score">0</span></p>
                        </div>
                    `;
                case 'escape':
                    return `
                        <div style="text-align: center;">
                            <h3>能量石-大谜杀</h3>
                            <p>选择一间房间躲避外星人，满足人数后，外星人随机挑选一个房间杀掉里面所有人，其他房间的幸存者平均瓜分被杀掉房间的能量石。</p>
                            
                            <div class="escape-stats">
                                <div class="escape-stat">
                                    <div>当前玩家</div>
                                    <div id="escape-current-players">0</div>
                                </div>
                                <div class="escape-stat">
                                    <div>目标玩家</div>
                                    <div id="escape-target-players">10</div>
                                </div>
                                <div class="escape-stat">
                                    <div>奖池</div>
                                    <div id="escape-prize-pool">0</div>
                                </div>
                                <div class="escape-stat">
                                    <div>倒计时</div>
                                    <div id="escape-countdown">20</div>
                                </div>
                            </div>
                            
                            <h4>选择房间躲避外星人</h4>
                            <div class="escape-room" id="escape-rooms">
                                ${gameData.escapeRooms.rooms.map(room => `
                                    <div class="room-card" data-room="${room}">
                                        ${room}
                                        <div class="escape-players" id="room-players-${room}">0人</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="form-group">
                                <label for="escape-bet">投入能量石数量 (1-100)</label>
                                <input type="number" id="escape-bet" min="1" max="100" value="10">
                            </div>
                            
                            <button id="escape-join-btn" class="escape-button">加入游戏</button>
                            <button id="escape-leave-btn" class="escape-button" style="display: none;">离开房间</button>
                            
                            <div id="escape-game-status" style="margin-top: 20px;"></div>
                        </div>
                    `;
                default:
                    return '<p>游戏加载中...</p>';
            }
        }

        // 设置游戏逻辑
        function setupGameLogic(gameName) {
            switch (gameName) {
                case 'clicker':
                    setupClickerGame();
                    break;
                case 'memory':
                    setupMemoryGame();
                    break;
                case 'quiz':
                    setupQuizGame();
                    break;
                case 'escape':
                    setupEscapeGame();
                    break;
            }
        }

        // 设置点击游戏
        function setupClickerGame() {
            let pointsEarned = 0;
            const clickerBtn = document.getElementById('clicker-btn');
            const pointsDisplay = document.getElementById('clicker-points');
            
            clickerBtn.addEventListener('click', () => {
                pointsEarned += 0.01;
                pointsDisplay.textContent = pointsEarned.toFixed(2);
                
                // 随机按钮移动
                if (Math.random() < 0.2) {
                    const x = Math.random() * 100 - 50;
                    const y = Math.random() * 100 - 50;
                    clickerBtn.style.transform = `translate(${x}px, ${y}px)`;
                }
            });
            
            // 游戏结束处理
            elements.gameModal.querySelector('.close-btn').addEventListener('click', () => {
                if (pointsEarned > 0) {
                    gameData.currentUser.points += pointsEarned;
                    
                    // 添加交易记录
                    gameData.currentUser.marketHistory.push({
                        type: '游戏奖励',
                        details: `从点击游戏获得 ${pointsEarned.toFixed(2)} 积分`,
                        date: new Date().toISOString()
                    });
                    
                    updateUserUI();
                    loadMarketHistory();
                    saveGameData();
                    alert(`游戏结束! 获得 ${pointsEarned.toFixed(2)} 积分`);
                }
            });
        }

        // 设置记忆游戏
        function setupMemoryGame() {
            const cards = ['A', 'A', 'B', 'B', 'C', 'C', 'D', 'D', 'E', 'E', 'F', 'F', 'G', 'G', 'H', 'H'];
            let shuffledCards = shuffleArray([...cards]).slice(0, 8 * 2);
            let flippedCards = [];
            let matchedPairs = 0;
            let attempts = 10;
            
            const board = document.getElementById('memory-board');
            const attemptsDisplay = document.getElementById('memory-attempts');
            const matchedDisplay = document.getElementById('memory-matched');
            
            // 创建卡片
            shuffledCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'memory-card';
                cardElement.dataset.index = index;
                cardElement.dataset.value = card;
                cardElement.style.height = '80px';
                cardElement.style.backgroundColor = '#457b9d';
                cardElement.style.display = 'flex';
                cardElement.style.justifyContent = 'center';
                cardElement.style.alignItems = 'center';
                cardElement.style.cursor = 'pointer';
                cardElement.style.color = 'transparent';
                cardElement.style.fontSize = '24px';
                cardElement.style.borderRadius = '5px';
                
                cardElement.textContent = card;
                
                cardElement.addEventListener('click', () => {
                    if (flippedCards.length < 2 && !flippedCards.includes(index) && cardElement.style.color === 'transparent') {
                        flipCard(cardElement);
                    }
                });
                
                board.appendChild(cardElement);
            });
            
            // 翻牌函数
            function flipCard(cardElement) {
                cardElement.style.color = 'white';
                flippedCards.push(parseInt(cardElement.dataset.index));
                
                if (flippedCards.length === 2) {
                    const firstCard = board.children[flippedCards[0]];
                    const secondCard = board.children[flippedCards[1]];
                    
                    if (firstCard.dataset.value === secondCard.dataset.value) {
                        // 匹配成功
                        matchedPairs++;
                        matchedDisplay.textContent = matchedPairs;
                        
                        // 标记为已匹配
                        firstCard.style.backgroundColor = '#2a9d8f';
                        secondCard.style.backgroundColor = '#2a9d8f';
                        
                        flippedCards = [];
                        
                        // 检查是否所有卡片都匹配
                        if (matchedPairs === 8) {
                            setTimeout(() => {
                                gameData.currentUser.points += 1;
                                
                                // 添加交易记录
                                gameData.currentUser.marketHistory.push({
                                    type: '游戏奖励',
                                    details: '从记忆游戏获得 1 积分',
                                    date: new Date().toISOString()
                                });
                                
                                updateUserUI();
                                loadMarketHistory();
                                saveGameData();
                                alert('恭喜! 你完成了记忆游戏，获得1积分!');
                                elements.gameModal.style.display = 'none';
                            }, 500);
                        }
                    } else {
                        // 匹配失败
                        attempts--;
                        attemptsDisplay.textContent = attempts;
                        
                        setTimeout(() => {
                            firstCard.style.color = 'transparent';
                            secondCard.style.color = 'transparent';
                            flippedCards = [];
                        }, 1000);
                        
                        // 检查是否还有尝试次数
                        if (attempts <= 0) {
                            setTimeout(() => {
                                if (matchedPairs > 0) {
                                    const pointsEarned = matchedPairs * 0.1;
                                    gameData.currentUser.points += pointsEarned;
                                    
                                    // 添加交易记录
                                    gameData.currentUser.marketHistory.push({
                                        type: '游戏奖励',
                                        details: `从记忆游戏获得 ${pointsEarned.toFixed(1)} 积分`,
                                        date: new Date().toISOString()
                                    });
                                    
                                    updateUserUI();
                                    loadMarketHistory();
                                    saveGameData();
                                    alert(`游戏结束! 你匹配了 ${matchedPairs} 对卡片，获得 ${pointsEarned.toFixed(1)} 积分`);
                                } else {
                                    alert('游戏结束! 没有匹配到任何卡片');
                                }
                                elements.gameModal.style.display = 'none';
                            }, 1000);
                        }
                    }
                }
            }
        }

        // 设置问答游戏
        function setupQuizGame() {
            const questions = [
                {
                    question: "中国的首都是哪里?",
                    options: ["上海", "北京", "广州", "深圳"],
                    answer: 1
                },
                {
                    question: "以下哪个不是编程语言?",
                    options: ["Python", "Java", "HTML", "C++"],
                    answer: 2
                },
                {
                    question: "1 + 1等于多少?",
                    options: ["1", "2", "3", "4"],
                    answer: 1
                }
            ];
            
            let currentQuestion = 0;
            let score = 0;
            
            const questionElement = document.getElementById('quiz-question');
            const optionsElement = document.getElementById('quiz-options');
            const scoreDisplay = document.getElementById('quiz-score');
            
            function showQuestion() {
                if (currentQuestion >= questions.length) {
                    // 游戏结束
                    const pointsEarned = score * 0.2;
                    gameData.currentUser.points += pointsEarned;
                    
                    // 添加交易记录
                    gameData.currentUser.marketHistory.push({
                        type: '游戏奖励',
                        details: `从知识问答获得 ${pointsEarned.toFixed(1)} 积分`,
                        date: new Date().toISOString()
                    });
                    
                    updateUserUI();
                    loadMarketHistory();
                    saveGameData();
                    alert(`游戏结束! 你的得分是 ${score}，获得 ${pointsEarned.toFixed(1)} 积分`);
                    elements.gameModal.style.display = 'none';
                    return;
                }
                
                const q = questions[currentQuestion];
                questionElement.textContent = q.question;
                optionsElement.innerHTML = '';
                
                q.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.style.padding = '10px';
                    button.addEventListener('click', () => {
                        checkAnswer(index);
                    });
                    optionsElement.appendChild(button);
                });
            }
            
            function checkAnswer(selectedIndex) {
                const q = questions[currentQuestion];
                if (selectedIndex === q.answer) {
                    score++;
                    scoreDisplay.textContent = score;
                    alert('回答正确!');
                } else {
                    alert(`回答错误! 正确答案是: ${q.options[q.answer]}`);
                }
                
                currentQuestion++;
                showQuestion();
            }
            
            showQuestion();
        }

        // 设置大逃杀游戏
        function setupEscapeGame() {
            const user = gameData.currentUser;
            const roomsContainer = document.getElementById('escape-rooms');
            const joinBtn = document.getElementById('escape-join-btn');
            const leaveBtn = document.getElementById('escape-leave-btn');
            const betInput = document.getElementById('escape-bet');
            const gameStatus = document.getElementById('escape-game-status');
            const currentPlayersDisplay = document.getElementById('escape-current-players');
            const targetPlayersDisplay = document.getElementById('escape-target-players');
            const prizePoolDisplay = document.getElementById('escape-prize-pool');
            const countdownDisplay = document.getElementById('escape-countdown');
            
            let selectedRoom = null;
            let currentBet = 10;
            let gameInterval = null;
            
            // 初始化游戏状态
            updateEscapeGameDisplay();
            
            // 房间选择
            roomsContainer.querySelectorAll('.room-card').forEach(card => {
                card.addEventListener('click', () => {
                    if (gameData.escapeRooms.gameInProgress) return;
                    
                    roomsContainer.querySelectorAll('.room-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    card.classList.add('selected');
                    selectedRoom = card.getAttribute('data-room');
                });
            });
            
            // 加入游戏
            joinBtn.addEventListener('click', () => {
                if (!selectedRoom) {
                    alert('请先选择一个房间');
                    return;
                }
                
                currentBet = parseInt(betInput.value);
                if (isNaN(currentBet) || currentBet < 1 || currentBet > 100) {
                    alert('请输入1-100之间的有效数字');
                    return;
                }
                
                if (user.coins < currentBet) {
                    alert('砖块币不足');
                    return;
                }
                
                // 扣除砖块币
                user.coins -= currentBet;
                updateUserUI();
                
                // 加入房间
                if (!gameData.escapeRooms.players[selectedRoom]) {
                    gameData.escapeRooms.players[selectedRoom] = [];
                }
                
                gameData.escapeRooms.players[selectedRoom].push({
                    username: user.username,
                    bet: currentBet,
                    isBot: false
                });
                
                // 更新UI
                joinBtn.style.display = 'none';
                leaveBtn.style.display = 'block';
                betInput.disabled = true;
                gameStatus.textContent = `你已加入 ${selectedRoom}，投入 ${currentBet} 能量石`;
                
                // 添加机器人
                addBots();
                
                // 开始游戏检查
                checkEscapeGameStart();
                
                saveGameData();
            });
            
            // 离开游戏
            leaveBtn.addEventListener('click', () => {
                if (gameData.escapeRooms.gameInProgress) {
                    alert('游戏已开始，无法离开');
                    return;
                }
                
                // 返还砖块币
                user.coins += currentBet;
                updateUserUI();
                
                // 从房间移除
                if (gameData.escapeRooms.players[selectedRoom]) {
                    gameData.escapeRooms.players[selectedRoom] = gameData.escapeRooms.players[selectedRoom].filter(
                        p => p.username !== user.username
                    );
                    
                    if (gameData.escapeRooms.players[selectedRoom].length === 0) {
                        delete gameData.escapeRooms.players[selectedRoom];
                    }
                }
                
                // 清除机器人
                gameData.escapeRooms.bots = [];
                
                // 更新UI
                joinBtn.style.display = 'block';
                leaveBtn.style.display = 'none';
                betInput.disabled = false;
                gameStatus.textContent = '你已离开房间';
                selectedRoom = null;
                
                roomsContainer.querySelectorAll('.room-card').forEach(c => {
                    c.classList.remove('selected');
                });
                
                // 清除倒计时
                clearInterval(gameData.escapeRooms.countdownInterval);
                gameData.escapeRooms.countdown = 0;
                countdownDisplay.textContent = '20';
                
                saveGameData();
                updateEscapeGameDisplay();
            });
            
            // 关闭模态框时离开游戏
            elements.gameModal.querySelector('.close-btn').addEventListener('click', () => {
                if (selectedRoom && !gameData.escapeRooms.gameInProgress) {
                    // 模拟点击离开按钮
                    leaveBtn.click();
                }
            });
            
            // 添加机器人
            function addBots() {
                const botCount = Math.floor(Math.random() * 5) + 3; // 3-7个机器人
                gameData.escapeRooms.bots = [];
                
                for (let i = 0; i < botCount; i++) {
                    const botRoom = gameData.escapeRooms.rooms[Math.floor(Math.random() * gameData.escapeRooms.rooms.length)];
                    const botBet = Math.floor(Math.random() * 591) + 10; // 10-600随机投注
                    
                    if (!gameData.escapeRooms.players[botRoom]) {
                        gameData.escapeRooms.players[botRoom] = [];
                    }
                    
                    gameData.escapeRooms.players[botRoom].push({
                        username: `机器人${i+1}`,
                        bet: botBet,
                        isBot: true
                    });
                    
                    gameData.escapeRooms.bots.push({
                        room: botRoom,
                        bet: botBet
                    });
                }
                
                updateEscapeGameDisplay();
            }
            
            // 更新游戏显示
            function updateEscapeGameDisplay() {
                // 更新玩家数量
                let totalPlayers = 0;
                let totalPrize = 0;
                
                gameData.escapeRooms.rooms.forEach(room => {
                    const players = gameData.escapeRooms.players[room] || [];
                    const roomPlayersElement = document.getElementById(`room-players-${room}`);
                    if (roomPlayersElement) {
                        const botCount = players.filter(p => p.isBot).length;
                        const humanCount = players.filter(p => !p.isBot).length;
                        
                        let text = '';
                        if (humanCount > 0) text += `${humanCount}人`;
                        if (botCount > 0) {
                            if (humanCount > 0) text += ' + ';
                            text += `${botCount}机器人`;
                        }
                        if (humanCount === 0 && botCount === 0) text = '0人';
                        
                        roomPlayersElement.innerHTML = text;
                    }
                    
                    totalPlayers += players.length;
                    players.forEach(player => {
                        totalPrize += player.bet;
                    });
                });
                
                currentPlayersDisplay.textContent = totalPlayers;
                prizePoolDisplay.textContent = totalPrize;
                
                // 设置目标玩家数量
                const targetPlayers = Math.max(5, Math.ceil(totalPlayers * 1.2));
                targetPlayersDisplay.textContent = targetPlayers;
            }
            
            // 检查游戏是否可以开始
            function checkEscapeGameStart() {
                updateEscapeGameDisplay();
                
                const totalPlayers = parseInt(currentPlayersDisplay.textContent);
                const targetPlayers = parseInt(targetPlayersDisplay.textContent);
                
                if (totalPlayers >= targetPlayers && !gameData.escapeRooms.gameInProgress) {
                    startEscapeCountdown();
                } else if (!gameData.escapeRooms.gameInProgress) {
                    // 每隔5秒检查一次
                    clearInterval(gameInterval);
                    gameInterval = setInterval(checkEscapeGameStart, 5000);
                }
            }
            
            // 开始倒计时
            function startEscapeCountdown() {
                gameData.escapeRooms.countdown = 20;
                countdownDisplay.textContent = gameData.escapeRooms.countdown;
                
                clearInterval(gameData.escapeRooms.countdownInterval);
                gameData.escapeRooms.countdownInterval = setInterval(() => {
                    gameData.escapeRooms.countdown--;
                    countdownDisplay.textContent = gameData.escapeRooms.countdown;
                    
                    if (gameData.escapeRooms.countdown <= 0) {
                        clearInterval(gameData.escapeRooms.countdownInterval);
                        startEscapeGame();
                    }
                }, 1000);
                
                gameStatus.innerHTML = '<p>游戏即将开始，倒计时20秒...</p>';
            }
            
            // 开始游戏
            function startEscapeGame() {
                gameData.escapeRooms.gameInProgress = true;
                clearInterval(gameInterval);
                
                gameStatus.innerHTML = '<p>游戏开始! 外星人正在选择目标房间...</p>';
                
                // 模拟3秒等待
                setTimeout(() => {
                    // 随机选择一个房间作为目标
                    const occupiedRooms = Object.keys(gameData.escapeRooms.players).filter(
                        room => gameData.escapeRooms.players[room].length > 0
                    );
                    
                    if (occupiedRooms.length === 0) {
                        gameStatus.innerHTML = '<p>错误: 没有玩家在房间中</p>';
                        gameData.escapeRooms.gameInProgress = false;
                        return;
                    }
                    
                    const targetRoom = occupiedRooms[Math.floor(Math.random() * occupiedRooms.length)];
                    const killedPlayers = gameData.escapeRooms.players[targetRoom];
                    const totalKilledBet = killedPlayers.reduce((sum, player) => sum + player.bet, 0);
                    
                    // 计算幸存者和奖励
                    const survivors = {};
                    let totalSurvivors = 0;
                    
                    occupiedRooms.forEach(room => {
                        if (room !== targetRoom) {
                            survivors[room] = gameData.escapeRooms.players[room];
                            totalSurvivors += survivors[room].length;
                        }
                    });
                    
                    // 计算每个幸存者获得的奖励 (扣除5%手续费)
                    const rewardPerSurvivor = totalSurvivors > 0 ? 
                        Math.floor(totalKilledBet * 0.95 / totalSurvivors) : 0;
                    
                    // 更新玩家状态
                    let userReward = 0;
                    let userKilled = false;
                    
                    if (selectedRoom === targetRoom) {
                        // 玩家被杀
                        userKilled = true;
                        gameStatus.innerHTML += `<p>外星人选择了 ${targetRoom}! 你被杀死了!</p>`;
                    } else if (survivors[selectedRoom]) {
                        // 玩家幸存
                        userReward = rewardPerSurvivor;
                        user.energyStones += userReward;
                        
                        // 添加交易记录
                        user.marketHistory.push({
                            type: '游戏奖励',
                            details: `从大逃杀游戏获得 ${userReward} 能量石`,
                            date: new Date().toISOString()
                        });
                        
                        gameStatus.innerHTML += `<p>外星人选择了 ${targetRoom}! 你幸存下来并获得 ${userReward} 能量石!</p>`;
                    }
                    
                    // 显示被杀房间和奖励详情
                    const killedNames = killedPlayers.map(p => 
                        p.isBot ? `${p.username}<span class="bot-tag">机器人</span>` : p.username
                    ).join(', ');
                    
                    gameStatus.innerHTML += `
                        <p>被杀房间: ${targetRoom} (${killedNames})</p>
                        <p>被杀房间总能量石: ${totalKilledBet}</p>
                        <p>幸存者每人获得: ${rewardPerSurvivor} 能量石</p>
                    `;
                    
                    // 更新UI
                    updateUserUI();
                    loadMarketHistory();
                    
                    // 重置游戏状态
                    setTimeout(() => {
                        gameData.escapeRooms.players = {};
                        gameData.escapeRooms.bots = [];
                        gameData.escapeRooms.gameInProgress = false;
                        gameData.escapeRooms.countdown = 0;
                        
                        if (selectedRoom) {
                            // 重置玩家状态
                            joinBtn.style.display = 'block';
                            leaveBtn.style.display = 'none';
                            betInput.disabled = false;
                            selectedRoom = null;
                            
                            roomsContainer.querySelectorAll('.room-card').forEach(c => {
                                c.classList.remove('selected');
                            });
                        }
                        
                        updateEscapeGameDisplay();
                        countdownDisplay.textContent = '20';
                        gameStatus.innerHTML += '<p>游戏结束! 可以开始新一局游戏</p>';
                    }, 5000);
                    
                    saveGameData();
                }, 3000);
            }
        }

        // 复制邀请链接
        function copyInviteLink() {
            const user = gameData.currentUser;
            if (!user) return;
            
            const inviteLink = `${window.location.origin}${window.location.pathname}?invite=${user.inviteCode}`;
            
            navigator.clipboard.writeText(inviteLink).then(() => {
                alert('邀请链接已复制到剪贴板!');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制邀请码');
            });
        }

        // 申请VIP
        function applyForVIP() {
            const user = gameData.currentUser;
            if (!user) return;
            
            if (user.isVIP) {
                alert('您已经是VIP会员!');
                return;
            }
            
            if (user.vipRequested) {
                alert('您已经提交过VIP申请，请等待管理员处理');
                return;
            }
            
            if (confirm(`确定要申请VIP会员吗? 费用为${gameData.vipPrice}元`)) {
                user.vipRequested = true;
                gameData.vipRequests.push({
                    username: user.username,
                    date: new Date().toISOString(),
                    status: 'pending'
                });
                
                saveGameData();
                alert('VIP申请已提交，请支付并等待管理员审核');
            }
        }

        // 提交提现申请
        function submitWithdrawRequest() {
            const user = gameData.currentUser;
            if (!user) return;
            
            const amount = parseFloat(elements.withdrawAmount.value);
            const method = elements.withdrawMethod.value;
            const account = elements.withdrawAccount.value.trim();
            
            if (isNaN(amount)) {
                alert('请输入有效的提现金额');
                return;
            }
            
            // 检查最低提现金额
            if (amount < 100) {
                alert('最低提现金额为100砖块币');
                return;
            }
            
            // 检查是否有足够的砖块币
            if (amount > user.coins) {
                alert('砖块币不足');
                return;
            }
            
            if (!account) {
                alert('请输入收款账号');
                return;
            }
            
            // 计算手续费
            const feeRate = user.isVIP ? gameData.vipWithdrawFee / 100 : gameData.withdrawFee / 100;
            const fee = amount * feeRate;
            const received = amount - fee;
            
            if (confirm(`确定要提现 ${amount} 砖块币吗?\n手续费: ${fee.toFixed(2)} (${feeRate * 100}%)\n实际到账: ${received.toFixed(2)}`)) {
                // 扣除砖块币
                user.coins -= amount;
                
                // 添加提现记录
                user.withdrawHistory.push({
                    amount,
                    fee,
                    received,
                    method,
                    account,
                    date: new Date().toISOString(),
                    status: 'pending'
                });
                
                // 添加到管理员队列
                gameData.withdrawRequests.push({
                    username: user.username,
                    amount,
                    method,
                    account,
                    date: new Date().toISOString(),
                    status: 'pending'
                });
                
                // 更新UI
                updateUserUI();
                loadWithdrawHistory();
                saveGameData();
                
                alert('提现申请已提交，将在24小时内处理');
                elements.withdrawAmount.value = '';
                elements.withdrawAccount.value = '';
            }
        }

        // 兑换砖块币为积分
        function exchangeCoinToPoint() {
            const user = gameData.currentUser;
            if (!user) return;
            
            const coins = parseInt(elements.coinToPoint.value);
            
            if (isNaN(coins) || coins < 1) {
                alert('请输入有效的砖块币数量');
                return;
            }
            
            if (user.coins < coins) {
                alert('砖块币不足');
                return;
            }
            
            const points = coins * 0.5;
            
            if (confirm(`确定要将 ${coins} 砖块币兑换为 ${points} 积分吗?`)) {
                user.coins -= coins;
                user.points += points;
                
                // 添加交易记录
                user.marketHistory.push({
                    type: '兑换积分',
                    details: `${coins} 砖块币兑换为 ${points} 积分`,
                    date: new Date().toISOString()
                });
                
                updateUserUI();
                loadMarketHistory();
                saveGameData();
                
                alert(`兑换成功! 获得 ${points} 积分`);
            }
        }

        // 兑换能量石为砖块币
        function exchangeStoneToCoin() {
            const user = gameData.currentUser;
            if (!user) return;
            
            const stones = parseInt(elements.stoneToCoin.value);
            
            if (isNaN(stones) || stones < 1) {
                alert('请输入有效的能量石数量');
                return;
            }
            
            if (user.energyStones < stones) {
                alert('能量石不足');
                return;
            }
            
            const coins = stones;
            
            if (confirm(`确定要将 ${stones} 能量石兑换为 ${coins} 砖块币吗?`)) {
                user.energyStones -= stones;
                user.coins += coins;
                
                // 添加交易记录
                user.marketHistory.push({
                    type: '兑换砖块币',
                    details: `${stones} 能量石兑换为 ${coins} 砖块币`,
                    date: new Date().toISOString()
                });
                
                updateUserUI();
                loadMarketHistory();
                saveGameData();
                
                alert(`兑换成功! 获得 ${coins} 砖块币`);
            }
        }

        // 加载管理员数据
        function loadAdminData() {
            // 加载VIP申请
            elements.vipRequests.innerHTML = '';
            gameData.vipRequests.forEach(request => {
                if (request.status === 'pending') {
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    li.innerHTML = `
                        <span>${request.username} - ${new Date(request.date).toLocaleString()}</span>
                        <div>
                            <button class="approve-vip" data-user="${request.username}">批准</button>
                            <button class="reject-vip" data-user="${request.username}">拒绝</button>
                        </div>
                    `;
                    elements.vipRequests.appendChild(li);
                }
            });
            
            // 加载提现申请
            elements.withdrawRequests.innerHTML = '';
            gameData.withdrawRequests.forEach(request => {
                if (request.status === 'pending') {
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    li.innerHTML = `
                        <span>${request.username} - ${request.amount}砖块币 (${request.method})</span>
                        <div>
                            <button class="approve-withdraw" data-user="${request.username}" data-amount="${request.amount}">批准</button>
                            <button class="reject-withdraw" data-user="${request.username}" data-amount="${request.amount}">拒绝</button>
                        </div>
                    `;
                    elements.withdrawRequests.appendChild(li);
                }
            });
            
            // 加载用户列表
            searchUsers();
            
            // 添加按钮事件
            document.querySelectorAll('.approve-vip').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    approveVIP(username);
                });
            });
            
            document.querySelectorAll('.reject-vip').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    rejectVIP(username);
                });
            });
            
            document.querySelectorAll('.approve-withdraw').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    const amount = parseFloat(e.target.getAttribute('data-amount'));
                    approveWithdraw(username, amount);
                });
            });
            
            document.querySelectorAll('.reject-withdraw').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    const amount = parseFloat(e.target.getAttribute('data-amount'));
                    rejectWithdraw(username, amount);
                });
            });
        }

        // 搜索用户
        function searchUsers() {
            const searchTerm = elements.searchUser.value.toLowerCase();
            elements.userList.innerHTML = '';
            
            for (const username in gameData.users) {
                if (username.toLowerCase().includes(searchTerm)) {
                    const user = gameData.users[username];
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    li.innerHTML = `
                        <span>${username} - 等级${user.level} - ${user.isVIP ? 'VIP' : '普通用户'}</span>
                        <div>
                            <button class="add-vip" data-user="${username}">${user.isVIP ? '取消VIP' : '设为VIP'}</button>
                            <button class="add-coins" data-user="${username}">加砖块�</button>
                            <button class="ban-user" data-user="${username}">${user.banned ? '解封' : '封禁'}</button>
                        </div>
                    `;
                    elements.userList.appendChild(li);
                }
            }
            
            // 添加按钮事件
            document.querySelectorAll('.add-vip').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    toggleVIP(username);
                });
            });
            
            document.querySelectorAll('.add-coins').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    const amount = prompt(`为 ${username} 添加多少砖块币?`, "10");
                    if (amount && !isNaN(parseInt(amount))) {
                        addCoins(username, parseInt(amount));
                    }
                });
            });
            
            document.querySelectorAll('.ban-user').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    toggleBanUser(username);
                });
            });
        }

        // 批准VIP
        function approveVIP(username) {
            if (gameData.users[username]) {
                gameData.users[username].isVIP = true;
                gameData.users[username].vipRequested = false;
                
                // 更新申请状态
                gameData.vipRequests = gameData.vipRequests.map(req => {
                    if (req.username === username && req.status === 'pending') {
                        return { ...req, status: 'approved' };
                    }
                    return req;
                });
                
                saveGameData();
                loadAdminData();
                alert(`已批准 ${username} 的VIP申请`);
            }
        }

        // 拒绝VIP
        function rejectVIP(username) {
            if (gameData.users[username]) {
                gameData.users[username].vipRequested = false;
                
                // 更新申请状态
                gameData.vipRequests = gameData.vipRequests.map(req => {
                    if (req.username === username && req.status === 'pending') {
                        return { ...req, status: 'rejected' };
                    }
                    return req;
                });
                
                saveGameData();
                loadAdminData();
                alert(`已拒绝 ${username} 的VIP申请`);
            }
        }

        // 批准提现
        function approveWithdraw(username, amount) {
            if (gameData.users[username]) {
                // 更新用户提现记录
                gameData.users[username].withdrawHistory = gameData.users[username].withdrawHistory.map(wd => {
                    if (wd.status === 'pending' && wd.amount === amount) {
                        return { ...wd, status: 'approved' };
                    }
                    return wd;
                });
                
                // 更新提现申请状态
                gameData.withdrawRequests = gameData.withdrawRequests.map(req => {
                    if (req.username === username && req.amount === amount && req.status === 'pending') {
                        return { ...req, status: 'approved' };
                    }
                    return req;
                });
                
                saveGameData();
                loadAdminData();
                alert(`已批准 ${username} 的 ${amount} 砖块币提现申请`);
            }
        }

        // 拒绝提现
        function rejectWithdraw(username, amount) {
            if (gameData.users[username]) {
                // 返还砖块币
                gameData.users[username].coins += amount;
                
                // 更新用户提现记录
                gameData.users[username].withdrawHistory = gameData.users[username].withdrawHistory.map(wd => {
                    if (wd.status === 'pending' && wd.amount === amount) {
                        return { ...wd, status: 'rejected' };
                    }
                    return wd;
                });
                
                // 更新提现申请状态
                gameData.withdrawRequests = gameData.withdrawRequests.map(req => {
                    if (req.username === username && req.amount === amount && req.status === 'pending') {
                        return { ...req, status: 'rejected' };
                    }
                    return req;
                });
                
                saveGameData();
                loadAdminData();
                alert(`已拒绝 ${username} 的 ${amount} 砖块币提现申请，砖块币已返还`);
            }
        }

        // 切换VIP状态
        function toggleVIP(username) {
            if (gameData.users[username]) {
                gameData.users[username].isVIP = !gameData.users[username].isVIP;
                gameData.users[username].vipRequested = false;
                
                // 如果是批准VIP，从申请列表中移除
                gameData.vipRequests = gameData.vipRequests.filter(req => 
                    !(req.username === username && req.status === 'pending')
                );
                
                saveGameData();
                searchUsers();
                alert(`${username} 的VIP状态已更新`);
            }
        }

        // 切换用户封禁状态
        function toggleBanUser(username) {
            if (gameData.users[username]) {
                gameData.users[username].banned = !gameData.users[username].banned;
                
                saveGameData();
                searchUsers();
                alert(`${username} 的封禁状态已更新`);
            }
        }

        // 添加砖块币
        function addCoins(username, amount) {
            if (gameData.users[username] && amount > 0) {
                gameData.users[username].coins += amount;
                
                // 添加交易记录
                gameData.users[username].marketHistory.push({
                    type: '管理员添加',
                    details: `管理员添加了 ${amount} 砖块币`,
                    date: new Date().toISOString()
                });
                
                saveGameData();
                searchUsers();
                alert(`已为 ${username} 添加 ${amount} 砖块币`);
            }
        }

        // 保存管理员设置
        function saveAdminSettings() {
            gameData.vipPrice = parseInt(elements.vipPriceInput.value) || 32;
            gameData.withdrawFee = parseInt(elements.withdrawFeeInput.value) || 10;
            gameData.vipWithdrawFee = parseInt(elements.vipFeeInput.value) || 5;
            
            saveGameData();
            alert('系统设置已保存');
        }

        // 更新支付二维码
        function updatePaymentQR() {
            const alipayQR = elements.alipayQrInput.value.trim();
            const wechatQR = elements.wechatQrInput.value.trim();
            
            if (alipayQR) {
                gameData.paymentQR.alipay = alipayQR;
                elements.alipayQr.src = alipayQR;
            }
            
            if (wechatQR) {
                gameData.paymentQR.wechat = wechatQR;
                elements.wechatQr.src = wechatQR;
            }
            
            saveGameData();
            alert('支付二维码已更新');
        }

        // 保存公告
        function saveAnnouncement() {
            const newAnnouncements = elements.announcementEdit.value.split('\n').filter(line => line.trim());
            gameData.announcements = newAnnouncements;
            
            saveGameData();
            alert('公告已保存');
        }

        // 保存游戏数据
        function saveGameData() {
            localStorage.setItem('pmGameData', JSON.stringify(gameData));
        }

        // 辅助函数: 打乱数组
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 初始化游戏
        window.onload = initGame;
    </script>
</body>
</html>
