<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信克隆版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 420px;
            height: 800px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #07C160;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            position: relative;
        }
        
        .header .back-btn {
            position: absolute;
            left: 15px;
            top: 15px;
            cursor: pointer;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .footer {
            display: flex;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }
        
        .footer-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }
        
        .footer-btn.active {
            color: #07C160;
        }
        
        /* 登录/注册页面样式 */
        .auth-form {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background-color: #07C160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-secondary {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .switch-auth {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .switch-auth span {
            color: #07C160;
            cursor: pointer;
        }
        
        /* 首页样式 */
        .chat-list {
            list-style: none;
        }
        
        .chat-item {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .chat-item:hover {
            background-color: #f9f9f9;
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            margin-right: 10px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .chat-name {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .chat-last-msg {
            font-size: 14px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            font-size: 12px;
            color: #999;
        }
        
        /* 聊天页面样式 */
        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 10px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .chat-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-header-name {
            font-size: 16px;
            font-weight: bold;
        }
        
        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message.received {
            align-items: flex-start;
        }
        
        .message.sent {
            align-items: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }
        
        .message.received .message-content {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .message.sent .message-content {
            background-color: #95EC69;
            color: #333;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .chat-input button {
            margin-left: 10px;
            padding: 10px 15px;
            background-color: #07C160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* 通讯录页面样式 */
        .contact-list {
            list-style: none;
        }
        
        .contact-item {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 10px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .contact-name {
            font-size: 16px;
            line-height: 40px;
        }
        
        /* 发现页面样式 */
        .discover-list {
            list-style: none;
        }
        
        .discover-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .discover-item:hover {
            background-color: #f9f9f9;
        }
        
        .discover-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            color: #07C160;
        }
        
        .discover-name {
            font-size: 16px;
            flex: 1;
        }
        
        .discover-arrow {
            width: 12px;
            height: 12px;
            border-top: 2px solid #999;
            border-right: 2px solid #999;
            transform: rotate(45deg);
        }
        
        /* 我页面样式 */
        .profile-header {
            display: flex;
            padding: 20px;
            background-color: #f9f9f9;
            align-items: center;
        }
        
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .profile-id {
            font-size: 14px;
            color: #999;
        }
        
        .profile-qrcode {
            width: 24px;
            height: 24px;
            color: #999;
        }
        
        .profile-list {
            list-style: none;
            margin-top: 10px;
        }
        
        .profile-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .profile-item:hover {
            background-color: #f9f9f9;
        }
        
        .profile-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            color: #07C160;
        }
        
        .profile-item-name {
            font-size: 16px;
            flex: 1;
        }
        
        .profile-arrow {
            width: 12px;
            height: 12px;
            border-top: 2px solid #999;
            border-right: 2px solid #999;
            transform: rotate(45deg);
        }
        
        /* 添加好友页面样式 */
        .search-bar {
            padding: 10px;
            background-color: #f9f9f9;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-results {
            list-style: none;
        }
        
        .search-result-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        
        .search-result-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .search-result-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .search-result-info {
            flex: 1;
        }
        
        .search-result-name {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .search-result-id {
            font-size: 14px;
            color: #999;
        }
        
        .search-result-btn {
            padding: 5px 10px;
            background-color: #07C160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* 好友请求页面样式 */
        .request-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .request-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .request-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .request-info {
            flex: 1;
        }
        
        .request-name {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .request-message {
            font-size: 14px;
            color: #999;
            margin-bottom: 10px;
        }
        
        .request-actions {
            display: flex;
        }
        
        .request-btn {
            padding: 5px 10px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .request-btn.accept {
            background-color: #07C160;
            color: white;
            border-color: #07C160;
        }
        
        .request-btn.reject {
            background-color: #f5f5f5;
            color: #666;
        }
        
        /* 设置页面样式 */
        .settings-list {
            list-style: none;
        }
        
        .settings-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .settings-item:hover {
            background-color: #f9f9f9;
        }
        
        .settings-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            color: #07C160;
        }
        
        .settings-item-name {
            font-size: 16px;
            flex: 1;
        }
        
        .settings-arrow {
            width: 12px;
            height: 12px;
            border-top: 2px solid #999;
            border-right: 2px solid #999;
            transform: rotate(45deg);
        }
        
        /* 修改密码页面样式 */
        .password-form {
            padding: 20px;
        }
        
        /* 修改头像页面样式 */
        .avatar-form {
            padding: 20px;
            text-align: center;
        }
        
        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 20px auto;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-upload {
            margin-top: 20px;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            display: flex;
            border-top: 1px solid #eee;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
        }
        
        .modal-btn.cancel {
            color: #666;
            border-right: 1px solid #eee;
        }
        
        .modal-btn.confirm {
            color: #07C160;
            font-weight: bold;
        }
        
        /* 响应式调整 */
        @media (max-width: 480px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 登录/注册页面 -->
        <div id="auth-page" class="content">
            <div class="auth-form">
                <h2 style="text-align: center; margin-bottom: 20px;">欢迎使用WeChat Clone</h2>
                <div class="form-group">
                    <label for="auth-username">用户名</label>
                    <input type="text" id="auth-username" placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label for="auth-password">密码</label>
                    <input type="password" id="auth-password" placeholder="请输入密码">
                </div>
                <div id="auth-confirm-password-group" class="form-group" style="display: none;">
                    <label for="auth-confirm-password">确认密码</label>
                    <input type="password" id="auth-confirm-password" placeholder="请再次输入密码">
                </div>
                <button id="auth-submit-btn" class="btn">登录</button>
                <button id="auth-switch-btn" class="btn btn-secondary">切换到注册</button>
                <div class="switch-auth">
                    没有账号？<span id="auth-switch-text">立即注册</span>
                </div>
            </div>
        </div>
        
        <!-- 主页面结构 -->
        <div id="main-page" style="display: none;">
            <div class="header">
                <span class="back-btn" id="back-btn" style="display: none;">←</span>
                <span id="header-title">微信</span>
            </div>
            
            <div class="content" id="main-content">
                <!-- 首页内容会在JS中动态加载 -->
            </div>
            
            <div class="footer">
                <div class="footer-btn active" data-page="chats">
                    <span>微信</span>
                </div>
                <div class="footer-btn" data-page="contacts">
                    <span>通讯录</span>
                </div>
                <div class="footer-btn" data-page="discover">
                    <span>发现</span>
                </div>
                <div class="footer-btn" data-page="me">
                    <span>我</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 模态框模板 -->
    <div id="modal-template" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header" id="modal-header">标题</div>
            <div class="modal-body" id="modal-body">内容</div>
            <div class="modal-footer">
                <div class="modal-btn cancel" id="modal-cancel">取消</div>
                <div class="modal-btn confirm" id="modal-confirm">确定</div>
            </div>
        </div>
    </div>
    
    <script>
        // 数据存储
        const DB = {
            users: JSON.parse(localStorage.getItem('wechat_users')) || [],
            currentUser: JSON.parse(localStorage.getItem('wechat_current_user')) || null,
            friends: JSON.parse(localStorage.getItem('wechat_friends')) || {},
            friendRequests: JSON.parse(localStorage.getItem('wechat_friend_requests')) || {},
            chats: JSON.parse(localStorage.getItem('wechat_chats')) || {},
            settings: JSON.parse(localStorage.getItem('wechat_settings')) || {}
        };
        
        // 保存数据到localStorage
        function saveData() {
            localStorage.setItem('wechat_users', JSON.stringify(DB.users));
            localStorage.setItem('wechat_current_user', JSON.stringify(DB.currentUser));
            localStorage.setItem('wechat_friends', JSON.stringify(DB.friends));
            localStorage.setItem('wechat_friend_requests', JSON.stringify(DB.friendRequests));
            localStorage.setItem('wechat_chats', JSON.stringify(DB.chats));
            localStorage.setItem('wechat_settings', JSON.stringify(DB.settings));
        }
        
        // 初始化一些测试数据（如果数据库为空）
        if (DB.users.length === 0) {
            DB.users = [
                { id: 'user1', username: 'user1', password: '123456', avatar: 'https://randomuser.me/api/portraits/men/1.jpg' },
                { id: 'user2', username: 'user2', password: '123456', avatar: 'https://randomuser.me/api/portraits/women/2.jpg' },
                { id: 'user3', username: 'user3', password: '123456', avatar: 'https://randomuser.me/api/portraits/men/3.jpg' },
                { id: 'user4', username: 'user4', password: '123456', avatar: 'https://randomuser.me/api/portraits/women/4.jpg' },
                { id: 'user5', username: 'user5', password: '123456', avatar: 'https://randomuser.me/api/portraits/men/5.jpg' }
            ];
            
            DB.friends = {
                user1: ['user2', 'user3'],
                user2: ['user1'],
                user3: ['user1'],
                user4: [],
                user5: []
            };
            
            DB.chats = {
                'user1_user2': [
                    { sender: 'user1', content: '你好！', time: '10:00' },
                    { sender: 'user2', content: '你好，最近怎么样？', time: '10:02' },
                    { sender: 'user1', content: '还不错，你呢？', time: '10:05' }
                ],
                'user1_user3': [
                    { sender: 'user3', content: '嗨，有空吗？', time: '09:30' },
                    { sender: 'user1', content: '有啊，什么事？', time: '09:35' }
                ]
            };
            
            DB.friendRequests = {
                user4: [
                    { from: 'user1', time: '08:00', status: 'pending' }
                ]
            };
            
            saveData();
        }
        
        // 工具函数
        function getCurrentUserId() {
            return DB.currentUser ? DB.currentUser.id : null;
        }
        
        function getUserById(id) {
            return DB.users.find(user => user.id === id);
        }
        
        function getUserByUsername(username) {
            return DB.users.find(user => user.username === username);
        }
        
        function getChatId(user1, user2) {
            return [user1, user2].sort().join('_');
        }
        
        function formatTime(date = new Date()) {
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }
        
        function showModal(title, content, onConfirm, onCancel) {
            const modal = document.getElementById('modal-template').cloneNode(true);
            modal.id = '';
            modal.style.display = 'flex';
            
            modal.querySelector('#modal-header').textContent = title;
            modal.querySelector('#modal-body').innerHTML = content;
            
            const confirmBtn = modal.querySelector('#modal-confirm');
            const cancelBtn = modal.querySelector('#modal-cancel');
            
            confirmBtn.onclick = () => {
                if (onConfirm) onConfirm();
                document.body.removeChild(modal);
            };
            
            cancelBtn.onclick = () => {
                if (onCancel) onCancel();
                document.body.removeChild(modal);
            };
            
            document.body.appendChild(modal);
        }
        
        // 注册登录逻辑
        let isLoginMode = true;
        
        // 切换登录/注册模式
        document.getElementById('auth-switch-btn').addEventListener('click', toggleAuthMode);
        document.getElementById('auth-switch-text').addEventListener('click', toggleAuthMode);
        
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            
            const confirmGroup = document.getElementById('auth-confirm-password-group');
            const submitBtn = document.getElementById('auth-submit-btn');
            const switchBtn = document.getElementById('auth-switch-btn');
            const switchText = document.getElementById('auth-switch-text');
            
            if (isLoginMode) {
                confirmGroup.style.display = 'none';
                submitBtn.textContent = '登录';
                switchBtn.textContent = '切换到注册';
                switchText.textContent = '立即注册';
            } else {
                confirmGroup.style.display = 'block';
                submitBtn.textContent = '注册';
                switchBtn.textContent = '切换到登录';
                switchText.textContent = '立即登录';
            }
        }
        
        // 提交表单
        document.getElementById('auth-submit-btn').addEventListener('click', handleAuthSubmit);
        
        function handleAuthSubmit() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            
            if (!username || !password) {
                showModal('错误', '请输入用户名和密码');
                return;
            }
            
            if (isLoginMode) {
                login(username, password);
            } else {
                const confirmPassword = document.getElementById('auth-confirm-password').value.trim();
                if (password !== confirmPassword) {
                    showModal('错误', '两次输入的密码不一致');
                    return;
                }
                register(username, password);
            }
        }
        
        function login(username, password) {
            const user = getUserByUsername(username);
            
            if (!user) {
                showModal('错误', '用户名不存在');
                return;
            }
            
            if (user.password !== password) {
                showModal('错误', '密码不正确');
                return;
            }
            
            DB.currentUser = user;
            saveData();
            
            // 切换到主页面
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('main-page').style.display = 'block';
            
            // 初始化主页面
            initMainPage();
        }
        
        function register(username, password) {
            // 检查用户名是否已存在
            if (getUserByUsername(username)) {
                showModal('错误', '用户名已存在');
                return;
            }
            
            // 创建新用户
            const newUser = {
                id: 'user' + (DB.users.length + 1),
                username: username,
                password: password,
                avatar: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 50) + 1}.jpg`
            };
            
            DB.users.push(newUser);
            DB.friends[newUser.id] = [];
            DB.currentUser = newUser;
            saveData();
            
            showModal('注册成功', `欢迎 ${username}!`, () => {
                // 切换到主页面
                document.getElementById('auth-page').style.display = 'none';
                document.getElementById('main-page').style.display = 'block';
                
                // 初始化主页面
                initMainPage();
            });
        }
        
        // 主页面初始化
        function initMainPage() {
            // 初始化底部导航
            document.querySelectorAll('.footer-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.footer-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // 切换到对应页面
                    const page = btn.dataset.page;
                    navigateTo(page);
                });
            });
            
            // 初始化返回按钮
            document.getElementById('back-btn').addEventListener('click', goBack);
            
            // 默认显示聊天列表
            navigateTo('chats');
        }
        
        // 页面导航功能
        let currentPage = '';
        let pageHistory = [];
        let currentData = {};
        
        function navigateTo(page, data = {}) {
            if (currentPage === page) return;
            
            pageHistory.push({ page: currentPage, data: currentData });
            currentPage = page;
            currentData = data;
            
            renderPage();
        }
        
        function goBack() {
            if (pageHistory.length === 0) return;
            
            const prevPage = pageHistory.pop();
            currentPage = prevPage.page;
            currentData = prevPage.data;
            
            renderPage();
        }
        
        function renderPage() {
            const mainContent = document.getElementById('main-content');
            const backBtn = document.getElementById('back-btn');
            const headerTitle = document.getElementById('header-title');
            
            // 显示/隐藏返回按钮
            backBtn.style.display = pageHistory.length > 0 ? 'block' : 'none';
            
            // 根据当前页面渲染内容
            switch (currentPage) {
                case 'chats':
                    renderChatList();
                    headerTitle.textContent = '微信';
                    break;
                case 'contacts':
                    renderContacts();
                    headerTitle.textContent = '通讯录';
                    break;
                case 'discover':
                    renderDiscover();
                    headerTitle.textContent = '发现';
                    break;
                case 'me':
                    renderMe();
                    headerTitle.textContent = '我';
                    break;
                case 'chat':
                    renderChat(currentData.userId);
                    headerTitle.textContent = getUserById(currentData.userId).username;
                    break;
                case 'add-friend':
                    renderAddFriend();
                    headerTitle.textContent = '添加朋友';
                    break;
                case 'friend-requests':
                    renderFriendRequests();
                    headerTitle.textContent = '朋友验证';
                    break;
                case 'settings':
                    renderSettings();
                    headerTitle.textContent = '设置';
                    break;
                case 'change-password':
                    renderChangePassword();
                    headerTitle.textContent = '修改密码';
                    break;
                case 'change-avatar':
                    renderChangeAvatar();
                    headerTitle.textContent = '修改头像';
                    break;
                default:
                    renderChatList();
                    headerTitle.textContent = '微信';
            }
        }
        
        // 页面渲染函数
        function renderChatList() {
            const currentUserId = getCurrentUserId();
            const friends = DB.friends[currentUserId] || [];
            
            let html = '<ul class="chat-list">';
            
            // 显示与每个好友的最近聊天
            friends.forEach(friendId => {
                const friend = getUserById(friendId);
                const chatId = getChatId(currentUserId, friendId);
                const messages = DB.chats[chatId] || [];
                const lastMessage = messages[messages.length - 1];
                
                html += `
                    <li class="chat-item" data-user-id="${friendId}">
                        <div class="chat-avatar">
                            <img src="${friend.avatar}" alt="${friend.username}">
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">${friend.username}</div>
                            <div class="chat-last-msg">${lastMessage ? lastMessage.content : '暂无消息'}</div>
                        </div>
                        <div class="chat-time">${lastMessage ? lastMessage.time : ''}</div>
                    </li>
                `;
            });
            
            html += '</ul>';
            
            document.getElementById('main-content').innerHTML = html;
            
            // 添加点击事件
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo('chat', { userId: item.dataset.userId });
                });
            });
        }
        
        function renderContacts() {
            const currentUserId = getCurrentUserId();
            const friends = DB.friends[currentUserId] || [];
            
            let html = '<ul class="contact-list">';
            
            // 添加"新的朋友"项
            html += `
                <li class="contact-item" data-page="friend-requests">
                    <div class="contact-avatar" style="background-color: #07C160; color: white; text-align: center; line-height: 40px;">新</div>
                    <div class="contact-name">新的朋友</div>
                </li>
                <li class="contact-item" data-page="add-friend">
                    <div class="contact-avatar" style="background-color: #07C160; color: white; text-align: center; line-height: 40px;">+</div>
                    <div class="contact-name">添加朋友</div>
                </li>
            `;
            
            // 显示好友列表
            friends.forEach(friendId => {
                const friend = getUserById(friendId);
                
                html += `
                    <li class="contact-item" data-user-id="${friendId}">
                        <div class="contact-avatar">
                            <img src="${friend.avatar}" alt="${friend.username}">
                        </div>
                        <div class="contact-name">${friend.username}</div>
                    </li>
                `;
            });
            
            html += '</ul>';
            
            document.getElementById('main-content').innerHTML = html;
            
            // 添加点击事件
            document.querySelectorAll('.contact-item[data-user-id]').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo('chat', { userId: item.dataset.userId });
                });
            });
            
            document.querySelectorAll('.contact-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo(item.dataset.page);
                });
            });
        }
        
        function renderDiscover() {
            const html = `
                <ul class="discover-list">
                    <li class="discover-item">
                        <div class="discover-icon">📱</div>
                        <div class="discover-name">朋友圈</div>
                        <div class="discover-arrow"></div>
                    </li>
                    <li class="discover-item">
                        <div class="discover-icon">🔍</div>
                        <div class="discover-name">扫一扫</div>
                        <div class="discover-arrow"></div>
                    </li>
                    <li class="discover-item">
                        <div class="discover-icon">👥</div>
                        <div class="discover-name">附近的人</div>
                        <div class="discover-arrow"></div>
                    </li>
                    <li class="discover-item">
                        <div class="discover-icon">🎮</div>
                        <div class="discover-name">游戏</div>
                        <div class="discover-arrow"></div>
                    </li>
                    <li class="discover-item">
                        <div class="discover-icon">🛍️</div>
                        <div class="discover-name">购物</div>
                        <div class="discover-arrow"></div>
                    </li>
                </ul>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }
        
        function renderMe() {
            const currentUser = DB.currentUser;
            
            const html = `
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img src="${currentUser.avatar}" alt="${currentUser.username}">
                    </div>
                    <div class="profile-info">
                        <div class="profile-name">${currentUser.username}</div>
                        <div class="profile-id">微信号: ${currentUser.id}</div>
                    </div>
                    <div class="profile-qrcode">📷</div>
                </div>
                <ul class="profile-list">
                    <li class="profile-item" data-page="settings">
                        <div class="profile-icon">⚙️</div>
                        <div class="profile-item-name">设置</div>
                        <div class="profile-arrow"></div>
                    </li>
                </ul>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // 添加点击事件
            document.querySelectorAll('.profile-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo(item.dataset.page);
                });
            });
        }
        
        function renderChat(userId) {
            const currentUserId = getCurrentUserId();
            const chatId = getChatId(currentUserId, userId);
            const messages = DB.chats[chatId] || [];
            const otherUser = getUserById(userId);
            
            let html = `
                <div class="chat-messages">
            `;
            
            messages.forEach(msg => {
                const isReceived = msg.sender !== currentUserId;
                
                html += `
                    <div class="message ${isReceived ? 'received' : 'sent'}">
                        <div class="message-content">${msg.content}</div>
                        <div class="message-time">${msg.time}</div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="输入消息...">
                    <button id="send-btn">发送</button>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // 滚动到底部
            const messagesContainer = document.querySelector('.chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 添加发送消息事件
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            function sendMessage() {
                const input = document.getElementById('chat-input');
                const content = input.value.trim();
                
                if (content) {
                    const newMessage = {
                        sender: currentUserId,
                        content: content,
                        time: formatTime()
                    };
                    
                    // 添加到聊天记录
                    if (!DB.chats[chatId]) DB.chats[chatId] = [];
                    DB.chats[chatId].push(newMessage);
                    saveData();
                    
                    // 重新渲染聊天
                    renderChat(userId);
                }
            }
        }
        
        function renderAddFriend() {
            const html = `
                <div class="search-bar">
                    <input type="text" id="search-input" class="search-input" placeholder="微信号/手机号">
                </div>
                <ul class="search-results" id="search-results">
                    <!-- 搜索结果将在这里显示 -->
                </ul>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // 添加搜索事件
            document.getElementById('search-input').addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (query) {
                    searchUsers(query);
                } else {
                    document.getElementById('search-results').innerHTML = '';
                }
            });
        }
        
        function searchUsers(query) {
            const currentUserId = getCurrentUserId();
            const results = DB.users.filter(user => 
                user.id !== currentUserId && 
                (user.id.includes(query) || user.username.includes(query))
            );
            
            let html = '';
            
            results.forEach(user => {
                // 检查是否已经是好友
                const isFriend = DB.friends[currentUserId] && DB.friends[currentUserId].includes(user.id);
                const hasRequest = DB.friendRequests[user.id] && DB.friendRequests[user.id].some(req => req.from === currentUserId);
                
                html += `
                    <li class="search-result-item">
                        <div class="search-result-avatar">
                            <img src="${user.avatar}" alt="${user.username}">
                        </div>
                        <div class="search-result-info">
                            <div class="search-result-name">${user.username}</div>
                            <div class="search-result-id">微信号: ${user.id}</div>
                        </div>
                        <button class="search-result-btn" data-user-id="${user.id}" ${isFriend || hasRequest ? 'disabled style="background-color: #ccc;"' : ''}>
                            ${isFriend ? '已添加' : hasRequest ? '已发送' : '添加'}
                        </button>
                    </li>
                `;
            });
            
            document.getElementById('search-results').innerHTML = html;
            
            // 添加添加好友事件
            document.querySelectorAll('.search-result-btn:not(:disabled)').forEach(btn => {
                btn.addEventListener('click', () => {
                    sendFriendRequest(btn.dataset.userId);
                    btn.disabled = true;
                    btn.textContent = '已发送';
                    btn.style.backgroundColor = '#ccc';
                });
            });
        }
        
        function sendFriendRequest(toUserId) {
            const fromUserId = getCurrentUserId();
            
            if (!DB.friendRequests[toUserId]) {
                DB.friendRequests[toUserId] = [];
            }
            
            DB.friendRequests[toUserId].push({
                from: fromUserId,
                time: formatTime(),
                status: 'pending'
            });
            
            saveData();
            
            showModal('发送成功', '好友请求已发送', () => {
                navigateTo('contacts');
            });
        }
        
        function renderFriendRequests() {
            const currentUserId = getCurrentUserId();
            const requests = DB.friendRequests[currentUserId] || [];
            
            let html = '<ul class="contact-list">';
            
            requests.forEach((request, index) => {
                if (request.status !== 'pending') return;
                
                const fromUser = getUserById(request.from);
                
                html += `
                    <li class="request-item">
                        <div class="request-avatar">
                            <img src="${fromUser.avatar}" alt="${fromUser.username}">
                        </div>
                        <div class="request-info">
                            <div class="request-name">${fromUser.username}</div>
                            <div class="request-message">请求添加你为朋友</div>
                            <div class="request-actions">
                                <button class="request-btn accept" data-index="${index}">接受</button>
                                <button class="request-btn reject" data-index="${index}">拒绝</button>
                            </div>
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            
            document.getElementById('main-content').innerHTML = html;
            
            // 添加接受/拒绝事件
            document.querySelectorAll('.request-btn.accept').forEach(btn => {
                btn.addEventListener('click', () => {
                    handleFriendRequest(btn.dataset.index, true);
                });
            });
            
            document.querySelectorAll('.request-btn.reject').forEach(btn => {
                btn.addEventListener('click', () => {
                    handleFriendRequest(btn.dataset.index, false);
                });
            });
        }
        
        function handleFriendRequest(index, accept) {
            const currentUserId = getCurrentUserId();
            const request = DB.friendRequests[currentUserId][index];
            
            if (accept) {
                // 添加好友
                if (!DB.friends[currentUserId]) DB.friends[currentUserId] = [];
                if (!DB.friends[request.from]) DB.friends[request.from] = [];
                
                if (!DB.friends[currentUserId].includes(request.from)) {
                    DB.friends[currentUserId].push(request.from);
                }
                
                if (!DB.friends[request.from].includes(currentUserId)) {
                    DB.friends[request.from].push(currentUserId);
                }
                
                // 初始化聊天
                const chatId = getChatId(currentUserId, request.from);
                if (!DB.chats[chatId]) {
                    DB.chats[chatId] = [
                        { 
                            sender: request.from, 
                            content: '我们已经是朋友了，现在可以开始聊天了', 
                            time: formatTime() 
                        }
                    ];
                }
            }
            
            // 更新请求状态
            DB.friendRequests[currentUserId][index].status = accept ? 'accepted' : 'rejected';
            saveData();
            
            // 重新渲染页面
            renderFriendRequests();
        }
        
        function renderSettings() {
            const html = `
                <ul class="settings-list">
                    <li class="settings-item" data-page="change-avatar">
                        <div class="settings-icon">🖼️</div>
                        <div class="settings-item-name">修改头像</div>
                        <div class="settings-arrow"></div>
                    </li>
                    <li class="settings-item" data-page="change-password">
                        <div class="settings-icon">🔒</div>
                        <div class="settings-item-name">修改密码</div>
                        <div class="settings-arrow"></div>
                    </li>
                    <li class="settings-item" id="logout-btn">
                        <div class="settings-icon">🚪</div>
                        <div class="settings-item-name">退出登录</div>
                        <div class="settings-arrow"></div>
                    </li>
                </ul>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // 添加点击事件
            document.querySelectorAll('.settings-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo(item.dataset.page);
                });
            });
            
            // 添加退出登录事件
            document.getElementById('logout-btn').addEventListener('click', logout);
        }
        
        function renderChangePassword() {
            const html = `
                <div class="password-form">
                    <div class="form-group">
                        <label for="old-password">旧密码</label>
                        <input type="password" id="old-password" placeholder="请输入旧密码">
                    </div>
                    <div class="form-group">
                        <label for="new-password">新密码</label>
                        <input type="password" id="new-password" placeholder="请输入新密码">
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-password">确认新密码</label>
                        <input type="password" id="confirm-new-password" placeholder="请再次输入新密码">
                    </div>
                    <button id="change-password-btn" class="btn">确认修改</button>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // 添加修改密码事件
            document.getElementById('change-password-btn').addEventListener('click', changePassword);
        }
        
        function changePassword() {
            const oldPassword = document.getElementById('old-password').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            const confirmNewPassword = document.getElementById('confirm-new-password').value.trim();
            
            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showModal('错误', '请填写所有字段');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showModal('错误', '两次输入的新密码不一致');
                return;
            }
            
            if (DB.currentUser.password !== oldPassword) {
                showModal('错误', '旧密码不正确');
                return;
            }
            
            DB.currentUser.password = newPassword;
            saveData();
            
            showModal('成功', '密码修改成功', () => {
                navigateTo('me');
            });
        }
        
        function renderChangeAvatar() {
            const currentUser = DB.currentUser;
            
            const html = `
                <div class="avatar-form">
                    <div class="avatar-preview">
                        <img src="${currentUser.avatar}" alt="${currentUser.username}">
                    </div>
                    <div class="avatar-upload">
                        <input type="file" id="avatar-upload" accept="image/*">
                        <button id="save-avatar-btn" class="btn">保存头像</button>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // 添加头像上传预览
            document.getElementById('avatar-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.querySelector('.avatar-preview img').src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // 添加保存头像事件
            document.getElementById('save-avatar-btn').addEventListener('click', saveAvatar);
        }
        
        function saveAvatar() {
            const newAvatar = document.querySelector('.avatar-preview img').src;
            
            if (newAvatar === DB.currentUser.avatar) {
                showModal('提示', '头像未更改');
                return;
            }
            
            DB.currentUser.avatar = newAvatar;
            saveData();
            
            showModal('成功', '头像修改成功', () => {
                navigateTo('me');
            });
        }
        
        function logout() {
            DB.currentUser = null;
            saveData();
            
            // 切换到登录页面
            document.getElementById('auth-page').style.display = 'block';
            document.getElementById('main-page').style.display = 'none';
            
            // 重置表单
            document.getElementById('auth-username').value = '';
            document.getElementById('auth-password').value = '';
            document.getElementById('auth-confirm-password').value = '';
            
            // 重置页面状态
            currentPage = '';
            pageHistory = [];
            currentData = {};
        }
        
        // 检查是否已登录
        if (DB.currentUser) {
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('main-page').style.display = 'block';
            initMainPage();
        }
    </script>
</body>
</html>
