<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>矿工大冒险终极版</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        #game-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 10px;
        }
        
        header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 2px solid #4e4e6d;
            margin-bottom: 15px;
        }
        
        h1 {
            color: #f8bb22;
            font-size: 24px;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #4e4e6d;
            overflow-x: auto;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #2a2a3a;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab.active {
            background-color: #4e4e6d;
            color: #f8bb22;
        }
        
        .panel {
            display: none;
            padding: 15px;
            background-color: #2a2a3a;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .panel.active {
            display: block;
        }
        
        .resource-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #16213e;
            border-radius: 5px;
            flex-wrap: wrap;
        }
        
        .resource {
            text-align: center;
            min-width: 80px;
            margin: 5px 0;
        }
        
        .resource-value {
            font-size: 18px;
            font-weight: bold;
            color: #f8bb22;
        }
        
        .button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background-color: #4e4e6d;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .button:hover {
            background-color: #6e6e8d;
        }
        
        .button:active {
            transform: scale(0.98);
        }
        
        .button.upgrade {
            background-color: #1e8449;
        }
        
        .button.upgrade:hover {
            background-color: #27ae60;
        }
        
        .button.special {
            background-color: #8e44ad;
        }
        
        .button.special:hover {
            background-color: #9b59b6;
        }
        
        .button.danger {
            background-color: #c0392b;
        }
        
        .button.danger:hover {
            background-color: #e74c3c;
        }
        
        .progress-container {
            width: 100%;
            background-color: #4e4e6d;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #f8bb22;
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s;
        }
        
        .upgrade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #16213e;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .upgrade-info {
            flex: 1;
        }
        
        .upgrade-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .upgrade-description {
            font-size: 12px;
            color: #a0a0a0;
        }
        
        .upgrade-cost {
            text-align: right;
            min-width: 80px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 100;
            animation: fadeInOut 3s forwards;
            display: none;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; top: 10px; }
            20% { opacity: 1; top: 20px; }
            80% { opacity: 1; top: 20px; }
            100% { opacity: 0; top: 10px; }
        }
        
        .event-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2a2a3a;
            padding: 20px;
            border-radius: 10px;
            z-index: 200;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: none;
        }
        
        .event-title {
            color: #f8bb22;
            margin-bottom: 15px;
            text-align: center;
            font-size: 20px;
        }
        
        .event-content {
            margin-bottom: 20px;
        }
        
        .event-actions {
            display: flex;
            justify-content: space-between;
        }
        
        .event-button {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        
        .event-button.primary {
            background-color: #27ae60;
            color: white;
        }
        
        .event-button.secondary {
            background-color: #e74c3c;
            color: white;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* 新增样式 */
        .market-trend {
            padding: 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .trend-up {
            background-color: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
        }
        
        .trend-down {
            background-color: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
        
        .trend-neutral {
            background-color: rgba(241, 196, 15, 0.3);
            color: #f1c40f;
        }
        
        .achievement {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #16213e;
            border-radius: 5px;
            border-left: 4px solid #f8bb22;
        }
        
        .achievement.unlocked {
            border-left-color: #27ae60;
        }
        
        .achievement-progress {
            height: 5px;
            background-color: #4e4e6d;
            border-radius: 3px;
            margin-top: 5px;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background-color: #f8bb22;
            border-radius: 3px;
            width: 0%;
        }
        
        .task-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #16213e;
            border-radius: 5px;
        }
        
        .task-reward {
            color: #f8bb22;
            font-weight: bold;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #16213e;
            border-radius: 5px;
        }
        
        .pet-card {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #16213e;
            border-radius: 5px;
            text-align: center;
        }
        
        .pet-image {
            width: 80px;
            height: 80px;
            background-color: #4e4e6d;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        
        .pet-skill {
            display: inline-block;
            padding: 3px 6px;
            background-color: #8e44ad;
            border-radius: 3px;
            margin: 3px;
            font-size: 12px;
        }
        
        /* 响应式调整 */
        @media (max-width: 400px) {
            .resource {
                font-size: 12px;
            }
            .resource-value {
                font-size: 14px;
            }
            .button {
                padding: 10px;
                font-size: 14px;
            }
            .tab-container {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <header>
            <h1>矿工大冒险终极版</h1>
            <div id="player-level">等级: 1</div>
            <div id="player-prestige">转生: 0</div>
        </header>
        
        <div class="resource-display">
            <div class="resource">
                <div>金币</div>
                <div class="resource-value" id="gold">0</div>
            </div>
            <div class="resource">
                <div>矿石</div>
                <div class="resource-value" id="ore">0</div>
            </div>
            <div class="resource">
                <div>钻石</div>
                <div class="resource-value" id="diamond">0</div>
            </div>
            <div class="resource">
                <div>声望</div>
                <div class="resource-value" id="reputation">0</div>
            </div>
            <div class="resource">
                <div>能量</div>
                <div class="resource-value" id="energy">100</div>
            </div>
            <div class="resource">
                <div>宝石</div>
                <div class="resource-value" id="gem">0</div>
            </div>
        </div>
        
        <div class="tab-container">
            <div class="tab active" data-tab="mining">挖矿</div>
            <div class="tab" data-tab="upgrades">升级</div>
            <div class="tab" data-tab="market">市场</div>
            <div class="tab" data-tab="achievements">成就</div>
            <div class="tab" data-tab="tasks">任务</div>
            <div class="tab" data-tab="inventory">背包</div>
            <div class="tab" data-tab="pets">宠物</div>
            <div class="tab" data-tab="guild">工会</div>
            <div class="tab" data-tab="research">研究</div>
            <div class="tab" data-tab="prestige">转生</div>
        </div>
        
        <!-- 挖矿面板 -->
        <div class="panel active" id="mining-panel">
            <div class="progress-container">
                <div class="progress-bar" id="mining-progress"></div>
            </div>
            <button class="button" id="mine-button">挖矿</button>
            <button class="button special" id="deep-mine-button">深度挖掘 (消耗10体力)</button>
            <button class="button danger" id="blasting-button">爆破开采 (消耗50能量)</button>
            
            <h3>矿工状态</h3>
            <div>体力: <span id="stamina">100</span>/<span id="max-stamina">100</span></div>
            <div class="progress-container">
                <div class="progress-bar" id="stamina-progress" style="width: 100%;"></div>
            </div>
            <div>能量: <span id="energy-value">100</span>/100</div>
            <div class="progress-container">
                <div class="progress-bar" id="energy-progress" style="width: 100%;"></div>
            </div>
            <div>挖矿效率: <span id="mining-efficiency">1</span> 矿石/秒</div>
            <div>稀有率: <span id="rarity-chance">1</span>%</div>
            <div>暴击率: <span id="critical-chance">5</span>%</div>
            
            <h3>自动矿工</h3>
            <div id="auto-miners">自动矿工: 0</div>
            <button class="button upgrade" id="hire-miner-button">雇佣矿工 (100金币)</button>
            
            <h3>当前矿洞</h3>
            <div id="current-mine">基础矿洞 (等级1)</div>
            <button class="button" id="explore-mine-button">探索新矿洞 (50能量)</button>
        </div>
        
        <!-- 升级面板 -->
        <div class="panel" id="upgrades-panel">
            <h3>工具升级</h3>
            <div class="upgrade-item">
                <div class="upgrade-info">
                    <div class="upgrade-name">更好的镐头</div>
                    <div class="upgrade-description">提高挖矿效率 +0.5/秒</div>
                </div>
                <div class="upgrade-cost">
                    <div>50金币</div>
                    <button class="button upgrade" data-upgrade="pickaxe">升级</button>
                </div>
            </div>
            
            <div class="upgrade-item">
                <div class="upgrade-info">
                    <div class="upgrade-name">矿灯</div>
                    <div class="upgrade-description">提高稀有率 +1%</div>
                </div>
                <div class="upgrade-cost">
                    <div>100金币</div>
                    <button class="button upgrade" data-upgrade="lamp">升级</button>
                </div>
            </div>
            
            <div class="upgrade-item">
                <div class="upgrade-info">
                    <div class="upgrade-name">矿车</div>
                    <div class="upgrade-description">解锁自动运输，体力恢复+0.5/秒</div>
                </div>
                <div class="upgrade-cost">
                    <div>500金币</div>
                    <button class="button upgrade" data-upgrade="cart">解锁</button>
                </div>
            </div>
            
            <div class="upgrade-item">
                <div class="upgrade-info">
                    <div class="upgrade-name">爆破装置</div>
                    <div class="upgrade-description">解锁爆破开采，提高暴击率+2%</div>
                </div>
                <div class="upgrade-cost">
                    <div>800金币</div>
                    <button class="button upgrade" data-upgrade="blasting">解锁</button>
                </div>
            </div>
            
            <h3>矿洞升级</h3>
            <div class="upgrade-item">
                <div class="upgrade-info">
                    <div class="upgrade-name">铜矿洞</div>
                    <div class="upgrade-description">解锁铜矿，基础挖矿奖励+10%</div>
                </div>
                <div class="upgrade-cost">
                    <div>等级 2</div>
                    <button class="button upgrade" data-upgrade="copper-mine" disabled>解锁</button>
                </div>
            </div>
            
            <div class="upgrade-item">
                <div class="upgrade-info">
                    <div class="upgrade-name">铁矿洞</div>
                    <div class="upgrade-description">解锁铁矿，稀有率+5%</div>
                </div>
                <div class="upgrade-cost">
                    <div>等级 5</div>
                    <button class="button upgrade" data-upgrade="iron-mine" disabled>解锁</button>
                </div>
            </div>
        </div>
        
        <!-- 市场面板 -->
        <div class="panel" id="market-panel">
            <h3>矿石市场</h3>
            <div>当前矿石价格: <span id="ore-price">10</span> 金币/矿石 
                <span id="ore-trend" class="market-trend trend-neutral">→</span>
            </div>
            <div>当前钻石价格: <span id="diamond-price">100</span> 金币/钻石 
                <span id="diamond-trend" class="market-trend trend-neutral">→</span>
            </div>
            <div>市场波动: <span id="market-volatility">低</span></div>
            
            <h3>出售矿石</h3>
            <button class="button" id="sell-ore-button">出售矿石 (10%)</button>
            <button class="button" id="sell-all-ore-button">出售所有矿石</button>
            
            <h3>出售钻石</h3>
            <button class="button special" id="sell-diamond-button">出售钻石 (10%)</button>
            <button class="button special" id="sell-all-diamond-button">出售所有钻石</button>
            
            <h3>自动出售设置</h3>
            <div>矿石阈值: <span id="ore-threshold">0</span></div>
            <button class="button" id="increase-ore-threshold">+100</button>
            <button class="button" id="decrease-ore-threshold">-100</button>
            
            <div>钻石阈值: <span id="diamond-threshold">0</span></div>
            <button class="button" id="increase-diamond-threshold">+10</button>
            <button class="button" id="decrease-diamond-threshold">-10</button>
        </div>
        
        <!-- 成就面板 -->
        <div class="panel" id="achievements-panel">
            <h3>成就系统</h3>
            <div>已完成成就: <span id="achievements-completed">0</span>/50</div>
            <div>成就点数: <span id="achievement-points">0</span></div>
            
            <h3>挖矿成就</h3>
            <div id="mining-achievements">
                <div class="achievement">
                    <div class="upgrade-name">初出茅庐</div>
                    <div class="upgrade-description">挖到100矿石</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <!-- 更多成就会在JS中动态生成 -->
            </div>
        </div>
        
        <!-- 任务面板 -->
        <div class="panel" id="tasks-panel">
            <h3>每日任务</h3>
            <div id="daily-tasks">
                <div class="task-item">
                    <div class="upgrade-name">挖矿新手</div>
                    <div class="upgrade-description">挖矿50次</div>
                    <div class="task-reward">奖励: 100金币</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <!-- 更多任务会在JS中动态生成 -->
            </div>
            
            <h3>主线任务</h3>
            <div id="main-tasks">
                <div class="task-item">
                    <div class="upgrade-name">第一桶金</div>
                    <div class="upgrade-description">积累1000金币</div>
                    <div class="task-reward">奖励: 解锁新矿洞</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <!-- 更多任务会在JS中动态生成 -->
            </div>
        </div>
        
        <!-- 背包面板 -->
        <div class="panel" id="inventory-panel">
            <h3>装备</h3>
            <div id="equipment">
                <div class="inventory-item">
                    <div>镐头: <span id="pickaxe-equip">基础镐</span></div>
                    <button class="button upgrade" id="upgrade-pickaxe-button">升级</button>
                </div>
                <div class="inventory-item">
                    <div>矿灯: <span id="lamp-equip">基础灯</span></div>
                    <button class="button upgrade" id="upgrade-lamp-button">升级</button>
                </div>
            </div>
            
            <h3>消耗品</h3>
            <div id="consumables">
                <div class="inventory-item">
                    <div>体力药剂: <span id="stamina-potion">0</span></div>
                    <button class="button" id="use-stamina-potion">使用</button>
                </div>
                <div class="inventory-item">
                    <div>能量饮料: <span id="energy-drink">0</span></div>
                    <button class="button" id="use-energy-drink">使用</button>
                </div>
            </div>
            
            <h3>其他物品</h3>
            <div id="other-items">
                <!-- 物品会在JS中动态生成 -->
            </div>
        </div>
        
        <!-- 宠物面板 -->
        <div class="panel" id="pets-panel">
            <h3>我的宠物</h3>
            <div id="my-pets">
                <div class="pet-card">
                    <div class="pet-image">?</div>
                    <div>暂无宠物</div>
                </div>
            </div>
            
            <h3>宠物商店</h3>
            <div id="pet-shop">
                <div class="pet-card">
                    <div class="pet-image">🐭</div>
                    <div>矿鼠</div>
                    <div>价格: 500金币</div>
                    <div class="upgrade-description">提高挖矿效率+0.2/秒</div>
                    <button class="button" data-pet="mouse">购买</button>
                </div>
                <!-- 更多宠物会在JS中动态生成 -->
            </div>
        </div>
        
        <!-- 工会面板 -->
        <div class="panel" id="guild-panel">
            <h3>我的工会</h3>
            <div id="my-guild">
                <div>您尚未加入工会</div>
                <button class="button" id="create-guild-button">创建工会 (1000金币)</button>
                <button class="button" id="join-guild-button">加入工会</button>
            </div>
            
            <h3>工会技能</h3>
            <div id="guild-skills">
                <div class="upgrade-item">
                    <div class="upgrade-info">
                        <div class="upgrade-name">团队协作</div>
                        <div class="upgrade-description">所有成员挖矿效率+5%</div>
                    </div>
                    <div class="upgrade-cost">
                        <div>500声望</div>
                        <button class="button upgrade" data-guild-skill="teamwork">学习</button>
                    </div>
                </div>
                <!-- 更多技能会在JS中动态生成 -->
            </div>
        </div>
        
        <!-- 研究面板 -->
        <div class="panel" id="research-panel">
            <h3>研究实验室</h3>
            <div>研究点数: <span id="research-points">0</span></div>
            
            <h3>可用研究</h3>
            <div id="available-research">
                <div class="upgrade-item">
                    <div class="upgrade-info">
                        <div class="upgrade-name">高效采矿</div>
                        <div class="upgrade-description">挖矿效率+10%</div>
                    </div>
                    <div class="upgrade-cost">
                        <div>100研究点</div>
                        <button class="button upgrade" data-research="efficient-mining">研究</button>
                    </div>
                </div>
                <!-- 更多研究会在JS中动态生成 -->
            </div>
        </div>
        
        <!-- 转生面板 -->
        <div class="panel" id="prestige-panel">
            <h3>转生系统</h3>
            <div>当前转生可获得: <span id="prestige-points">0</span> 转生点数</div>
            <div>转生加成: <span id="prestige-bonus">0</span>% 效率</div>
            
            <h3>转生奖励</h3>
            <div class="upgrade-item">
                <div class="upgrade-info">
                    <div class="upgrade-name">经验传承</div>
                    <div class="upgrade-description">保留10%挖矿效率</div>
                </div>
                <div class="upgrade-cost">
                    <div>1转生点</div>
                    <button class="button upgrade" data-prestige="keep-efficiency">解锁</button>
                </div>
            </div>
            <!-- 更多转生奖励会在JS中动态生成 -->
            
            <button class="button danger" id="prestige-button">转生</button>
            <div class="upgrade-description">转生将重置您的进度，但会获得永久加成</div>
        </div>
        
        <div id="notification" class="notification"></div>
        
        <div id="event-popup" class="event-popup">
            <div class="event-title">特殊事件</div>
            <div class="event-content" id="event-content"></div>
            <div class="event-actions">
                <button class="event-button primary" id="event-accept">接受</button>
                <button class="event-button secondary" id="event-decline">拒绝</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            // 基础资源
            gold: 0,
            ore: 0,
            diamond: 0,
            reputation: 0,
            energy: 100,
            gem: 0,
            
            // 矿工状态
            stamina: 100,
            maxStamina: 100,
            miningEfficiency: 1,
            rarityChance: 1,
            criticalChance: 5,
            autoMiners: 0,
            minerCost: 100,
            currentMine: 0,
            minesUnlocked: 1,
            
            // 市场
            orePrice: 10,
            diamondPrice: 100,
            orePriceHistory: [10],
            diamondPriceHistory: [100],
            oreThreshold: 0,
            diamondThreshold: 0,
            marketVolatility: 0,
            
            // 成就系统
            achievements: {
                mining: {
                    'beginner': { name: '初出茅庐', desc: '挖到100矿石', goal: 100, completed: false, reward: 50 },
                    'expert': { name: '挖矿专家', desc: '挖到1000矿石', goal: 1000, completed: false, reward: 200 },
                    // 更多成就...
                },
                // 其他类别成就...
            },
            achievementPoints: 0,
            
            // 任务系统
            dailyTasks: {
                'mining-1': { name: '挖矿新手', desc: '挖矿50次', goal: 50, progress: 0, reward: 100, completed: false },
                // 更多每日任务...
            },
            mainTasks: {
                'first-gold': { name: '第一桶金', desc: '积累1000金币', goal: 1000, progress: 0, reward: 'unlock-mine', completed: false },
                // 更多主线任务...
            },
            lastDailyReset: Date.now(),
            
            // 背包
            equipment: {
                pickaxe: { name: '基础镐', level: 1, efficiency: 0 },
                lamp: { name: '基础灯', level: 1, rarity: 0 }
            },
            consumables: {
                staminaPotion: 0,
                energyDrink: 0
            },
            items: {},
            
            // 宠物系统
            pets: [],
            petShop: [
                { id: 'mouse', name: '矿鼠', price: 500, emoji: '🐭', bonus: { efficiency: 0.2 } },
                // 更多宠物...
            ],
            
            // 工会系统
            guild: null,
            guildSkills: {
                'teamwork': { name: '团队协作', desc: '所有成员挖矿效率+5%', cost: 500, learned: false }
            },
            
            // 研究系统
            researchPoints: 0,
            researches: {
                'efficient-mining': { name: '高效采矿', desc: '挖矿效率+10%', cost: 100, researched: false }
            },
            
            // 转生系统
            prestige: 0,
            prestigePoints: 0,
            prestigeBonuses: {
                'keep-efficiency': { name: '经验传承', desc: '保留10%挖矿效率', cost: 1, purchased: false, bonus: 0.1 }
            },
            
            // 其他
            upgrades: {
                pickaxe: 0,
                lamp: 0,
                cart: false,
                blasting: false,
                copperMine: false,
                ironMine: false
            },
            lastPlayed: Date.now(),
            playerLevel: 1,
            experience: 0,
            nextLevelExp: 100,
            version: '1.0.0'
        };

        // DOM元素
        const elements = {
            // 基础资源
            gold: document.getElementById('gold'),
            ore: document.getElementById('ore'),
            diamond: document.getElementById('diamond'),
            reputation: document.getElementById('reputation'),
            energy: document.getElementById('energy'),
            gem: document.getElementById('gem'),
            
            // 矿工状态
            stamina: document.getElementById('stamina'),
            maxStamina: document.getElementById('max-stamina'),
            staminaProgress: document.getElementById('stamina-progress'),
            energyValue: document.getElementById('energy-value'),
            energyProgress: document.getElementById('energy-progress'),
            miningEfficiency: document.getElementById('mining-efficiency'),
            rarityChance: document.getElementById('rarity-chance'),
            criticalChance: document.getElementById('critical-chance'),
            mineButton: document.getElementById('mine-button'),
            deepMineButton: document.getElementById('deep-mine-button'),
            blastingButton: document.getElementById('blasting-button'),
            autoMiners: document.getElementById('auto-miners'),
            hireMinerButton: document.getElementById('hire-miner-button'),
            miningProgress: document.getElementById('mining-progress'),
            currentMine: document.getElementById('current-mine'),
            exploreMineButton: document.getElementById('explore-mine-button'),
            
            // 市场
            orePrice: document.getElementById('ore-price'),
            diamondPrice: document.getElementById('diamond-price'),
            oreTrend: document.getElementById('ore-trend'),
            diamondTrend: document.getElementById('diamond-trend'),
            marketVolatility: document.getElementById('market-volatility'),
            sellOreButton: document.getElementById('sell-ore-button'),
            sellAllOreButton: document.getElementById('sell-all-ore-button'),
            sellDiamondButton: document.getElementById('sell-diamond-button'),
            sellAllDiamondButton: document.getElementById('sell-all-diamond-button'),
            oreThreshold: document.getElementById('ore-threshold'),
            diamondThreshold: document.getElementById('diamond-threshold'),
            increaseOreThreshold: document.getElementById('increase-ore-threshold'),
            decreaseOreThreshold: document.getElementById('decrease-ore-threshold'),
            increaseDiamondThreshold: document.getElementById('increase-diamond-threshold'),
            decreaseDiamondThreshold: document.getElementById('decrease-diamond-threshold'),
            
            // 成就系统
            achievementsCompleted: document.getElementById('achievements-completed'),
            achievementPoints: document.getElementById('achievement-points'),
            miningAchievements: document.getElementById('mining-achievements'),
            
            // 任务系统
            dailyTasks: document.getElementById('daily-tasks'),
            mainTasks: document.getElementById('main-tasks'),
            
            // 背包
            pickaxeEquip: document.getElementById('pickaxe-equip'),
            lampEquip: document.getElementById('lamp-equip'),
            upgradePickaxeButton: document.getElementById('upgrade-pickaxe-button'),
            upgradeLampButton: document.getElementById('upgrade-lamp-button'),
            staminaPotion: document.getElementById('stamina-potion'),
            energyDrink: document.getElementById('energy-drink'),
            useStaminaPotion: document.getElementById('use-stamina-potion'),
            useEnergyDrink: document.getElementById('use-energy-drink'),
            otherItems: document.getElementById('other-items'),
            
            // 宠物系统
            myPets: document.getElementById('my-pets'),
            petShop: document.getElementById('pet-shop'),
            
            // 工会系统
            myGuild: document.getElementById('my-guild'),
            createGuildButton: document.getElementById('create-guild-button'),
            joinGuildButton: document.getElementById('join-guild-button'),
            guildSkills: document.getElementById('guild-skills'),
            
            // 研究系统
            researchPoints: document.getElementById('research-points'),
            availableResearch: document.getElementById('available-research'),
            
            // 转生系统
            prestigePoints: document.getElementById('prestige-points'),
            prestigeBonus: document.getElementById('prestige-bonus'),
            prestigeButton: document.getElementById('prestige-button'),
            
            // 其他
            playerLevel: document.getElementById('player-level'),
            notification: document.getElementById('notification'),
            eventPopup: document.getElementById('event-popup'),
            eventContent: document.getElementById('event-content'),
            eventAccept: document.getElementById('event-accept'),
            eventDecline: document.getElementById('event-decline')
        };

        // 游戏变量
        let miningInterval;
        let staminaInterval;
        let autoMiningInterval;
        let marketInterval;
        let isMining = false;
        let miningProgress = 0;
        let eventTimeout;
        let offlineProgressCalculated = false;
        let mineNames = ['基础矿洞', '铜矿洞', '铁矿洞', '金矿洞', '水晶矿洞'];
        
        // 初始化游戏
        function initGame() {
            loadGame();
            setupEventListeners();
            updateUI();
            startGameLoops();
            
            // 计算离线进度
            if (!offlineProgressCalculated) {
                calculateOfflineProgress();
                offlineProgressCalculated = true;
            }
            
            // 检查每日任务重置
            checkDailyReset();
        }

        // 加载游戏
        function loadGame() {
            const savedGame = localStorage.getItem('minerAdventureSave');
            if (savedGame) {
                try {
                    const parsed = JSON.parse(savedGame);
                    
                    // 版本检查
                    if (parsed.version === gameState.version) {
                        Object.assign(gameState, parsed);
                        
                        // 计算离线时间
                        const now = Date.now();
                        const offlineTime = now - gameState.lastPlayed;
                        
                        if (offlineTime > 10000) { // 至少离线10秒才计算
                            const offlineSeconds = Math.floor(offlineTime / 1000);
                            
                            // 计算自动挖矿收益
                            if (gameState.autoMiners > 0) {
                                const autoMined = gameState.autoMiners * gameState.miningEfficiency * offlineSeconds;
                                gameState.ore += autoMined;
                                addExperience(autoMined / 10);
                                
                                // 随机钻石
                                for (let i = 0; i < autoMined; i++) {
                                    if (Math.random() * 100 < gameState.rarityChance) {
                                        gameState.diamond++;
                                    }
                                }
                            }
                            
                            // 计算体力恢复
                            if (gameState.upgrades.cart) {
                                const staminaRecovered = offlineSeconds * 0.5;
                                gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + staminaRecovered);
                            }
                            
                            // 计算能量恢复
                            const energyRecovered = offlineSeconds * 0.2;
                            gameState.energy = Math.min(100, gameState.energy + energyRecovered);
                            
                            // 计算银行利息
                            if (gameState.bankBalance > 0) {
                                const daysOffline = offlineTime / (1000 * 60 * 60 * 24);
                                const interest = gameState.bankBalance * (gameState.interestRate / 100) * daysOffline;
                                gameState.bankBalance += interest;
                            }
                            
                            showNotification(`您离线了 ${formatTime(offlineTime)}，自动挖矿获得 ${Math.floor(autoMined)} 矿石`);
                        }
                        
                        gameState.lastPlayed = now;
                        saveGame();
                    } else {
                        showNotification("游戏已更新，部分数据需要重置");
                    }
                } catch (e) {
                    console.error("加载存档失败:", e);
                    showNotification("加载存档失败，开始新游戏");
                }
            }
            
            // 初始化成就系统
            initAchievements();
            
            // 初始化任务系统
            initTasks();
        }

        // 保存游戏
        function saveGame() {
            gameState.lastPlayed = Date.now();
            try {
                localStorage.setItem('minerAdventureSave', JSON.stringify(gameState));
            } catch (e) {
                console.error("保存游戏失败:", e);
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 标签切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
                });
            });
            
            // 挖矿按钮
            elements.mineButton.addEventListener('click', startMining);
            elements.deepMineButton.addEventListener('click', deepMining);
            elements.blastingButton.addEventListener('click', blastingMining);
            
            // 雇佣矿工
            elements.hireMinerButton.addEventListener('click', hireMiner);
            
            // 探索矿洞
            elements.exploreMineButton.addEventListener('click', exploreNewMine);
            
            // 升级按钮
            document.querySelectorAll('[data-upgrade]').forEach(button => {
                button.addEventListener('click', () => {
                    const upgrade = button.dataset.upgrade;
                    buyUpgrade(upgrade);
                });
            });
            
            // 市场按钮
            elements.sellOreButton.addEventListener('click', () => sellOre(0.1));
            elements.sellAllOreButton.addEventListener('click', () => sellOre(1));
            elements.sellDiamondButton.addEventListener('click', () => sellDiamond(0.1));
            elements.sellAllDiamondButton.addEventListener('click', () => sellDiamond(1));
            elements.increaseOreThreshold.addEventListener('click', () => changeOreThreshold(100));
            elements.decreaseOreThreshold.addEventListener('click', () => changeOreThreshold(-100));
            elements.increaseDiamondThreshold.addEventListener('click', () => changeDiamondThreshold(10));
            elements.decreaseDiamondThreshold.addEventListener('click', () => changeDiamondThreshold(-10));
            
            // 背包按钮
            elements.useStaminaPotion.addEventListener('click', useStaminaPotion);
            elements.useEnergyDrink.addEventListener('click', useEnergyDrink);
            
            // 宠物按钮
            document.querySelectorAll('[data-pet]').forEach(button => {
                button.addEventListener('click', () => {
                    const petId = button.dataset.pet;
                    buyPet(petId);
                });
            });
            
            // 工会按钮
            elements.createGuildButton.addEventListener('click', createGuild);
            elements.joinGuildButton.addEventListener('click', joinGuild);
            
            // 研究按钮
            document.querySelectorAll('[data-research]').forEach(button => {
                button.addEventListener('click', () => {
                    const researchId = button.dataset.research;
                    conductResearch(researchId);
                });
            });
            
            // 转生按钮
            elements.prestigeButton.addEventListener('click', prestige);
            
            // 事件按钮
            elements.eventAccept.addEventListener('click', acceptEvent);
            elements.eventDecline.addEventListener('click', declineEvent);
            
            // 窗口关闭前保存
            window.addEventListener('beforeunload', saveGame);
        }

        // 开始游戏循环
        function startGameLoops() {
            // 自动挖矿循环
            if (gameState.autoMiners > 0) {
                startAutoMining();
            }
            
            // 体力恢复循环
            staminaInterval = setInterval(() => {
                if (gameState.upgrades.cart && gameState.stamina < gameState.maxStamina) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 0.5);
                    updateStaminaUI();
                }
            }, 1000);
            
            // 能量恢复循环
            setInterval(() => {
                if (gameState.energy < 100) {
                    gameState.energy = Math.min(100, gameState.energy + 0.2);
                    updateEnergyUI();
                }
            }, 1000);
            
            // 市场波动循环
            marketInterval = setInterval(updateMarketPrices, 30000);
            
            // 随机事件循环
            eventTimeout = setTimeout(triggerRandomEvent, getRandomTime(120000, 300000));
            
            // 自动出售检查
            setInterval(checkAutoSell, 10000);
            
            // 定期保存
            setInterval(saveGame, 30000);
        }

        // 开始挖矿
        function startMining() {
            if (isMining) return;
            if (gameState.stamina < 2) {
                showNotification("体力不足！");
                return;
            }
            
            isMining = true;
            miningProgress = 0;
            elements.miningProgress.style.width = '0%';
            
            miningInterval = setInterval(() => {
                miningProgress += 10;
                elements.miningProgress.style.width = `${miningProgress}%`;
                
                if (miningProgress >= 100) {
                    finishMining();
                }
            }, 500);
        }

        // 深度挖掘
        function deepMining() {
            if (gameState.stamina < 10) {
                showNotification("体力不足！");
                return;
            }
            
            gameState.stamina -= 10;
            updateStaminaUI();
            
            let baseGain = 5 + Math.floor(Math.random() * 6);
            
            // 矿洞加成
            if (gameState.currentMine > 0) {
                baseGain *= 1 + (gameState.currentMine * 0.2);
            }
            
            // 暴击检查
            let isCritical = false;
            if (Math.random() * 100 < gameState.criticalChance) {
                baseGain *= 2;
                isCritical = true;
            }
            
            const oreGain = Math.floor(baseGain * gameState.miningEfficiency);
            gameState.ore += oreGain;
            
            // 更高几率获得钻石
            let diamondGain = 0;
            if (Math.random() * 100 < gameState.rarityChance * 3) {
                diamondGain = 1;
                gameState.diamond += diamondGain;
            }
            
            // 成就进度
            updateAchievementProgress('mining', 'deep-miner', 1);
            
            if (diamondGain > 0) {
                showNotification(`${isCritical ? '暴击！' : ''}深度挖掘获得 ${oreGain} 矿石和 ${diamondGain} 钻石！`);
            } else {
                showNotification(`${isCritical ? '暴击！' : ''}深度挖掘获得 ${oreGain} 矿石！`);
            }
            
            addExperience(oreGain / 5);
            updateResourcesUI();
            saveGame();
        }

        // 爆破开采
        function blastingMining() {
            if (!gameState.upgrades.blasting) {
                showNotification("尚未解锁爆破开采！");
                return;
            }
            
            if (gameState.energy < 50) {
                showNotification("能量不足！");
                return;
            }
            
            gameState.energy -= 50;
            updateEnergyUI();
            
            let baseGain = 20 + Math.floor(Math.random() * 21);
            
            // 矿洞加成
            if (gameState.currentMine > 0) {
                baseGain *= 1 + (gameState.currentMine * 0.3);
            }
            
            // 暴击检查 (爆破开采有更高暴击率)
            let isCritical = false;
            if (Math.random() * 100 < gameState.criticalChance * 1.5) {
                baseGain *= 3;
                isCritical = true;
            }
            
            const oreGain = Math.floor(baseGain * gameState.miningEfficiency);
            gameState.ore += oreGain;
            
            // 更高几率获得钻石和宝石
            let diamondGain = 0;
            let gemGain = 0;
            
            if (Math.random() * 100 < gameState.rarityChance * 5) {
                diamondGain = 1 + Math.floor(Math.random() * 2);
                gameState.diamond += diamondGain;
            }
            
            if (gameState.currentMine >= 3 && Math.random() * 100 < gameState.rarityChance) {
                gemGain = 1;
                gameState.gem += gemGain;
            }
            
            // 成就进度
            updateAchievementProgress('mining', 'blasting-expert', 1);
            
            let message = `${isCritical ? '超级暴击！' : ''}爆破开采获得 ${oreGain} 矿石`;
            if (diamondGain > 0) message += ` 和 ${diamondGain} 钻石`;
            if (gemGain > 0) message += ` 以及 ${gemGain} 宝石`;
            message += "！";
            
            showNotification(message);
            
            addExperience(oreGain / 3);
            updateResourcesUI();
            saveGame();
        }

        // 完成挖矿
        function finishMining() {
            clearInterval(miningInterval);
            isMining = false;
            
            let oreGain = gameState.miningEfficiency;
            
            // 矿洞加成
            if (gameState.currentMine > 0) {
                oreGain *= 1 + (gameState.currentMine * 0.1);
            }
            
            oreGain = Math.floor(oreGain);
            gameState.ore += oreGain;
            
            // 体力消耗
            gameState.stamina = Math.max(0, gameState.stamina - 2);
            updateStaminaUI();
            
            // 稀有掉落
            let diamondGain = 0;
            if (Math.random() * 100 < gameState.rarityChance) {
                diamondGain = 1;
                gameState.diamond++;
            }
            
            // 成就进度
            updateAchievementProgress('mining', 'beginner', oreGain);
            updateAchievementProgress('mining', 'expert', oreGain);
            updateTaskProgress('daily', 'mining-1', 1);
            
            if (diamondGain > 0) {
                showNotification(`挖矿获得 ${oreGain} 矿石和 ${diamondGain} 钻石！`);
            } else {
                showNotification(`挖矿获得 ${oreGain} 矿石！`);
            }
            
            addExperience(oreGain / 10);
            updateResourcesUI();
            saveGame();
        }

        // 开始自动挖矿
        function startAutoMining() {
            if (autoMiningInterval) clearInterval(autoMiningInterval);
            
            autoMiningInterval = setInterval(() => {
                let oreGain = gameState.autoMiners * gameState.miningEfficiency;
                
                // 矿洞加成
                if (gameState.currentMine > 0) {
                    oreGain *= 1 + (gameState.currentMine * 0.1);
                }
                
                oreGain = Math.floor(oreGain);
                gameState.ore += oreGain;
                
                // 随机钻石
                for (let i = 0; i < oreGain; i++) {
                    if (Math.random() * 100 < gameState.rarityChance) {
                        gameState.diamond++;
                    }
                }
                
                // 成就进度
                updateAchievementProgress('mining', 'automation', oreGain);
                
                addExperience(oreGain / 20);
                updateResourcesUI();
            }, 1000);
        }

        // 雇佣矿工
        function hireMiner() {
            if (gameState.gold < gameState.minerCost) {
                showNotification("金币不足！");
                return;
            }
            
            gameState.gold -= gameState.minerCost;
            gameState.autoMiners++;
            gameState.minerCost = Math.floor(gameState.minerCost * 1.5);
            
            if (gameState.autoMiners === 1) {
                startAutoMining();
            }
            
            showNotification(`雇佣了1名自动矿工！现在共有 ${gameState.autoMiners} 名矿工。`);
            updateResourcesUI();
            elements.autoMiners.textContent = `自动矿工: ${gameState.autoMiners}`;
            elements.hireMinerButton.textContent = `雇佣矿工 (${gameState.minerCost}金币)`;
            
            // 成就进度
            updateAchievementProgress('workers', 'first-hire', 1);
            
            saveGame();
        }

        // 探索新矿洞
        function exploreNewMine() {
            if (gameState.energy < 50) {
                showNotification("能量不足！");
                return;
            }
            
            if (gameState.currentMine >= gameState.minesUnlocked - 1) {
                showNotification("没有可探索的新矿洞！");
                return;
            }
            
            gameState.energy -= 50;
            gameState.currentMine++;
            
            updateEnergyUI();
            elements.currentMine.textContent = `${mineNames[gameState.currentMine]} (等级${gameState.currentMine + 1})`;
            
            showNotification(`发现了新的矿洞：${mineNames[gameState.currentMine]}！`);
            
            // 成就进度
            updateAchievementProgress('exploration', 'explorer', 1);
            
            saveGame();
        }

        // 购买升级
        function buyUpgrade(upgrade) {
            let cost, canAfford = false;
            
            switch (upgrade) {
                case 'pickaxe':
                    cost = 50 + (gameState.upgrades.pickaxe * 25);
                    if (gameState.gold >= cost) {
                        gameState.gold -= cost;
                        gameState.upgrades.pickaxe++;
                        gameState.miningEfficiency += 0.5;
                        canAfford = true;
                        
                        // 装备升级
                        gameState.equipment.pickaxe.level++;
                        gameState.equipment.pickaxe.efficiency += 0.5;
                        gameState.equipment.pickaxe.name = getPickaxeName(gameState.equipment.pickaxe.level);
                    }
                    break;
                    
                case 'lamp':
                    cost = 100 + (gameState.upgrades.lamp * 50);
                    if (gameState.gold >= cost) {
                        gameState.gold -= cost;
                        gameState.upgrades.lamp++;
                        gameState.rarityChance += 1;
                        canAfford = true;
                        
                        // 装备升级
                        gameState.equipment.lamp.level++;
                        gameState.equipment.lamp.rarity += 1;
                        gameState.equipment.lamp.name = getLampName(gameState.equipment.lamp.level);
                    }
                    break;
                    
                case 'cart':
                    cost = 500;
                    if (gameState.gold >= cost && !gameState.upgrades.cart) {
                        gameState.gold -= cost;
                        gameState.upgrades.cart = true;
                        canAfford = true;
                    }
                    break;
                    
                case 'blasting':
                    cost = 800;
                    if (gameState.gold >= cost && !gameState.upgrades.blasting) {
                        gameState.gold -= cost;
                        gameState.upgrades.blasting = true;
                        gameState.criticalChance += 2;
                        canAfford = true;
                    }
                    break;
                    
                case 'copper-mine':
                    if (gameState.playerLevel >= 2 && !gameState.upgrades.copperMine) {
                        gameState.upgrades.copperMine = true;
                        gameState.miningEfficiency *= 1.1;
                        gameState.minesUnlocked = Math.max(gameState.minesUnlocked, 2);
                        canAfford = true;
                    }
                    break;
                    
                case 'iron-mine':
                    if (gameState.playerLevel >= 5 && !gameState.upgrades.ironMine) {
                        gameState.upgrades.ironMine = true;
                        gameState.rarityChance += 5;
                        gameState.minesUnlocked = Math.max(gameState.minesUnlocked, 3);
                        canAfford = true;
                    }
                    break;
            }
            
            if (canAfford) {
                showNotification(`升级成功: ${upgrade}`);
                updateResourcesUI();
                updateUpgradesUI();
                updateInventoryUI();
                
                // 成就进度
                updateAchievementProgress('upgrades', 'upgrader', 1);
                
                saveGame();
            } else {
                showNotification("金币不足或条件不满足！");
            }
        }

        // 出售矿石
        function sellOre(percentage) {
            const amount = Math.floor(gameState.ore * percentage);
            if (amount <= 0) {
                showNotification("没有矿石可出售！");
                return;
            }
            
            const total = amount * gameState.orePrice;
            gameState.ore -= amount;
            gameState.gold += total;
            
            // 市场影响
            gameState.orePrice = Math.max(5, gameState.orePrice - (amount / 1000));
            
            showNotification(`成功出售 ${amount} 矿石，获得 ${total} 金币`);
            updateResourcesUI();
            updateMarketUI();
            
            // 成就进度
            updateAchievementProgress('trading', 'first-sale', amount);
            
            saveGame();
        }

        // 出售钻石
        function sellDiamond(percentage) {
            const amount = Math.floor(gameState.diamond * percentage);
            if (amount <= 0) {
                showNotification("没有钻石可出售！");
                return;
            }
            
            const total = amount * gameState.diamondPrice;
            gameState.diamond -= amount;
            gameState.gold += total;
            
            // 市场影响
            gameState.diamondPrice = Math.max(50, gameState.diamondPrice - (amount * 5));
            
            showNotification(`成功出售 ${amount} 钻石，获得 ${total} 金币`);
            updateResourcesUI();
            updateMarketUI();
            
            // 成就进度
            updateAchievementProgress('trading', 'diamond-seller', amount);
            
            saveGame();
        }

        // 改变矿石出售阈值
        function changeOreThreshold(amount) {
            gameState.oreThreshold = Math.max(0, gameState.oreThreshold + amount);
            elements.oreThreshold.textContent = gameState.oreThreshold;
            saveGame();
        }

        // 改变钻石出售阈值
        function changeDiamondThreshold(amount) {
            gameState.diamondThreshold = Math.max(0, gameState.diamondThreshold + amount);
            elements.diamondThreshold.textContent = gameState.diamondThreshold;
            saveGame();
        }

        // 检查自动出售
        function checkAutoSell() {
            if (gameState.oreThreshold > 0 && gameState.ore >= gameState.oreThreshold) {
                sellOre(1); // 出售所有达到阈值的矿石
            }
            
            if (gameState.diamondThreshold > 0 && gameState.diamond >= gameState.diamondThreshold) {
                sellDiamond(1); // 出售所有达到阈值的钻石
            }
        }

        // 更新市场价格
        function updateMarketPrices() {
            // 保存旧价格
            const oldOrePrice = gameState.orePrice;
            const oldDiamondPrice = gameState.diamondPrice;
            
            // 随机波动
            const oreChange = (Math.random() - 0.5) * (gameState.marketVolatility + 1);
            const diamondChange = (Math.random() - 0.5) * (gameState.marketVolatility + 1) * 5;
            
            gameState.orePrice = Math.max(5, Math.min(20, gameState.orePrice + oreChange));
            gameState.diamondPrice = Math.max(50, Math.min(200, gameState.diamondPrice + diamondChange));
            
            // 记录价格历史
            gameState.orePriceHistory.push(gameState.orePrice);
            gameState.diamondPriceHistory.push(gameState.diamondPrice);
            
            // 限制历史记录长度
            if (gameState.orePriceHistory.length > 10) {
                gameState.orePriceHistory.shift();
                gameState.diamondPriceHistory.shift();
            }
            
            // 更新市场波动性
            updateMarketVolatility();
            
            // 更新UI
            updateMarketUI();
            
            // 检查价格趋势通知
            if (gameState.orePrice > oldOrePrice * 1.2) {
                showNotification("矿石价格上涨中！");
            } else if (gameState.orePrice < oldOrePrice * 0.8) {
                showNotification("矿石价格下跌中！");
            }
            
            if (gameState.diamondPrice > oldDiamondPrice * 1.2) {
                showNotification("钻石价格上涨中！");
            } else if (gameState.diamondPrice < oldDiamondPrice * 0.8) {
                showNotification("钻石价格下跌中！");
            }
        }

        // 更新市场波动性
        function updateMarketVolatility() {
            // 计算价格变化幅度
            let oreChanges = [];
            let diamondChanges = [];
            
            for (let i = 1; i < gameState.orePriceHistory.length; i++) {
                oreChanges.push(Math.abs(gameState.orePriceHistory[i] - gameState.orePriceHistory[i-1]));
                diamondChanges.push(Math.abs(gameState.diamondPriceHistory[i] - gameState.diamondPriceHistory[i-1]));
            }
            
            const avgOreChange = oreChanges.reduce((a, b) => a + b, 0) / oreChanges.length;
            const avgDiamondChange = diamondChanges.reduce((a, b) => a + b, 0) / diamondChanges.length;
            
            // 确定波动性等级
            const totalAvg = (avgOreChange + avgDiamondChange / 5) / 2;
            
            if (totalAvg < 0.5) {
                gameState.marketVolatility = 0;
                gameState.marketVolatilityText = "低";
            } else if (totalAvg < 1.5) {
                gameState.marketVolatility = 1;
                gameState.marketVolatilityText = "中";
            } else {
                gameState.marketVolatility = 2;
                gameState.marketVolatilityText = "高";
            }
        }

        // 使用体力药剂
        function useStaminaPotion() {
            if (gameState.consumables.staminaPotion <= 0) {
                showNotification("没有体力药剂！");
                return;
            }
            
            gameState.consumables.staminaPotion--;
            gameState.stamina = gameState.maxStamina;
            
            showNotification("使用体力药剂，体力已恢复满！");
            updateStaminaUI();
            updateInventoryUI();
            saveGame();
        }

        // 使用能量饮料
        function useEnergyDrink() {
            if (gameState.consumables.energyDrink <= 0) {
                showNotification("没有能量饮料！");
                return;
            }
            
            gameState.consumables.energyDrink--;
            gameState.energy = 100;
            
            showNotification("使用能量饮料，能量已恢复满！");
            updateEnergyUI();
            updateInventoryUI();
            saveGame();
        }

        // 购买宠物
        function buyPet(petId) {
            const pet = gameState.petShop.find(p => p.id === petId);
            if (!pet) return;
            
            if (gameState.gold < pet.price) {
                showNotification("金币不足！");
                return;
            }
            
            // 检查是否已拥有该宠物
            if (gameState.pets.some(p => p.id === petId)) {
                showNotification("您已经拥有这只宠物了！");
                return;
            }
            
            gameState.gold -= pet.price;
            gameState.pets.push({
                id: pet.id,
                name: pet.name,
                emoji: pet.emoji,
                level: 1,
                experience: 0,
                bonus: pet.bonus
            });
            
            // 应用宠物加成
            applyPetBonuses();
            
            showNotification(`获得了新宠物：${pet.name} ${pet.emoji}`);
            updateResourcesUI();
            updatePetsUI();
            
            // 成就进度
            updateAchievementProgress('pets', 'first-pet', 1);
            
            saveGame();
        }

        // 应用宠物加成
        function applyPetBonuses() {
            // 重置加成
            gameState.miningEfficiency = 1 + (gameState.upgrades.pickaxe * 0.5);
            if (gameState.upgrades.copperMine) gameState.miningEfficiency *= 1.1;
            
            // 应用宠物加成
            gameState.pets.forEach(pet => {
                if (pet.bonus.efficiency) {
                    gameState.miningEfficiency += pet.bonus.efficiency * pet.level;
                }
                // 可以添加其他类型的加成
            });
            
            updateResourcesUI();
        }

        // 创建工会
        function createGuild() {
            if (gameState.guild) {
                showNotification("您已经加入工会了！");
                return;
            }
            
            if (gameState.gold < 1000) {
                showNotification("需要1000金币创建工会！");
                return;
            }
            
            gameState.gold -= 1000;
            gameState.guild = {
                name: `矿工工会#${Math.floor(Math.random() * 1000)}`,
                level: 1,
                members: 1,
                reputation: 0
            };
            
            showNotification(`创建了新的工会：${gameState.guild.name}`);
            updateResourcesUI();
            updateGuildUI();
            
            // 成就进度
            updateAchievementProgress('guild', 'guild-leader', 1);
            
            saveGame();
        }

        // 加入工会
        function joinGuild() {
            // 简化版，实际游戏中应该有工会列表
            if (gameState.guild) {
                showNotification("您已经加入工会了！");
                return;
            }
            
            gameState.guild = {
                name: "矿工兄弟会",
                level: 3,
                members: 15,
                reputation: 0
            };
            
            showNotification(`加入了工会：${gameState.guild.name}`);
            updateGuildUI();
            
            // 成就进度
            updateAchievementProgress('guild', 'guild-member', 1);
            
            saveGame();
        }

        // 进行研究
        function conductResearch(researchId) {
            const research = gameState.researches[researchId];
            if (!research) return;
            
            if (research.researched) {
                showNotification("已经研究过这个项目了！");
                return;
            }
            
            if (gameState.researchPoints < research.cost) {
                showNotification("研究点数不足！");
                return;
            }
            
            gameState.researchPoints -= research.cost;
            research.researched = true;
            
            // 应用研究效果
            switch (researchId) {
                case 'efficient-mining':
                    gameState.miningEfficiency *= 1.1;
                    break;
                // 可以添加其他研究效果
            }
            
            showNotification(`研究完成：${research.name}`);
            updateResourcesUI();
            updateResearchUI();
            
            // 成就进度
            updateAchievementProgress('research', 'researcher', 1);
            
            saveGame();
        }

        // 转生
        function prestige() {
            if (gameState.prestigePoints < 1) {
                showNotification("至少需要1点转生点数才能转生！");
                return;
            }
            
            // 计算保留的加成
            let efficiencyBonus = 0;
            if (gameState.prestigeBonuses['keep-efficiency'].purchased) {
                efficiencyBonus = gameState.miningEfficiency * 0.1;
            }
            
            // 确认转生
            if (!confirm(`确定要转生吗？这将重置您的进度，但会获得永久加成。`)) {
                return;
            }
            
            // 增加转生次数
            gameState.prestige++;
            
            // 保存转生点数
            const earnedPoints = gameState.prestigePoints;
            
            // 重置游戏状态
            const newState = {
                // 保留的资源
                gem: gameState.gem,
                prestige: gameState.prestige,
                prestigeBonuses: gameState.prestigeBonuses,
                
                // 基础资源
                gold: 0,
                ore: 0,
                diamond: 0,
                reputation: 0,
                energy: 100,
                
                // 矿工状态
                stamina: 100,
                maxStamina: 100,
                miningEfficiency: 1 + efficiencyBonus,
                rarityChance: 1,
                criticalChance: 5,
                autoMiners: 0,
                minerCost: 100,
                currentMine: 0,
                minesUnlocked: 1,
                
                // 其他
                version: gameState.version,
                lastPlayed: Date.now()
            };
            
            // 应用转生加成
            let bonusPercent = 0;
            for (const key in newState.prestigeBonuses) {
                if (newState.prestigeBonuses[key].purchased) {
                    bonusPercent += newState.prestigeBonuses[key].bonus * 100;
                }
            }
            
            // 应用新的游戏状态
            Object.assign(gameState, newState);
            gameState.prestigePoints = earnedPoints;
            
            showNotification(`转生成功！获得 ${earnedPoints} 转生点数。永久加成: +${bonusPercent}% 效率`);
            updateUI();
            
            // 成就进度
            updateAchievementProgress('prestige', 'first-prestige', 1);
            
            saveGame();
        }

        // 初始化成就系统
        function initAchievements() {
            // 挖矿成就
            gameState.achievements.mining = {
                'beginner': { name: '初出茅庐', desc: '挖到100矿石', goal: 100, progress: 0, completed: false, reward: 50 },
                'expert': { name: '挖矿专家', desc: '挖到1000矿石', goal: 1000, progress: 0, completed: false, reward: 200 },
                'deep-miner': { name: '深度矿工', desc: '进行10次深度挖掘', goal: 10, progress: 0, completed: false, reward: 150 },
                'blasting-expert': { name: '爆破专家', desc: '进行5次爆破开采', goal: 5, progress: 0, completed: false, reward: 300 },
                'automation': { name: '自动化', desc: '累计自动挖矿获得5000矿石', goal: 5000, progress: 0, completed: false, reward: 500 },
                // 可以添加更多挖矿成就
            };
            
            // 其他类别成就
            gameState.achievements.workers = {
                'first-hire': { name: '第一员工', desc: '雇佣第一个自动矿工', goal: 1, progress: 0, completed: false, reward: 100 },
                // 可以添加更多工人成就
            };
            
            gameState.achievements.trading = {
                'first-sale': { name: '第一桶金', desc: '出售100矿石', goal: 100, progress: 0, completed: false, reward: 50 },
                'diamond-seller': { name: '钻石商人', desc: '出售10钻石', goal: 10, progress: 0, completed: false, reward: 200 },
                // 可以添加更多交易成就
            };
            
            gameState.achievements.upgrades = {
                'upgrader': { name: '升级达人', desc: '进行5次升级', goal: 5, progress: 0, completed: false, reward: 150 },
                // 可以添加更多升级成就
            };
            
            gameState.achievements.exploration = {
                'explorer': { name: '探险家', desc: '探索3个不同矿洞', goal: 3, progress: 0, completed: false, reward: 300 },
                // 可以添加更多探索成就
            };
            
            gameState.achievements.pets = {
                'first-pet': { name: '宠物爱好者', desc: '获得第一个宠物', goal: 1, progress: 0, completed: false, reward: 100 },
                // 可以添加更多宠物成就
            };
            
            gameState.achievements.guild = {
                'guild-member': { name: '工会成员', desc: '加入一个工会', goal: 1, progress: 0, completed: false, reward: 200 },
                'guild-leader': { name: '工会领袖', desc: '创建一个工会', goal: 1, progress: 0, completed: false, reward: 500 },
                // 可以添加更多工会成就
            };
            
            gameState.achievements.research = {
                'researcher': { name: '研究员', desc: '完成一项研究', goal: 1, progress: 0, completed: false, reward: 200 },
                // 可以添加更多研究成就
            };
            
            gameState.achievements.prestige = {
                'first-prestige': { name: '新的开始', desc: '第一次转生', goal: 1, progress: 0, completed: false, reward: 1000 },
                // 可以添加更多转生成就
            };
            
            // 初始化成就UI
            updateAchievementsUI();
        }

        // 初始化任务系统
        function initTasks() {
            // 每日任务
            gameState.dailyTasks = {
                'mining-1': { name: '挖矿新手', desc: '挖矿50次', goal: 50, progress: 0, reward: 100, completed: false },
                'selling-1': { name: '小商贩', desc: '出售200矿石', goal: 200, progress: 0, reward: 150, completed: false },
                // 可以添加更多每日任务
            };
            
            // 主线任务
            gameState.mainTasks = {
                'first-gold': { name: '第一桶金', desc: '积累1000金币', goal: 1000, progress: 0, reward: 'unlock-mine', completed: false },
                'deep-mining': { name: '深度挖掘', desc: '进行5次深度挖掘', goal: 5, progress: 0, reward: 'unlock-blasting', completed: false },
                // 可以添加更多主线任务
            };
            
            // 初始化任务UI
            updateTasksUI();
        }

        // 更新成就进度
        function updateAchievementProgress(category, id, amount) {
            const achievement = gameState.achievements[category]?.[id];
            if (!achievement || achievement.completed) return;
            
            achievement.progress += amount;
            
            if (achievement.progress >= achievement.goal) {
                achievement.completed = true;
                gameState.achievementPoints += achievement.reward;
                gameState.gold += achievement.reward;
                
                showNotification(`成就达成：${achievement.name}！获得 ${achievement.reward} 金币和成就点数`);
                
                // 检查是否有成就相关的奖励
                if (category === 'mining' && id === 'expert') {
                    gameState.upgrades.copperMine = true;
                    gameState.minesUnlocked = Math.max(gameState.minesUnlocked, 2);
                    showNotification("解锁了铜矿洞！");
                }
            }
            
            updateAchievementsUI();
            updateResourcesUI();
            saveGame();
        }

        // 更新任务进度
        function updateTaskProgress(type, id, amount) {
            const tasks = type === 'daily' ? gameState.dailyTasks : gameState.mainTasks;
            const task = tasks[id];
            if (!task || task.completed) return;
            
            task.progress += amount;
            
            if (task.progress >= task.goal) {
                task.completed = true;
                
                if (typeof task.reward === 'number') {
                    gameState.gold += task.reward;
                    showNotification(`任务完成：${task.name}！获得 ${task.reward} 金币`);
                } else if (task.reward === 'unlock-mine') {
                    gameState.upgrades.copperMine = true;
                    gameState.minesUnlocked = Math.max(gameState.minesUnlocked, 2);
                    showNotification(`任务完成：${task.name}！解锁了铜矿洞`);
                } else if (task.reward === 'unlock-blasting') {
                    gameState.upgrades.blasting = true;
                    gameState.criticalChance += 2;
                    showNotification(`任务完成：${task.name}！解锁了爆破开采`);
                }
            }
            
            updateTasksUI();
            updateResourcesUI();
            saveGame();
        }

        // 检查每日任务重置
        function checkDailyReset() {
            const now = new Date();
            const lastReset = new Date(gameState.lastDailyReset);
            
            // 如果不在同一天
            if (now.getDate() !== lastReset.getDate() || 
                now.getMonth() !== lastReset.getMonth() || 
                now.getFullYear() !== lastReset.getFullYear()) {
                
                // 重置每日任务
                for (const key in gameState.dailyTasks) {
                    gameState.dailyTasks[key].progress = 0;
                    gameState.dailyTasks[key].completed = false;
                }
                
                gameState.lastDailyReset = Date.now();
                showNotification("新的一天开始了，每日任务已重置！");
                
                updateTasksUI();
                saveGame();
            }
        }

        // 触发随机事件
        function triggerRandomEvent() {
            const events = [
                {
                    title: "发现稀有矿脉",
                    content: "矿工报告发现了一个可能含有丰富资源的矿脉，但要开采需要支付200金币的设备费用。",
                    accept: () => {
                        if (gameState.gold >= 200) {
                            gameState.gold -= 200;
                            const reward = 500 + Math.floor(Math.random() * 500);
                            gameState.gold += reward;
                            showNotification(`开采成功！获得 ${reward} 金币`);
                            updateResourcesUI();
                            return true;
                        } else {
                            showNotification("金币不足！");
                            return false;
                        }
                    },
                    decline: () => {
                        showNotification("你决定放弃这个机会");
                    }
                },
                {
                    title: "银行促销",
                    content: "银行正在举行促销活动，现在存款可获得双倍利息一天！",
                    accept: () => {
                        const oldRate = gameState.interestRate;
                        gameState.interestRate *= 2;
                        showNotification(`今日利息提升到 ${gameState.interestRate}%`);
                        setTimeout(() => {
                            gameState.interestRate = oldRate;
                            showNotification("促销结束，利息恢复正常");
                        }, 86400000); // 24小时后恢复
                        return true;
                    },
                    decline: () => {
                        showNotification("你决定不参加这次促销");
                    }
                },
                {
                    title: "矿工罢工",
                    content: "你的自动矿工要求更好的工作条件，要么支付每人50金币，要么他们今天效率减半。",
                    accept: () => {
                        const cost = gameState.autoMiners * 50;
                        if (gameState.gold >= cost) {
                            gameState.gold -= cost;
                            showNotification(`支付了 ${cost} 金币平息罢工`);
                            updateResourcesUI();
                            return true;
                        } else {
                            showNotification("金币不足，矿工效率减半一天");
                            const oldEfficiency = gameState.miningEfficiency;
                            gameState.miningEfficiency /= 2;
                            setTimeout(() => {
                                gameState.miningEfficiency = oldEfficiency;
                                showNotification("罢工结束，效率恢复正常");
                            }, 86400000); // 24小时后恢复
                            return true;
                        }
                    },
                    decline: () => {
                        showNotification("矿工效率减半一天");
                        const oldEfficiency = gameState.miningEfficiency;
                        gameState.miningEfficiency /= 2;
                        setTimeout(() => {
                            gameState.miningEfficiency = oldEfficiency;
                            showNotification("罢工结束，效率恢复正常");
                        }, 86400000); // 24小时后恢复
                    }
                },
                {
                    title: "神秘商人",
                    content: "一个神秘商人提供特价商品：1个能量饮料只要80金币（原价100金币）。",
                    accept: () => {
                        if (gameState.gold >= 80) {
                            gameState.gold -= 80;
                            gameState.consumables.energyDrink++;
                            showNotification("购买了1个能量饮料");
                            updateResourcesUI();
                            updateInventoryUI();
                            return true;
                        } else {
                            showNotification("金币不足！");
                            return false;
                        }
                    },
                    decline: () => {
                        showNotification("你决定不购买");
                    }
                },
                {
                    title: "矿洞坍塌",
                    content: "你的矿洞发生了部分坍塌！需要支付100金币修复，否则挖矿效率降低20%一天。",
                    accept: () => {
                        if (gameState.gold >= 100) {
                            gameState.gold -= 100;
                            showNotification("支付了100金币修复矿洞");
                            updateResourcesUI();
                            return true;
                        } else {
                            showNotification("金币不足，挖矿效率降低20%一天");
                            const oldEfficiency = gameState.miningEfficiency;
                            gameState.miningEfficiency *= 0.8;
                            setTimeout(() => {
                                gameState.miningEfficiency = oldEfficiency;
                                showNotification("矿洞修复完成，效率恢复正常");
                            }, 86400000); // 24小时后恢复
                            return true;
                        }
                    },
                    decline: () => {
                        showNotification("挖矿效率降低20%一天");
                        const oldEfficiency = gameState.miningEfficiency;
                        gameState.miningEfficiency *= 0.8;
                        setTimeout(() => {
                            gameState.miningEfficiency = oldEfficiency;
                            showNotification("矿洞修复完成，效率恢复正常");
                        }, 86400000); // 24小时后恢复
                    }
                }
            ];
            
            const randomEvent = events[Math.floor(Math.random() * events.length)];
            elements.eventContent.innerHTML = `<h4>${randomEvent.title}</h4><p>${randomEvent.content}</p>`;
            elements.eventPopup.style.display = 'block';
            
            // 设置事件按钮行为
            elements.eventAccept.onclick = () => {
                if (randomEvent.accept()) {
                    elements.eventPopup.style.display = 'none';
                    scheduleNextEvent();
                }
            };
            
            elements.eventDecline.onclick = () => {
                randomEvent.decline();
                elements.eventPopup.style.display = 'none';
                scheduleNextEvent();
            };
        }

        // 接受事件
        function acceptEvent() {
            // 实际行为在triggerRandomEvent中动态设置
        }

        // 拒绝事件
        function declineEvent() {
            // 实际行为在triggerRandomEvent中动态设置
        }

        // 安排下一个事件
        function scheduleNextEvent() {
            clearTimeout(eventTimeout);
            eventTimeout = setTimeout(triggerRandomEvent, getRandomTime(120000, 300000));
        }

        // 添加经验值
        function addExperience(amount) {
            // 转生加成
            if (gameState.prestigeBonuses['keep-efficiency'].purchased) {
                amount *= 1.1;
            }
            
            gameState.experience += amount;
            if (gameState.experience >= gameState.nextLevelExp) {
                levelUp();
            }
            
            // 更新UI
            elements.playerLevel.textContent = `等级: ${gameState.playerLevel} (${Math.floor(gameState.experience / gameState.nextLevelExp * 100)}%)`;
        }

        // 升级
        function levelUp() {
            gameState.playerLevel++;
            gameState.experience -= gameState.nextLevelExp;
            gameState.nextLevelExp = Math.floor(gameState.nextLevelExp * 1.5);
            
            // 升级奖励
            gameState.maxStamina += 10;
            gameState.stamina = gameState.maxStamina;
            
            showNotification(`升级到 ${gameState.playerLevel} 级！最大体力增加！`);
            updateStaminaUI();
            elements.playerLevel.textContent = `等级: ${gameState.playerLevel}`;
            
            // 检查是否解锁铜矿
            if (gameState.playerLevel >= 2 && !gameState.upgrades.copperMine) {
                document.querySelector('[data-upgrade="copper-mine"]').disabled = false;
                document.querySelector('[data-upgrade="copper-mine"]').previousElementSibling.firstElementChild.textContent = "免费解锁";
                showNotification("已解锁铜矿洞！");
            }
            
            // 检查是否解锁铁矿
            if (gameState.playerLevel >= 5 && !gameState.upgrades.ironMine) {
                document.querySelector('[data-upgrade="iron-mine"]').disabled = false;
                document.querySelector('[data-upgrade="iron-mine"]').previousElementSibling.firstElementChild.textContent = "免费解锁";
                showNotification("已解锁铁矿洞！");
            }
            
            // 成就进度
            updateAchievementProgress('level', 'level-up', 1);
            
            saveGame();
        }

        // 计算离线进度
        function calculateOfflineProgress() {
            // 已经在loadGame中处理
        }

        // 获取镐头名称
        function getPickaxeName(level) {
            const names = ['基础镐', '铜镐', '铁镐', '钢镐', '金镐', '钻石镐', '秘银镐', '精金镐'];
            return names[Math.min(level - 1, names.length - 1)] || `高级镐+${level - names.length}`;
        }

        // 获取矿灯名称
        function getLampName(level) {
            const names = ['基础灯', '铜灯', '铁灯', '电灯', '矿工帽', '头戴探照灯', '激光照明'];
            return names[Math.min(level - 1, names.length - 1)] || `高级灯+${level - names.length}`;
        }

        // 更新UI
        function updateUI() {
            updateResourcesUI();
            updateStaminaUI();
            updateEnergyUI();
            updateUpgradesUI();
            updateMarketUI();
            updateAchievementsUI();
            updateTasksUI();
            updateInventoryUI();
            updatePetsUI();
            updateGuildUI();
            updateResearchUI();
            updatePrestigeUI();
        }

        // 更新资源UI
        function updateResourcesUI() {
            elements.gold.textContent = Math.floor(gameState.gold);
            elements.ore.textContent = Math.floor(gameState.ore);
            elements.diamond.textContent = Math.floor(gameState.diamond);
            elements.reputation.textContent = Math.floor(gameState.reputation);
            elements.energy.textContent = Math.floor(gameState.energy);
            elements.gem.textContent = Math.floor(gameState.gem);
            elements.miningEfficiency.textContent = gameState.miningEfficiency.toFixed(1);
            elements.rarityChance.textContent = gameState.rarityChance.toFixed(1);
            elements.criticalChance.textContent = gameState.criticalChance.toFixed(1);
            elements.autoMiners.textContent = `自动矿工: ${gameState.autoMiners}`;
            elements.hireMinerButton.textContent = `雇佣矿工 (${gameState.minerCost}金币)`;
            elements.playerLevel.textContent = `等级: ${gameState.playerLevel} (${Math.floor(gameState.experience / gameState.nextLevelExp * 100)}%)`;
            elements.currentMine.textContent = `${mineNames[gameState.currentMine]} (等级${gameState.currentMine + 1})`;
        }

        // 更新体力UI
        function updateStaminaUI() {
            elements.stamina.textContent = Math.floor(gameState.stamina);
            elements.maxStamina.textContent = Math.floor(gameState.maxStamina);
            elements.staminaProgress.style.width = `${(gameState.stamina / gameState.maxStamina) * 100}%`;
        }

        // 更新能量UI
        function updateEnergyUI() {
            elements.energyValue.textContent = Math.floor(gameState.energy);
            elements.energyProgress.style.width = `${gameState.energy}%`;
        }

        // 更新升级UI
        function updateUpgradesUI() {
            document.querySelector('[data-upgrade="pickaxe"]').previousElementSibling.firstElementChild.textContent = 
                `${50 + (gameState.upgrades.pickaxe * 25)}金币`;
            document.querySelector('[data-upgrade="lamp"]').previousElementSibling.firstElementChild.textContent = 
                `${100 + (gameState.upgrades.lamp * 50)}金币`;
                
            if (gameState.upgrades.cart) {
                document.querySelector('[data-upgrade="cart"]').disabled = true;
                document.querySelector('[data-upgrade="cart"]').textContent = "已解锁";
            }
            
            if (gameState.upgrades.blasting) {
                document.querySelector('[data-upgrade="blasting"]').disabled = true;
                document.querySelector('[data-upgrade="blasting"]').textContent = "已解锁";
            }
            
            if (gameState.upgrades.copperMine) {
                document.querySelector('[data-upgrade="copper-mine"]').disabled = true;
                document.querySelector('[data-upgrade="copper-mine"]').textContent = "已解锁";
            }
            
            if (gameState.upgrades.ironMine) {
                document.querySelector('[data-upgrade="iron-mine"]').disabled = true;
                document.querySelector('[data-upgrade="iron-mine"]').textContent = "已解锁";
            }
        }

        // 更新市场UI
        function updateMarketUI() {
            elements.orePrice.textContent = gameState.orePrice.toFixed(1);
            elements.diamondPrice.textContent = gameState.diamondPrice.toFixed(1);
            
            // 更新价格趋势
            if (gameState.orePriceHistory.length > 1) {
                const last = gameState.orePriceHistory[gameState.orePriceHistory.length - 1];
                const prev = gameState.orePriceHistory[gameState.orePriceHistory.length - 2];
                
                if (last > prev) {
                    elements.oreTrend.textContent = "↑";
                    elements.oreTrend.className = "market-trend trend-up";
                } else if (last < prev) {
                    elements.oreTrend.textContent = "↓";
                    elements.oreTrend.className = "market-trend trend-down";
                } else {
                    elements.oreTrend.textContent = "→";
                    elements.oreTrend.className = "market-trend trend-neutral";
                }
            }
            
            if (gameState.diamondPriceHistory.length > 1) {
                const last = gameState.diamondPriceHistory[gameState.diamondPriceHistory.length - 1];
                const prev = gameState.diamondPriceHistory[gameState.diamondPriceHistory.length - 2];
                
                if (last > prev) {
                    elements.diamondTrend.textContent = "↑";
                    elements.diamondTrend.className = "market-trend trend-up";
                } else if (last < prev) {
                    elements.diamondTrend.textContent = "↓";
                    elements.diamondTrend.className = "market-trend trend-down";
                } else {
                    elements.diamondTrend.textContent = "→";
                    elements.diamondTrend.className = "market-trend trend-neutral";
                }
            }
            
            elements.marketVolatility.textContent = gameState.marketVolatilityText;
            elements.oreThreshold.textContent = gameState.oreThreshold;
            elements.diamondThreshold.textContent = gameState.diamondThreshold;
        }

        // 更新成就UI
        function updateAchievementsUI() {
            let completedCount = 0;
            let totalCount = 0;
            
            // 挖矿成就
            elements.miningAchievements.innerHTML = '';
            for (const key in gameState.achievements.mining) {
                const achievement = gameState.achievements.mining[key];
                totalCount++;
                if (achievement.completed) completedCount++;
                
                const progressPercent = Math.min(100, (achievement.progress / achievement.goal) * 100);
                
                const achievementElement = document.createElement('div');
                achievementElement.className = `achievement ${achievement.completed ? 'unlocked' : ''}`;
                achievementElement.innerHTML = `
                    <div class="upgrade-name">${achievement.name} ${achievement.completed ? '✓' : ''}</div>
                    <div class="upgrade-description">${achievement.desc}</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: ${progressPercent}%;"></div>
                    </div>
                `;
                
                elements.miningAchievements.appendChild(achievementElement);
            }
            
            elements.achievementsCompleted.textContent = completedCount;
            elements.achievementPoints.textContent = gameState.achievementPoints;
        }

        // 更新任务UI
        function updateTasksUI() {
            // 每日任务
            elements.dailyTasks.innerHTML = '';
            for (const key in gameState.dailyTasks) {
                const task = gameState.dailyTasks[key];
                const progressPercent = Math.min(100, (task.progress / task.goal) * 100);
                
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                taskElement.innerHTML = `
                    <div class="upgrade-name">${task.name} ${task.completed ? '✓' : ''}</div>
                    <div class="upgrade-description">${task.desc}</div>
                    <div class="task-reward">奖励: ${typeof task.reward === 'number' ? task.reward + '金币' : task.reward}</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: ${progressPercent}%;"></div>
                    </div>
                `;
                
                elements.dailyTasks.appendChild(taskElement);
            }
            
            // 主线任务
            elements.mainTasks.innerHTML = '';
            for (const key in gameState.mainTasks) {
                const task = gameState.mainTasks[key];
                const progressPercent = Math.min(100, (task.progress / task.goal) * 100);
                
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                taskElement.innerHTML = `
                    <div class="upgrade-name">${task.name} ${task.completed ? '✓' : ''}</div>
                    <div class="upgrade-description">${task.desc}</div>
                    <div class="task-reward">奖励: ${typeof task.reward === 'number' ? task.reward + '金币' : task.reward}</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: ${progressPercent}%;"></div>
                    </div>
                `;
                
                elements.mainTasks.appendChild(taskElement);
            }
        }

        // 更新背包UI
        function updateInventoryUI() {
            // 装备
            elements.pickaxeEquip.textContent = gameState.equipment.pickaxe.name;
            elements.lampEquip.textContent = gameState.equipment.lamp.name;
            
            // 消耗品
            elements.staminaPotion.textContent = gameState.consumables.staminaPotion;
            elements.energyDrink.textContent = gameState.consumables.energyDrink;
            
            // 其他物品
            elements.otherItems.innerHTML = '';
            for (const key in gameState.items) {
                const item = gameState.items[key];
                
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.innerHTML = `
                    <div>${item.name}: ${item.quantity}</div>
                    <button class="button">使用</button>
                `;
                
                elements.otherItems.appendChild(itemElement);
            }
        }

        // 更新宠物UI
        function updatePetsUI() {
            // 我的宠物
            elements.myPets.innerHTML = '';
            
            if (gameState.pets.length === 0) {
                const noPetElement = document.createElement('div');
                noPetElement.className = 'pet-card';
                noPetElement.innerHTML = `
                    <div class="pet-image">?</div>
                    <div>暂无宠物</div>
                `;
                elements.myPets.appendChild(noPetElement);
            } else {
                gameState.pets.forEach(pet => {
                    const petElement = document.createElement('div');
                    petElement.className = 'pet-card';
                    petElement.innerHTML = `
                        <div class="pet-image">${pet.emoji}</div>
                        <div>${pet.name} (等级 ${pet.level})</div>
                        <div class="upgrade-description">挖矿效率 +${pet.bonus.efficiency * pet.level}/秒</div>
                        <div class="pet-skill">挖矿助手</div>
                    `;
                    elements.myPets.appendChild(petElement);
                });
            }
            
            // 宠物商店
            elements.petShop.innerHTML = '';
            gameState.petShop.forEach(pet => {
                // 检查是否已拥有
                const owned = gameState.pets.some(p => p.id === pet.id);
                
                const petElement = document.createElement('div');
                petElement.className = 'pet-card';
                petElement.innerHTML = `
                    <div class="pet-image">${pet.emoji}</div>
                    <div>${pet.name}</div>
                    <div>价格: ${pet.price}金币</div>
                    <div class="upgrade-description">${pet.bonus.efficiency ? `提高挖矿效率 +${pet.bonus.efficiency}/秒` : ''}</div>
                    <button class="button" data-pet="${pet.id}" ${owned ? 'disabled' : ''}>${owned ? '已拥有' : '购买'}</button>
                `;
                elements.petShop.appendChild(petElement);
            });
        }

        // 更新工会UI
        function updateGuildUI() {
            if (gameState.guild) {
                elements.myGuild.innerHTML = `
                    <div>工会名称: ${gameState.guild.name}</div>
                    <div>工会等级: ${gameState.guild.level}</div>
                    <div>成员数量: ${gameState.guild.members}</div>
                    <div>工会声望: ${gameState.guild.reputation}</div>
                `;
            } else {
                elements.myGuild.innerHTML = `
                    <div>您尚未加入工会</div>
                    <button class="button" id="create-guild-button">创建工会 (1000金币)</button>
                    <button class="button" id="join-guild-button">加入工会</button>
                `;
            }
            
            // 更新工会技能
            elements.guildSkills.innerHTML = '';
            for (const key in gameState.guildSkills) {
                const skill = gameState.guildSkills[key];
                
                const skillElement = document.createElement('div');
                skillElement.className = 'upgrade-item';
                skillElement.innerHTML = `
                    <div class="upgrade-info">
                        <div class="upgrade-name">${skill.name}</div>
                        <div class="upgrade-description">${skill.desc}</div>
                    </div>
                    <div class="upgrade-cost">
                        <div>${skill.cost}声望</div>
                        <button class="button upgrade" data-guild-skill="${key}" ${skill.learned ? 'disabled' : ''}>${skill.learned ? '已学习' : '学习'}</button>
                    </div>
                `;
                
                elements.guildSkills.appendChild(skillElement);
            }
        }

        // 更新研究UI
        function updateResearchUI() {
            elements.researchPoints.textContent = gameState.researchPoints;
            
            elements.availableResearch.innerHTML = '';
            for (const key in gameState.researches) {
                const research = gameState.researches[key];
                
                const researchElement = document.createElement('div');
                researchElement.className = 'upgrade-item';
                researchElement.innerHTML = `
                    <div class="upgrade-info">
                        <div class="upgrade-name">${research.name}</div>
                        <div class="upgrade-description">${research.desc}</div>
                    </div>
                    <div class="upgrade-cost">
                        <div>${research.cost}研究点</div>
                        <button class="button upgrade" data-research="${key}" ${research.researched ? 'disabled' : ''}>${research.researched ? '已研究' : '研究'}</button>
                    </div>
                `;
                
                elements.availableResearch.appendChild(researchElement);
            }
        }

        // 更新转生UI
        function updatePrestigeUI() {
            // 计算可获得的转生点数
            let points = 0;
            
            // 基于等级
            points += Math.floor(gameState.playerLevel / 10);
            
            // 基于成就
            points += Math.floor(gameState.achievementPoints / 100);
            
            // 基于其他因素...
            
            gameState.prestigePoints = points;
            elements.prestigePoints.textContent = points;
            
            // 计算当前转生加成百分比
            let bonusPercent = 0;
            for (const key in gameState.prestigeBonuses) {
                if (gameState.prestigeBonuses[key].purchased) {
                    bonusPercent += gameState.prestigeBonuses[key].bonus * 100;
                }
            }
            
            elements.prestigeBonus.textContent = bonusPercent;
            
            // 更新转生奖励
            const prestigePanel = document.getElementById('prestige-panel');
            const existingRewards = prestigePanel.querySelectorAll('.upgrade-item');
            
            // 移除旧的奖励显示（除了第一个）
            for (let i = 1; i < existingRewards.length; i++) {
                existingRewards[i].remove();
            }
            
            // 添加转生奖励
            for (const key in gameState.prestigeBonuses) {
                if (key === 'keep-efficiency') continue; // 跳过第一个，因为已经存在
                
                const bonus = gameState.prestigeBonuses[key];
                
                const rewardElement = document.createElement('div');
                rewardElement.className = 'upgrade-item';
                rewardElement.innerHTML = `
                    <div class="upgrade-info">
                        <div class="upgrade-name">${bonus.name}</div>
                        <div class="upgrade-description">${bonus.desc}</div>
                    </div>
                    <div class="upgrade-cost">
                        <div>${bonus.cost}转生点</div>
                        <button class="button upgrade" data-prestige="${key}" ${bonus.purchased ? 'disabled' : ''}>${bonus.purchased ? '已解锁' : '解锁'}</button>
                    </div>
                `;
                
                prestigePanel.insertBefore(rewardElement, elements.prestigeButton);
            }
        }

        // 显示通知
        function showNotification(message) {
            elements.notification.textContent = message;
            elements.notification.style.display = 'block';
            elements.notification.style.animation = 'none';
            void elements.notification.offsetWidth; // 触发重绘
            elements.notification.style.animation = 'fadeInOut 3s forwards';
            
            setTimeout(() => {
                elements.notification.style.display = 'none';
            }, 3000);
        }

        // 格式化时间
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000) % 60;
            const minutes = Math.floor(ms / (1000 * 60)) % 60;
            const hours = Math.floor(ms / (1000 * 60 * 60));
            
            return `${hours}小时 ${minutes}分钟 ${seconds}秒`;
        }

        // 获取随机时间
        function getRandomTime(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // 初始化游戏
        window.onload = initGame;
    </script>
</body>
</html>
