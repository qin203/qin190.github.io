<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级人脉星球</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #4cc9f0;
            margin-bottom: 10px;
        }
        
        .countdown {
            font-size: 18px;
            color: #f72585;
            margin-bottom: 20px;
        }
        
        .auth-form {
            background-color: #16213e;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #a8dadc;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #457b9d;
            border-radius: 5px;
            background-color: #1d3557;
            color: white;
            font-size: 16px;
        }
        
        button {
            background-color: #f72585;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #b5179e;
        }
        
        .tab-container {
            display: none;
            background-color: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .active-tab {
            display: block;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #a8dadc;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-right: 5px;
        }
        
        .tab-btn.active {
            border-bottom: 3px solid #f72585;
            color: white;
        }
        
        .game-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background-color: #1d3557;
            padding: 15px;
            border-radius: 8px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            color: #4cc9f0;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 14px;
            color: #a8dadc;
        }
        
        .game-card {
            background-color: #1d3557;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        
        .game-title {
            color: #4cc9f0;
            margin-bottom: 10px;
        }
        
        .game-desc {
            color: #a8dadc;
            font-size: 14px;
        }
        
        .upgrade-btn {
            background-color: #4895ef;
            margin-top: 10px;
        }
        
        .upgrade-btn:hover {
            background-color: #3a7bd5;
        }
        
        .payment-methods {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .payment-method {
            text-align: center;
            padding: 15px;
            background-color: #1d3557;
            border-radius: 8px;
            width: 45%;
        }
        
        .payment-method img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }
        
        .admin-panel {
            background-color: #1d3557;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .admin-section {
            margin-bottom: 20px;
        }
        
        .admin-section h3 {
            color: #f72585;
            margin-bottom: 10px;
        }
        
        .user-list {
            list-style: none;
        }
        
        .user-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #16213e;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .leaderboard th, .leaderboard td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        .leaderboard th {
            background-color: #1d3557;
            color: #4cc9f0;
        }
        
        .leaderboard tr:nth-child(even) {
            background-color: rgba(29, 53, 87, 0.5);
        }
        
        .rank-1 { color: gold; font-weight: bold; }
        .rank-2 { color: silver; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }
        
        /* 大逃杀游戏样式 */
        .escape-room {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .room-card {
            background-color: #457b9d;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .room-card:hover {
            background-color: #1d3557;
            transform: translateY(-3px);
        }
        
        .room-card.selected {
            background-color: #f72585;
            border: 2px solid white;
        }
        
        .escape-stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .escape-stat {
            background-color: #1d3557;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
        }
        
        .escape-button {
            width: 100%;
            margin: 10px 0;
        }
        
        .escape-players {
            margin-top: 10px;
            font-size: 12px;
            color: #a8dadc;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 登录/注册表单 -->
        <div id="auth-container">
            <header>
                <h1>高级人脉星球</h1>
                <div class="countdown" id="countdown">开服时间: 2025年5月1日</div>
            </header>
            
            <div class="auth-form" id="login-form">
                <h2>登录</h2>
                <div class="form-group">
                    <label for="login-username">用户名</label>
                    <input type="text" id="login-username" placeholder="输入用户名">
                </div>
                <div class="form-group">
                    <label for="login-password">密码</label>
                    <input type="password" id="login-password" placeholder="输入密码">
                </div>
                <button id="login-btn">登录</button>
                <p style="text-align: center; margin-top: 15px; color: #a8dadc;">
                    还没有账号? <a href="#" id="show-register" style="color: #4cc9f0;">立即注册</a>
                </p>
            </div>
            
            <div class="auth-form" id="register-form" style="display: none;">
                <h2>注册</h2>
                <div class="form-group">
                    <label for="reg-username">用户名</label>
                    <input type="text" id="reg-username" placeholder="输入用户名">
                </div>
                <div class="form-group">
                    <label for="reg-password">密码</label>
                    <input type="password" id="reg-password" placeholder="输入密码(至少6位)">
                </div>
                <div class="form-group">
                    <label for="reg-invite">邀请码(可选)</label>
                    <input type="text" id="reg-invite" placeholder="输入邀请码(可选)">
                </div>
                <button id="register-btn">注册</button>
                <p style="text-align: center; margin-top: 15px; color: #a8dadc;">
                    已有账号? <a href="#" id="show-login" style="color: #4cc9f0;">立即登录</a>
                </p>
            </div>
        </div>
        
        <!-- 主游戏界面 (默认隐藏) -->
        <div id="game-container" style="display: none;">
            <header>
                <h1>高级人脉星球</h1>
                <div class="countdown" id="game-countdown"></div>
                <p id="user-info">欢迎, <span id="username-display"></span> | 会员: <span id="vip-status">否</span></p>
            </header>
            
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="home">首页</button>
                <button class="tab-btn" data-tab="upgrade">升级</button>
                <button class="tab-btn" data-tab="games">小游戏</button>
                <button class="tab-btn" data-tab="market">交易市场</button>
                <button class="tab-btn" data-tab="vip">会员</button>
                <button class="tab-btn" data-tab="withdraw">提现</button>
                <button class="tab-btn" data-tab="invite">邀请</button>
                <button class="tab-btn" id="logout-btn">退出</button>
            </div>
            
            <!-- 首页 -->
            <div class="tab-container active-tab" id="home-tab">
                <div class="game-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="coin-display">0</div>
                        <div class="stat-label">星脉币</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="point-display">0</div>
                        <div class="stat-label">升级积分</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="level-display">1</div>
                        <div class="stat-label">等级</div>
                    </div>
                </div>
                
                <div class="game-card" id="mine-coins">
                    <h3 class="game-title">星脉矿场</h3>
                    <p class="game-desc">每小时自动生产5个星脉币，最多积累24小时</p>
                    <button id="collect-btn">收集星脉币</button>
                    <div id="mine-progress" style="margin-top: 10px;">
                        <div style="background-color: #333; height: 20px; border-radius: 10px;">
                            <div id="progress-bar" style="background-color: #4cc9f0; height: 100%; width: 0%; border-radius: 10px;"></div>
                        </div>
                        <p id="progress-text" style="text-align: center; margin-top: 5px;">0/5 星脉币</p>
                    </div>
                </div>
                
                <div class="game-card">
                    <h3 class="game-title">排行榜</h3>
                    <p class="game-desc">查看本周排名前10的玩家</p>
                    <button id="show-leaderboard">查看排行榜</button>
                </div>
                
                <div class="game-card">
                    <h3 class="game-title">公告</h3>
                    <div id="announcement">
                        <p>1. 邀请好友升级到5级，邀请50人可联系管理员领取888红包</p>
                        <p>2. 排行榜每周刷新，前三名有现金奖励</p>
                        <p>3. 管理员微信: 19042507597</p>
                    </div>
                </div>
            </div>
            
            <!-- 升级 -->
            <div class="tab-container" id="upgrade-tab">
                <h2>升级系统</h2>
                <p>当前等级: <span id="current-level">1</span>/60</p>
                <p>升级所需积分: <span id="next-level-cost">0.3</span></p>
                <p>当前积分: <span id="current-points">0</span></p>
                <button id="upgrade-btn" class="upgrade-btn">升级</button>
                
                <h3 style="margin-top: 20px;">等级奖励</h3>
                <ul>
                    <li>1-5级: 每次升级免费</li>
                    <li>6-20级: 每次升级需要1积分</li>
                    <li>21-40级: 每次升级需要3积分</li>
                    <li>41-60级: 每次升级需要5积分</li>
                </ul>
            </div>
            
            <!-- 小游戏 -->
            <div class="tab-container" id="games-tab">
                <h2>小游戏</h2>
                <p>通过小游戏赚取升级积分</p>
                
                <div class="game-card" data-game="clicker">
                    <h3 class="game-title">点击赚积分</h3>
                    <p class="game-desc">每次点击获得0.01积分，消耗1星脉币/次</p>
                    <button class="play-game-btn">开始游戏</button>
                </div>
                
                <div class="game-card" data-game="memory">
                    <h3 class="game-title">记忆匹配</h3>
                    <p class="game-desc">匹配卡片获得积分，消耗2星脉币/次</p>
                    <button class="play-game-btn">开始游戏</button>
                </div>
                
                <div class="game-card" data-game="quiz">
                    <h3 class="game-title">知识问答</h3>
                    <p class="game-desc">回答正确获得积分，消耗3星脉币/次</p>
                    <button class="play-game-btn">开始游戏</button>
                </div>
                
                <!-- 新增大逃杀游戏 -->
                <div class="game-card" data-game="escape">
                    <h3 class="game-title">能量石-大谜杀</h3>
                    <p class="game-desc">选择房间躲避外星人，幸存者瓜分被杀房间的能量石</p>
                    <button class="play-game-btn">开始游戏</button>
                </div>
            </div>
            
            <!-- 交易市场 -->
            <div class="tab-container" id="market-tab">
                <h2>交易市场</h2>
                <p>交易功能暂未开放</p>
            </div>
            
            <!-- 会员 -->
            <div class="tab-container" id="vip-tab">
                <h2>会员特权</h2>
                <div class="payment-methods">
                    <div class="payment-method">
                        <h3>支付宝</h3>
                        <img src="alipay_qr.jpg" alt="支付宝收款码">
                        <p>支持信用卡/花呗付款</p>
                    </div>
                    <div class="payment-method">
                        <h3>微信支付</h3>
                        <img src="wechat_qr.jpg" alt="微信收款码">
                        <p>扫码支付32元开通会员</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">会员特权</h3>
                <ul>
                    <li>每日额外获得10星脉币</li>
                    <li>小游戏消耗减少50%</li>
                    <li>提现手续费降低</li>
                    <li>专属会员标识</li>
                </ul>
                
                <button id="apply-vip" style="margin-top: 20px;">申请开通会员</button>
            </div>
            
            <!-- 提现 -->
            <div class="tab-container" id="withdraw-tab">
                <h2>提现申请</h2>
                <p>当前可提现星脉币: <span id="withdraw-coin">0</span></p>
                <div class="form-group">
                    <label for="withdraw-amount">提现金额</label>
                    <input type="number" id="withdraw-amount" placeholder="输入提现金额">
                </div>
                <div class="form-group">
                    <label for="withdraw-method">提现方式</label>
                    <select id="withdraw-method" style="width: 100%; padding: 12px; background-color: #1d3557; color: white; border: 1px solid #457b9d; border-radius: 5px;">
                        <option value="alipay">支付宝</option>
                        <option value="wechat">微信支付</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="withdraw-account">收款账号</label>
                    <input type="text" id="withdraw-account" placeholder="输入支付宝/微信账号">
                </div>
                <button id="submit-withdraw">提交提现申请</button>
                
                <h3 style="margin-top: 20px;">提现规则</h3>
                <ul>
                    <li>最低提现金额: 100星脉币</li>
                    <li>提现手续费: 10%(会员5%)</li>
                    <li>处理时间: 24小时内</li>
                </ul>
            </div>
            
            <!-- 邀请 -->
            <div class="tab-container" id="invite-tab">
                <h2>邀请好友</h2>
                <p>您的专属邀请码: <strong id="invite-code">LOADING...</strong></p>
                <p>已邀请好友: <span id="invited-count">0</span>人</p>
                <p>其中达到5级的: <span id="invited-level5">0</span>人</p>
                
                <h3 style="margin-top: 20px;">邀请奖励</h3>
                <ul>
                    <li>每邀请1人获得1星脉币</li>
                    <li>好友达到5级，额外获得5星脉币</li>
                    <li>邀请50人达到5级，联系管理员领取888红包</li>
                </ul>
                
                <button id="copy-invite" style="margin-top: 20px;">复制邀请链接</button>
            </div>
        </div>
        
        <!-- 管理员面板 (默认隐藏) -->
        <div id="admin-container" style="display: none;">
            <header>
                <h1>高级人脉星球 - 管理面板</h1>
                <button id="admin-logout" style="background-color: #f72585; padding: 8px 15px; margin-top: 10px;">退出管理</button>
            </header>
            
            <div class="admin-panel">
                <div class="admin-section">
                    <h3>会员申请</h3>
                    <ul class="user-list" id="vip-requests">
                        <li>加载中...</li>
                    </ul>
                </div>
                
                <div class="admin-section">
                    <h3>提现申请</h3>
                    <ul class="user-list" id="withdraw-requests">
                        <li>加载中...</li>
                    </ul>
                </div>
                
                <div class="admin-section">
                    <h3>用户管理</h3>
                    <div class="form-group">
                        <input type="text" id="search-user" placeholder="搜索用户名">
                    </div>
                    <ul class="user-list" id="user-list">
                        <li>加载中...</li>
                    </ul>
                </div>
                
                <div class="admin-section">
                    <h3>系统设置</h3>
                    <div class="form-group">
                        <label for="announcement-edit">公告编辑</label>
                        <textarea id="announcement-edit" rows="4" style="width: 100%; padding: 10px; background-color: #1d3557; color: white; border: 1px solid #457b9d; border-radius: 5px;"></textarea>
                    </div>
                    <button id="save-settings">保存设置</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 排行榜模态框 -->
    <div class="modal" id="leaderboard-modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>本周排行榜</h2>
            <table class="leaderboard">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>用户名</th>
                        <th>等级</th>
                        <th>星脉币</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <tr>
                        <td class="rank-1">1</td>
                        <td>玩家1</td>
                        <td>45</td>
                        <td>1200</td>
                    </tr>
                    <tr>
                        <td class="rank-2">2</td>
                        <td>玩家2</td>
                        <td>38</td>
                        <td>980</td>
                    </tr>
                    <tr>
                        <td class="rank-3">3</td>
                        <td>玩家3</td>
                        <td>35</td>
                        <td>850</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 小游戏模态框 -->
    <div class="modal" id="game-modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="game-modal-title">游戏名称</h2>
            <div id="game-modal-content">
                <!-- 游戏内容动态加载 -->
            </div>
        </div>
    </div>
    
    <script>
        // 游戏数据
        const gameData = {
            users: {},
            currentUser: null,
            adminUser: { username: "admin", password: "admin123" },
            announcements: [
                "邀请好友升级到5级，邀请50人可联系管理员领取888红包",
                "排行榜每周刷新，前三名有现金奖励",
                "管理员微信: 19042507597"
            ],
            leaderboard: [],
            vipRequests: [],
            withdrawRequests: [],
            escapeRooms: {
                rooms: ["量茶间", "太憩舱", "航指室", "星沙龙", "星洁室", "星悠室", "里空间", "音乐舱", "里悠室"],
                players: {},
                gameInProgress: false
            }
        };

        // DOM元素
        const elements = {
            authContainer: document.getElementById('auth-container'),
            gameContainer: document.getElementById('game-container'),
            adminContainer: document.getElementById('admin-container'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            showLogin: document.getElementById('show-login'),
            showRegister: document.getElementById('show-register'),
            loginBtn: document.getElementById('login-btn'),
            registerBtn: document.getElementById('register-btn'),
            loginUsername: document.getElementById('login-username'),
            loginPassword: document.getElementById('login-password'),
            regUsername: document.getElementById('reg-username'),
            regPassword: document.getElementById('reg-password'),
            regInvite: document.getElementById('reg-invite'),
            logoutBtn: document.getElementById('logout-btn'),
            adminLogout: document.getElementById('admin-logout'),
            usernameDisplay: document.getElementById('username-display'),
            vipStatus: document.getElementById('vip-status'),
            coinDisplay: document.getElementById('coin-display'),
            pointDisplay: document.getElementById('point-display'),
            levelDisplay: document.getElementById('level-display'),
            currentLevel: document.getElementById('current-level'),
            nextLevelCost: document.getElementById('next-level-cost'),
            currentPoints: document.getElementById('current-points'),
            upgradeBtn: document.getElementById('upgrade-btn'),
            collectBtn: document.getElementById('collect-btn'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            mineCoins: document.getElementById('mine-coins'),
            showLeaderboard: document.getElementById('show-leaderboard'),
            leaderboardModal: document.getElementById('leaderboard-modal'),
            leaderboardBody: document.getElementById('leaderboard-body'),
            closeBtns: document.querySelectorAll('.close-btn'),
            gameModal: document.getElementById('game-modal'),
            gameModalTitle: document.getElementById('game-modal-title'),
            gameModalContent: document.getElementById('game-modal-content'),
            playGameBtns: document.querySelectorAll('.play-game-btn'),
            inviteCode: document.getElementById('invite-code'),
            invitedCount: document.getElementById('invited-count'),
            invitedLevel5: document.getElementById('invited-level5'),
            copyInvite: document.getElementById('copy-invite'),
            applyVip: document.getElementById('apply-vip'),
            withdrawCoin: document.getElementById('withdraw-coin'),
            withdrawAmount: document.getElementById('withdraw-amount'),
            withdrawMethod: document.getElementById('withdraw-method'),
            withdrawAccount: document.getElementById('withdraw-account'),
            submitWithdraw: document.getElementById('submit-withdraw'),
            vipRequests: document.getElementById('vip-requests'),
            withdrawRequests: document.getElementById('withdraw-requests'),
            userList: document.getElementById('user-list'),
            searchUser: document.getElementById('search-user'),
            announcementEdit: document.getElementById('announcement-edit'),
            saveSettings: document.getElementById('save-settings'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            tabs: document.querySelectorAll('.tab-container'),
            countdown: document.getElementById('countdown'),
            gameCountdown: document.getElementById('game-countdown')
        };

        // 初始化游戏
        function initGame() {
            // 检查本地存储
            if (localStorage.getItem('pmGameData')) {
                const savedData = JSON.parse(localStorage.getItem('pmGameData'));
                Object.assign(gameData, savedData);
            }
            
            // 设置开服倒计时
            updateCountdown();
            setInterval(updateCountdown, 1000);
            
            // 事件监听器
            setupEventListeners();
            
            // 检查是否有已登录用户
            if (localStorage.getItem('pmCurrentUser')) {
                const username = localStorage.getItem('pmCurrentUser');
                if (gameData.users[username]) {
                    loginUser(username);
                }
            }
        }

        // 更新开服倒计时
        function updateCountdown() {
            const launchDate = new Date('2025-05-01T00:00:00');
            const now = new Date();
            
            if (now >= launchDate) {
                elements.countdown.textContent = "游戏已开服";
                elements.gameCountdown.textContent = "开服时间: 2025年5月1日";
                return;
            }
            
            const diff = launchDate - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            elements.countdown.textContent = `开服倒计时: ${days}天 ${hours}小时 ${minutes}分 ${seconds}秒`;
            elements.gameCountdown.textContent = `开服倒计时: ${days}天 ${hours}小时 ${minutes}分 ${seconds}秒`;
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 登录/注册切换
            elements.showLogin.addEventListener('click', (e) => {
                e.preventDefault();
                elements.loginForm.style.display = 'block';
                elements.registerForm.style.display = 'none';
            });
            
            elements.showRegister.addEventListener('click', (e) => {
                e.preventDefault();
                elements.loginForm.style.display = 'none';
                elements.registerForm.style.display = 'block';
            });
            
            // 登录按钮
            elements.loginBtn.addEventListener('click', () => {
                const username = elements.loginUsername.value.trim();
                const password = elements.loginPassword.value.trim();
                
                if (!username || !password) {
                    alert('请输入用户名和密码');
                    return;
                }
                
                // 检查管理员登录
                if (username === gameData.adminUser.username && password === gameData.adminUser.password) {
                    loginAdmin();
                    return;
                }
                
                // 检查普通用户
                if (!gameData.users[username]) {
                    alert('用户名不存在');
                    return;
                }
                
                if (gameData.users[username].password !== password) {
                    alert('密码错误');
                    return;
                }
                
                loginUser(username);
            });
            
            // 注册按钮
            elements.registerBtn.addEventListener('click', () => {
                const username = elements.regUsername.value.trim();
                const password = elements.regPassword.value.trim();
                const inviteCode = elements.regInvite.value.trim();
                
                if (!username || !password) {
                    alert('请输入用户名和密码');
                    return;
                }
                
                if (password.length < 6) {
                    alert('密码至少需要6位');
                    return;
                }
                
                if (gameData.users[username]) {
                    alert('用户名已存在');
                    return;
                }
                
                // 创建新用户
                const newUser = {
                    username,
                    password,
                    coins: 0,
                    points: 0,
                    level: 1,
                    isVIP: false,
                    lastMineTime: Date.now(),
                    minedCoins: 0,
                    inviteCode: generateInviteCode(),
                    invitedUsers: [],
                    invitedLevel5Users: [],
                    vipRequested: false,
                    withdrawHistory: []
                };
                
                gameData.users[username] = newUser;
                
                // 处理邀请码
                if (inviteCode) {
                    const inviter = findUserByInviteCode(inviteCode);
                    if (inviter) {
                        inviter.invitedUsers.push(username);
                        inviter.coins += 1; // 邀请奖励
                        
                        // 更新邀请者数据
                        gameData.users[inviter.username] = inviter;
                    }
                }
                
                // 保存数据
                saveGameData();
                
                alert('注册成功！');
                elements.loginForm.style.display = 'block';
                elements.registerForm.style.display = 'none';
                elements.loginUsername.value = username;
                elements.loginPassword.value = '';
            });
            
            // 退出登录
            elements.logoutBtn.addEventListener('click', logoutUser);
            elements.adminLogout.addEventListener('click', logoutAdmin);
            
            // 标签页切换
            elements.tabBtns.forEach(btn => {
                if (btn.id !== 'logout-btn') {
                    btn.addEventListener('click', () => {
                        const tabId = btn.getAttribute('data-tab');
                        switchTab(tabId);
                    });
                }
            });
            
            // 关闭模态框
            elements.closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.leaderboardModal.style.display = 'none';
                    elements.gameModal.style.display = 'none';
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', (e) => {
                if (e.target === elements.leaderboardModal) {
                    elements.leaderboardModal.style.display = 'none';
                }
                if (e.target === elements.gameModal) {
                    elements.gameModal.style.display = 'none';
                }
            });
            
            // 收集星脉币
            elements.collectBtn.addEventListener('click', collectCoins);
            
            // 查看排行榜
            elements.showLeaderboard.addEventListener('click', showLeaderboard);
            
            // 升级
            elements.upgradeBtn.addEventListener('click', upgradeLevel);
            
            // 小游戏按钮
            elements.playGameBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const gameCard = e.target.closest('.game-card');
                    const gameName = gameCard.getAttribute('data-game');
                    startGame(gameName);
                });
            });
            
            // 复制邀请链接
            elements.copyInvite.addEventListener('click', copyInviteLink);
            
            // 申请会员
            elements.applyVip.addEventListener('click', applyForVIP);
            
            // 提交提现申请
            elements.submitWithdraw.addEventListener('click', submitWithdrawRequest);
            
            // 管理员保存设置
            elements.saveSettings.addEventListener('click', saveAdminSettings);
            
            // 搜索用户
            elements.searchUser.addEventListener('input', searchUsers);
        }

        // 生成邀请码
        function generateInviteCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // 通过邀请码查找用户
        function findUserByInviteCode(code) {
            for (const username in gameData.users) {
                if (gameData.users[username].inviteCode === code) {
                    return gameData.users[username];
                }
            }
            return null;
        }

        // 登录用户
        function loginUser(username) {
            gameData.currentUser = gameData.users[username];
            localStorage.setItem('pmCurrentUser', username);
            
            // 更新UI
            elements.authContainer.style.display = 'none';
            elements.gameContainer.style.display = 'block';
            elements.adminContainer.style.display = 'none';
            
            updateUserUI();
            startMiningTimer();
        }

        // 登录管理员
        function loginAdmin() {
            localStorage.setItem('pmCurrentUser', 'admin');
            
            // 更新UI
            elements.authContainer.style.display = 'none';
            elements.gameContainer.style.display = 'none';
            elements.adminContainer.style.display = 'block';
            
            loadAdminData();
        }

        // 退出用户
        function logoutUser() {
            gameData.currentUser = null;
            localStorage.removeItem('pmCurrentUser');
            
            // 重置表单
            elements.loginUsername.value = '';
            elements.loginPassword.value = '';
            
            // 更新UI
            elements.authContainer.style.display = 'block';
            elements.gameContainer.style.display = 'none';
            elements.adminContainer.style.display = 'none';
            elements.loginForm.style.display = 'block';
            elements.registerForm.style.display = 'none';
        }

        // 退出管理员
        function logoutAdmin() {
            localStorage.removeItem('pmCurrentUser');
            
            // 更新UI
            elements.authContainer.style.display = 'block';
            elements.gameContainer.style.display = 'none';
            elements.adminContainer.style.display = 'none';
            elements.loginForm.style.display = 'block';
            elements.registerForm.style.display = 'none';
        }

        // 更新用户界面
        function updateUserUI() {
            const user = gameData.currentUser;
            
            elements.usernameDisplay.textContent = user.username;
            elements.vipStatus.textContent = user.isVIP ? '是' : '否';
            elements.vipStatus.style.color = user.isVIP ? '#4cc9f0' : '#f72585';
            
            elements.coinDisplay.textContent = user.coins;
            elements.pointDisplay.textContent = user.points.toFixed(2);
            elements.levelDisplay.textContent = user.level;
            elements.currentLevel.textContent = user.level;
            
            // 计算下一级所需积分
            let nextLevelCost = 0;
            if (user.level < 5) {
                nextLevelCost = user.level === 1 ? 0.3 : 0.1;
            } else if (user.level < 20) {
                nextLevelCost = 1;
            } else if (user.level < 40) {
                nextLevelCost = 3;
            } else if (user.level < 60) {
                nextLevelCost = 5;
            }
            
            elements.nextLevelCost.textContent = nextLevelCost;
            elements.currentPoints.textContent = user.points.toFixed(2);
            
            // 更新邀请信息
            elements.inviteCode.textContent = user.inviteCode;
            elements.invitedCount.textContent = user.invitedUsers.length;
            elements.invitedLevel5.textContent = user.invitedLevel5Users.length;
            
            // 更新可提现星脉币
            elements.withdrawCoin.textContent = user.coins;
        }

        // 开始挖矿计时器
        function startMiningTimer() {
            updateMiningProgress();
            setInterval(updateMiningProgress, 1000);
        }

        // 更新挖矿进度
        function updateMiningProgress() {
            const user = gameData.currentUser;
            if (!user) return;
            
            const now = Date.now();
            const elapsed = (now - user.lastMineTime) / 1000; // 秒
            const hoursElapsed = elapsed / 3600;
            
            // 每小时5个币，最多24小时(120个币)
            const maxCoins = 120;
            const coinsEarned = Math.min(hoursElapsed * 5, maxCoins);
            
            // 更新UI
            const progressPercent = (coinsEarned % 5 / 5) * 100;
            elements.progressBar.style.width = `${progressPercent}%`;
            elements.progressText.textContent = `${(coinsEarned % 5).toFixed(2)}/5 星脉币`;
            
            // 保存已挖矿但未收集的币
            user.minedCoins = coinsEarned;
            saveGameData();
        }

        // 收集星脉币
        function collectCoins() {
            const user = gameData.currentUser;
            if (!user) return;
            
            if (user.minedCoins <= 0) {
                alert('没有可收集的星脉币');
                return;
            }
            
            const coinsToAdd = Math.floor(user.minedCoins);
            user.coins += coinsToAdd;
            user.minedCoins -= coinsToAdd;
            user.lastMineTime = Date.now();
            
            updateUserUI();
            saveGameData();
            
            alert(`成功收集 ${coinsToAdd} 星脉币!`);
        }

        // 切换标签页
        function switchTab(tabId) {
            // 更新按钮状态
            elements.tabBtns.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 更新标签内容
            elements.tabs.forEach(tab => {
                if (tab.id === `${tabId}-tab`) {
                    tab.classList.add('active-tab');
                } else {
                    tab.classList.remove('active-tab');
                }
            });
        }

        // 显示排行榜
        function showLeaderboard() {
            // 生成测试数据
            if (gameData.leaderboard.length === 0) {
                gameData.leaderboard = generateLeaderboard();
            }
            
            // 更新排行榜UI
            elements.leaderboardBody.innerHTML = '';
            gameData.leaderboard.forEach((user, index) => {
                const row = document.createElement('tr');
                
                const rankCell = document.createElement('td');
                if (index === 0) rankCell.className = 'rank-1';
                else if (index === 1) rankCell.className = 'rank-2';
                else if (index === 2) rankCell.className = 'rank-3';
                rankCell.textContent = index + 1;
                
                const nameCell = document.createElement('td');
                nameCell.textContent = user.username;
                
                const levelCell = document.createElement('td');
                levelCell.textContent = user.level;
                
                const coinCell = document.createElement('td');
                coinCell.textContent = user.coins;
                
                row.appendChild(rankCell);
                row.appendChild(nameCell);
                row.appendChild(levelCell);
                row.appendChild(coinCell);
                
                elements.leaderboardBody.appendChild(row);
            });
            
            elements.leaderboardModal.style.display = 'flex';
        }

        // 生成排行榜数据
        function generateLeaderboard() {
            const users = [];
            
            // 添加当前用户
            if (gameData.currentUser) {
                users.push({
                    username: gameData.currentUser.username,
                    level: gameData.currentUser.level,
                    coins: gameData.currentUser.coins
                });
            }
            
            // 添加其他用户
            for (const username in gameData.users) {
                if (!gameData.currentUser || username !== gameData.currentUser.username) {
                    users.push({
                        username,
                        level: gameData.users[username].level,
                        coins: gameData.users[username].coins
                    });
                }
            }
            
            // 按等级和星脉币排序
            return users.sort((a, b) => {
                if (b.level !== a.level) return b.level - a.level;
                return b.coins - a.coins;
            }).slice(0, 10);
        }

        // 升级等级
        function upgradeLevel() {
            const user = gameData.currentUser;
            if (!user) return;
            
            // 检查是否已达到最高等级
            if (user.level >= 60) {
                alert('您已达到最高等级!');
                return;
            }
            
            // 计算升级所需积分
            let requiredPoints = 0;
            if (user.level < 5) {
                requiredPoints = user.level === 1 ? 0.3 : 0.1;
            } else if (user.level < 20) {
                requiredPoints = 1;
            } else if (user.level < 40) {
                requiredPoints = 3;
            } else if (user.level < 60) {
                requiredPoints = 5;
            }
            
            // 检查积分是否足够
            if (user.points < requiredPoints) {
                alert(`升级需要 ${requiredPoints} 积分，您当前只有 ${user.points.toFixed(2)} 积分`);
                return;
            }
            
            // 升级
            user.level++;
            user.points -= requiredPoints;
            
            // 更新UI
            updateUserUI();
            saveGameData();
            
            alert(`升级成功! 当前等级: ${user.level}`);
        }

        // 开始小游戏
        function startGame(gameName) {
            const user = gameData.currentUser;
            if (!user) return;
            
            // 检查星脉币是否足够
            let cost = 1;
            if (gameName === 'memory') cost = 2;
            else if (gameName === 'quiz') cost = 3;
            else if (gameName === 'escape') cost = 5; // 大逃杀游戏入场费
            
            // VIP折扣
            if (user.isVIP) cost = Math.floor(cost * 0.5);
            
            if (user.coins < cost) {
                alert(`需要 ${cost} 星脉币才能玩这个游戏`);
                return;
            }
            
            // 扣除星脉币
            user.coins -= cost;
            updateUserUI();
            
            // 设置游戏模态框
            elements.gameModalTitle.textContent = getGameTitle(gameName);
            elements.gameModalContent.innerHTML = getGameHTML(gameName);
            
            // 显示模态框
            elements.gameModal.style.display = 'flex';
            
            // 设置游戏逻辑
            setupGameLogic(gameName);
        }

        // 获取游戏标题
        function getGameTitle(gameName) {
            switch (gameName) {
                case 'clicker': return '点击赚积分';
                case 'memory': return '记忆匹配';
                case 'quiz': return '知识问答';
                case 'escape': return '能量石-大谜杀';
                default: return '小游戏';
            }
        }

        // 获取游戏HTML
        function getGameHTML(gameName) {
            switch (gameName) {
                case 'clicker':
                    return `
                        <div style="text-align: center;">
                            <p>点击按钮赚取积分</p>
                            <button id="clicker-btn" style="font-size: 24px; padding: 20px 40px; margin: 20px 0;">点击我!</button>
                            <p>已获得积分: <span id="clicker-points">0</span></p>
                            <p>每次点击获得 0.01 积分</p>
                        </div>
                    `;
                case 'memory':
                    return `
                        <div style="text-align: center;">
                            <h3>记忆匹配游戏</h3>
                            <p>找出所有匹配的卡片</p>
                            <div id="memory-board" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0;"></div>
                            <p>剩余尝试次数: <span id="memory-attempts">10</span></p>
                            <p>已匹配: <span id="memory-matched">0</span>/8</p>
                        </div>
                    `;
                case 'quiz':
                    return `
                        <div style="text-align: center;">
                            <h3>知识问答</h3>
                            <div id="quiz-question" style="font-size: 18px; margin: 20px 0;"></div>
                            <div id="quiz-options" style="display: flex; flex-direction: column; gap: 10px;"></div>
                            <p>当前得分: <span id="quiz-score">0</span></p>
                        </div>
                    `;
                case 'escape':
                    return `
                        <div style="text-align: center;">
                            <h3>能量石-大谜杀</h3>
                            <p>选择一间房间躲避外星人，满足人数后，外星人随机挑选一个房间杀掉里面所有人，其他房间的幸存者平均瓜分被杀掉房间的能量石。</p>
                            
                            <div class="escape-stats">
                                <div class="escape-stat">
                                    <div>当前玩家</div>
                                    <div id="escape-current-players">0</div>
                                </div>
                                <div class="escape-stat">
                                    <div>目标玩家</div>
                                    <div id="escape-target-players">10</div>
                                </div>
                                <div class="escape-stat">
                                    <div>奖池</div>
                                    <div id="escape-prize-pool">0</div>
                                </div>
                            </div>
                            
                            <h4>选择房间躲避外星人</h4>
                            <div class="escape-room" id="escape-rooms">
                                ${gameData.escapeRooms.rooms.map(room => `
                                    <div class="room-card" data-room="${room}">
                                        ${room}
                                        <div class="escape-players" id="room-players-${room}">0人</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="form-group">
                                <label for="escape-bet">投入能量石数量 (1-100)</label>
                                <input type="number" id="escape-bet" min="1" max="100" value="10">
                            </div>
                            
                            <button id="escape-join-btn" class="escape-button">加入游戏</button>
                            <button id="escape-leave-btn" class="escape-button" style="display: none;">离开房间</button>
                            
                            <div id="escape-game-status" style="margin-top: 20px;"></div>
                        </div>
                    `;
                default:
                    return '<p>游戏加载中...</p>';
            }
        }

        // 设置游戏逻辑
        function setupGameLogic(gameName) {
            switch (gameName) {
                case 'clicker':
                    setupClickerGame();
                    break;
                case 'memory':
                    setupMemoryGame();
                    break;
                case 'quiz':
                    setupQuizGame();
                    break;
                case 'escape':
                    setupEscapeGame();
                    break;
            }
        }

        // 设置点击游戏
        function setupClickerGame() {
            let pointsEarned = 0;
            const clickerBtn = document.getElementById('clicker-btn');
            const pointsDisplay = document.getElementById('clicker-points');
            
            clickerBtn.addEventListener('click', () => {
                pointsEarned += 0.01;
                pointsDisplay.textContent = pointsEarned.toFixed(2);
                
                // 随机按钮移动
                if (Math.random() < 0.2) {
                    const x = Math.random() * 100 - 50;
                    const y = Math.random() * 100 - 50;
                    clickerBtn.style.transform = `translate(${x}px, ${y}px)`;
                }
            });
            
            // 游戏结束处理
            elements.gameModal.querySelector('.close-btn').addEventListener('click', () => {
                if (pointsEarned > 0) {
                    gameData.currentUser.points += pointsEarned;
                    updateUserUI();
                    saveGameData();
                    alert(`游戏结束! 获得 ${pointsEarned.toFixed(2)} 积分`);
                }
            });
        }

        // 设置记忆游戏
        function setupMemoryGame() {
            const cards = ['A', 'A', 'B', 'B', 'C', 'C', 'D', 'D', 'E', 'E', 'F', 'F', 'G', 'G', 'H', 'H'];
            let shuffledCards = shuffleArray([...cards]).slice(0, 8 * 2);
            let flippedCards = [];
            let matchedPairs = 0;
            let attempts = 10;
            
            const board = document.getElementById('memory-board');
            const attemptsDisplay = document.getElementById('memory-attempts');
            const matchedDisplay = document.getElementById('memory-matched');
            
            // 创建卡片
            shuffledCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'memory-card';
                cardElement.dataset.index = index;
                cardElement.dataset.value = card;
                cardElement.style.height = '80px';
                cardElement.style.backgroundColor = '#457b9d';
                cardElement.style.display = 'flex';
                cardElement.style.justifyContent = 'center';
                cardElement.style.alignItems = 'center';
                cardElement.style.cursor = 'pointer';
                cardElement.style.color = 'transparent';
                cardElement.style.fontSize = '24px';
                cardElement.style.borderRadius = '5px';
                
                cardElement.textContent = card;
                
                cardElement.addEventListener('click', () => {
                    if (flippedCards.length < 2 && !flippedCards.includes(index) && cardElement.style.color === 'transparent') {
                        flipCard(cardElement);
                    }
                });
                
                board.appendChild(cardElement);
            });
            
            // 翻牌函数
            function flipCard(cardElement) {
                cardElement.style.color = 'white';
                flippedCards.push(parseInt(cardElement.dataset.index));
                
                if (flippedCards.length === 2) {
                    const firstCard = board.children[flippedCards[0]];
                    const secondCard = board.children[flippedCards[1]];
                    
                    if (firstCard.dataset.value === secondCard.dataset.value) {
                        // 匹配成功
                        matchedPairs++;
                        matchedDisplay.textContent = matchedPairs;
                        
                        // 标记为已匹配
                        firstCard.style.backgroundColor = '#2a9d8f';
                        secondCard.style.backgroundColor = '#2a9d8f';
                        
                        flippedCards = [];
                        
                        // 检查是否所有卡片都匹配
                        if (matchedPairs === 8) {
                            setTimeout(() => {
                                gameData.currentUser.points += 1;
                                updateUserUI();
                                saveGameData();
                                alert('恭喜! 你完成了记忆游戏，获得1积分!');
                                elements.gameModal.style.display = 'none';
                            }, 500);
                        }
                    } else {
                        // 匹配失败
                        attempts--;
                        attemptsDisplay.textContent = attempts;
                        
                        setTimeout(() => {
                            firstCard.style.color = 'transparent';
                            secondCard.style.color = 'transparent';
                            flippedCards = [];
                        }, 1000);
                        
                        // 检查是否还有尝试次数
                        if (attempts <= 0) {
                            setTimeout(() => {
                                if (matchedPairs > 0) {
                                    gameData.currentUser.points += matchedPairs * 0.1;
                                    updateUserUI();
                                    saveGameData();
                                    alert(`游戏结束! 你匹配了 ${matchedPairs} 对卡片，获得 ${(matchedPairs * 0.1).toFixed(1)} 积分`);
                                } else {
                                    alert('游戏结束! 没有匹配到任何卡片');
                                }
                                elements.gameModal.style.display = 'none';
                            }, 1000);
                        }
                    }
                }
            }
        }

        // 设置问答游戏
        function setupQuizGame() {
            const questions = [
                {
                    question: "中国的首都是哪里?",
                    options: ["上海", "北京", "广州", "深圳"],
                    answer: 1
                },
                {
                    question: "以下哪个不是编程语言?",
                    options: ["Python", "Java", "HTML", "C++"],
                    answer: 2
                },
                {
                    question: "1 + 1等于多少?",
                    options: ["1", "2", "3", "4"],
                    answer: 1
                }
            ];
            
            let currentQuestion = 0;
            let score = 0;
            
            const questionElement = document.getElementById('quiz-question');
            const optionsElement = document.getElementById('quiz-options');
            const scoreDisplay = document.getElementById('quiz-score');
            
            function showQuestion() {
                if (currentQuestion >= questions.length) {
                    // 游戏结束
                    gameData.currentUser.points += score * 0.2;
                    updateUserUI();
                    saveGameData();
                    alert(`游戏结束! 你的得分是 ${score}，获得 ${(score * 0.2).toFixed(1)} 积分`);
                    elements.gameModal.style.display = 'none';
                    return;
                }
                
                const q = questions[currentQuestion];
                questionElement.textContent = q.question;
                optionsElement.innerHTML = '';
                
                q.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.style.padding = '10px';
                    button.addEventListener('click', () => {
                        checkAnswer(index);
                    });
                    optionsElement.appendChild(button);
                });
            }
            
            function checkAnswer(selectedIndex) {
                const q = questions[currentQuestion];
                if (selectedIndex === q.answer) {
                    score++;
                    scoreDisplay.textContent = score;
                    alert('回答正确!');
                } else {
                    alert(`回答错误! 正确答案是: ${q.options[q.answer]}`);
                }
                
                currentQuestion++;
                showQuestion();
            }
            
            showQuestion();
        }

        // 设置大逃杀游戏
        function setupEscapeGame() {
            const user = gameData.currentUser;
            const roomsContainer = document.getElementById('escape-rooms');
            const joinBtn = document.getElementById('escape-join-btn');
            const leaveBtn = document.getElementById('escape-leave-btn');
            const betInput = document.getElementById('escape-bet');
            const gameStatus = document.getElementById('escape-game-status');
            const currentPlayersDisplay = document.getElementById('escape-current-players');
            const targetPlayersDisplay = document.getElementById('escape-target-players');
            const prizePoolDisplay = document.getElementById('escape-prize-pool');
            
            let selectedRoom = null;
            let currentBet = 10;
            let gameInterval = null;
            
            // 初始化游戏状态
            updateEscapeGameDisplay();
            
            // 房间选择
            roomsContainer.querySelectorAll('.room-card').forEach(card => {
                card.addEventListener('click', () => {
                    if (gameData.escapeRooms.gameInProgress) return;
                    
                    roomsContainer.querySelectorAll('.room-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    card.classList.add('selected');
                    selectedRoom = card.getAttribute('data-room');
                });
            });
            
            // 加入游戏
            joinBtn.addEventListener('click', () => {
                if (!selectedRoom) {
                    alert('请先选择一个房间');
                    return;
                }
                
                currentBet = parseInt(betInput.value);
                if (isNaN(currentBet) || currentBet < 1 || currentBet > 100) {
                    alert('请输入1-100之间的有效数字');
                    return;
                }
                
                if (user.coins < currentBet) {
                    alert('星脉币不足');
                    return;
                }
                
                // 扣除星脉币
                user.coins -= currentBet;
                updateUserUI();
                
                // 加入房间
                if (!gameData.escapeRooms.players[selectedRoom]) {
                    gameData.escapeRooms.players[selectedRoom] = [];
                }
                
                gameData.escapeRooms.players[selectedRoom].push({
                    username: user.username,
                    bet: currentBet
                });
                
                // 更新UI
                joinBtn.style.display = 'none';
                leaveBtn.style.display = 'block';
                betInput.disabled = true;
                gameStatus.textContent = `你已加入 ${selectedRoom}，投入 ${currentBet} 能量石`;
                
                // 开始游戏检查
                checkEscapeGameStart();
                
                saveGameData();
            });
            
            // 离开游戏
            leaveBtn.addEventListener('click', () => {
                if (gameData.escapeRooms.gameInProgress) {
                    alert('游戏已开始，无法离开');
                    return;
                }
                
                // 返还星脉币
                user.coins += currentBet;
                updateUserUI();
                
                // 从房间移除
                if (gameData.escapeRooms.players[selectedRoom]) {
                    gameData.escapeRooms.players[selectedRoom] = gameData.escapeRooms.players[selectedRoom].filter(
                        p => p.username !== user.username
                    );
                    
                    if (gameData.escapeRooms.players[selectedRoom].length === 0) {
                        delete gameData.escapeRooms.players[selectedRoom];
                    }
                }
                
                // 更新UI
                joinBtn.style.display = 'block';
                leaveBtn.style.display = 'none';
                betInput.disabled = false;
                gameStatus.textContent = '你已离开房间';
                selectedRoom = null;
                
                roomsContainer.querySelectorAll('.room-card').forEach(c => {
                    c.classList.remove('selected');
                });
                
                saveGameData();
                updateEscapeGameDisplay();
            });
            
            // 关闭模态框时离开游戏
            elements.gameModal.querySelector('.close-btn').addEventListener('click', () => {
                if (selectedRoom && !gameData.escapeRooms.gameInProgress) {
                    // 模拟点击离开按钮
                    leaveBtn.click();
                }
            });
            
            // 更新游戏显示
            function updateEscapeGameDisplay() {
                // 更新玩家数量
                let totalPlayers = 0;
                let totalPrize = 0;
                
                gameData.escapeRooms.rooms.forEach(room => {
                    const players = gameData.escapeRooms.players[room] || [];
                    const roomPlayersElement = document.getElementById(`room-players-${room}`);
                    if (roomPlayersElement) {
                        roomPlayersElement.textContent = `${players.length}人`;
                    }
                    
                    totalPlayers += players.length;
                    players.forEach(player => {
                        totalPrize += player.bet;
                    });
                });
                
                currentPlayersDisplay.textContent = totalPlayers;
                prizePoolDisplay.textContent = totalPrize;
                
                // 设置目标玩家数量
                const targetPlayers = Math.max(5, Math.ceil(totalPlayers * 1.2));
                targetPlayersDisplay.textContent = targetPlayers;
            }
            
            // 检查游戏是否可以开始
            function checkEscapeGameStart() {
                updateEscapeGameDisplay();
                
                const totalPlayers = parseInt(currentPlayersDisplay.textContent);
                const targetPlayers = parseInt(targetPlayersDisplay.textContent);
                
                if (totalPlayers >= targetPlayers && !gameData.escapeRooms.gameInProgress) {
                    startEscapeGame();
                } else if (!gameData.escapeRooms.gameInProgress) {
                    // 每隔5秒检查一次
                    clearInterval(gameInterval);
                    gameInterval = setInterval(checkEscapeGameStart, 5000);
                }
            }
            
            // 开始游戏
            function startEscapeGame() {
                gameData.escapeRooms.gameInProgress = true;
                clearInterval(gameInterval);
                
                gameStatus.innerHTML = '<p>游戏开始! 外星人正在选择目标房间...</p>';
                
                // 模拟3秒等待
                setTimeout(() => {
                    // 随机选择一个房间作为目标
                    const occupiedRooms = Object.keys(gameData.escapeRooms.players).filter(
                        room => gameData.escapeRooms.players[room].length > 0
                    );
                    
                    if (occupiedRooms.length === 0) {
                        gameStatus.innerHTML = '<p>错误: 没有玩家在房间中</p>';
                        gameData.escapeRooms.gameInProgress = false;
                        return;
                    }
                    
                    const targetRoom = occupiedRooms[Math.floor(Math.random() * occupiedRooms.length)];
                    const killedPlayers = gameData.escapeRooms.players[targetRoom];
                    const totalKilledBet = killedPlayers.reduce((sum, player) => sum + player.bet, 0);
                    
                    // 计算幸存者和奖励
                    const survivors = {};
                    let totalSurvivors = 0;
                    
                    occupiedRooms.forEach(room => {
                        if (room !== targetRoom) {
                            survivors[room] = gameData.escapeRooms.players[room];
                            totalSurvivors += survivors[room].length;
                        }
                    });
                    
                    // 计算每个幸存者获得的奖励 (扣除5%手续费)
                    const rewardPerSurvivor = totalSurvivors > 0 ? 
                        Math.floor(totalKilledBet * 0.95 / totalSurvivors) : 0;
                    
                    // 更新玩家状态
                    let userReward = 0;
                    let userKilled = false;
                    
                    if (selectedRoom === targetRoom) {
                        // 玩家被杀
                        userKilled = true;
                        gameStatus.innerHTML += `<p>外星人选择了 ${targetRoom}! 你被杀死了!</p>`;
                    } else if (survivors[selectedRoom]) {
                        // 玩家幸存
                        userReward = rewardPerSurvivor;
                        gameData.currentUser.coins += userReward;
                        gameStatus.innerHTML += `<p>外星人选择了 ${targetRoom}! 你幸存下来并获得 ${userReward} 能量石!</p>`;
                    }
                    
                    // 更新UI
                    updateUserUI();
                    
                    // 重置游戏状态
                    setTimeout(() => {
                        gameData.escapeRooms.players = {};
                        gameData.escapeRooms.gameInProgress = false;
                        
                        if (selectedRoom) {
                            // 重置玩家状态
                            joinBtn.style.display = 'block';
                            leaveBtn.style.display = 'none';
                            betInput.disabled = false;
                            selectedRoom = null;
                            
                            roomsContainer.querySelectorAll('.room-card').forEach(c => {
                                c.classList.remove('selected');
                            });
                        }
                        
                        updateEscapeGameDisplay();
                        gameStatus.innerHTML += '<p>游戏结束! 可以开始新一局游戏</p>';
                    }, 5000);
                    
                    saveGameData();
                }, 3000);
            }
        }

        // 复制邀请链接
        function copyInviteLink() {
            const user = gameData.currentUser;
            if (!user) return;
            
            const inviteLink = `${window.location.origin}${window.location.pathname}?invite=${user.inviteCode}`;
            
            navigator.clipboard.writeText(inviteLink).then(() => {
                alert('邀请链接已复制到剪贴板!');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制邀请码');
            });
        }

        // 申请VIP
        function applyForVIP() {
            const user = gameData.currentUser;
            if (!user) return;
            
            if (user.isVIP) {
                alert('您已经是VIP会员!');
                return;
            }
            
            if (user.vipRequested) {
                alert('您已经提交过VIP申请，请等待管理员处理');
                return;
            }
            
            if (confirm('确定要申请VIP会员吗? 费用为32元')) {
                user.vipRequested = true;
                gameData.vipRequests.push({
                    username: user.username,
                    date: new Date().toISOString(),
                    status: 'pending'
                });
                
                saveGameData();
                alert('VIP申请已提交，请支付并等待管理员审核');
            }
        }

        // 提交提现申请
        function submitWithdrawRequest() {
            const user = gameData.currentUser;
            if (!user) return;
            
            const amount = parseFloat(elements.withdrawAmount.value);
            const method = elements.withdrawMethod.value;
            const account = elements.withdrawAccount.value.trim();
            
            if (isNaN(amount)) {
                alert('请输入有效的提现金额');
                return;
            }
            
            // 检查最低提现金额
            if (amount < 100) {
                alert('最低提现金额为100星脉币');
                return;
            }
            
            // 检查是否有足够的星脉币
            if (amount > user.coins) {
                alert('星脉币不足');
                return;
            }
            
            if (!account) {
                alert('请输入收款账号');
                return;
            }
            
            // 计算手续费
            const feeRate = user.isVIP ? 0.05 : 0.1;
            const fee = amount * feeRate;
            const received = amount - fee;
            
            if (confirm(`确定要提现 ${amount} 星脉币吗?\n手续费: ${fee.toFixed(2)} (${feeRate * 100}%)\n实际到账: ${received.toFixed(2)}`)) {
                // 扣除星脉币
                user.coins -= amount;
                
                // 添加提现记录
                user.withdrawHistory.push({
                    amount,
                    fee,
                    received,
                    method,
                    account,
                    date: new Date().toISOString(),
                    status: 'pending'
                });
                
                // 添加到管理员队列
                gameData.withdrawRequests.push({
                    username: user.username,
                    amount,
                    method,
                    account,
                    date: new Date().toISOString(),
                    status: 'pending'
                });
                
                // 更新UI
                updateUserUI();
                saveGameData();
                
                alert('提现申请已提交，将在24小时内处理');
                elements.withdrawAmount.value = '';
                elements.withdrawAccount.value = '';
            }
        }

        // 加载管理员数据
        function loadAdminData() {
            // 加载VIP申请
            elements.vipRequests.innerHTML = '';
            gameData.vipRequests.forEach(request => {
                if (request.status === 'pending') {
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    li.innerHTML = `
                        <span>${request.username} - ${new Date(request.date).toLocaleString()}</span>
                        <div>
                            <button class="approve-vip" data-user="${request.username}">批准</button>
                            <button class="reject-vip" data-user="${request.username}">拒绝</button>
                        </div>
                    `;
                    elements.vipRequests.appendChild(li);
                }
            });
            
            // 加载提现申请
            elements.withdrawRequests.innerHTML = '';
            gameData.withdrawRequests.forEach(request => {
                if (request.status === 'pending') {
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    li.innerHTML = `
                        <span>${request.username} - ${request.amount}星脉币 (${request.method})</span>
                        <div>
                            <button class="approve-withdraw" data-user="${request.username}" data-amount="${request.amount}">批准</button>
                            <button class="reject-withdraw" data-user="${request.username}" data-amount="${request.amount}">拒绝</button>
                        </div>
                    `;
                    elements.withdrawRequests.appendChild(li);
                }
            });
            
            // 加载用户列表
            searchUsers();
            
            // 加载公告
            elements.announcementEdit.value = gameData.announcements.join('\n');
            
            // 添加按钮事件
            document.querySelectorAll('.approve-vip').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    approveVIP(username);
                });
            });
            
            document.querySelectorAll('.reject-vip').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    rejectVIP(username);
                });
            });
            
            document.querySelectorAll('.approve-withdraw').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    const amount = parseFloat(e.target.getAttribute('data-amount'));
                    approveWithdraw(username, amount);
                });
            });
            
            document.querySelectorAll('.reject-withdraw').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    const amount = parseFloat(e.target.getAttribute('data-amount'));
                    rejectWithdraw(username, amount);
                });
            });
        }

        // 搜索用户
        function searchUsers() {
            const searchTerm = elements.searchUser.value.toLowerCase();
            elements.userList.innerHTML = '';
            
            for (const username in gameData.users) {
                if (username.toLowerCase().includes(searchTerm)) {
                    const user = gameData.users[username];
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    li.innerHTML = `
                        <span>${username} - 等级${user.level} - ${user.isVIP ? 'VIP' : '普通用户'}</span>
                        <div>
                            <button class="add-vip" data-user="${username}">${user.isVIP ? '取消VIP' : '设为VIP'}</button>
                            <button class="add-coins" data-user="${username}">加星脉币</button>
                        </div>
                    `;
                    elements.userList.appendChild(li);
                }
            }
            
            // 添加按钮事件
            document.querySelectorAll('.add-vip').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    toggleVIP(username);
                });
            });
            
            document.querySelectorAll('.add-coins').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-user');
                    const amount = prompt(`为 ${username} 添加多少星脉币?`, "10");
                    if (amount && !isNaN(parseInt(amount))) {
                        addCoins(username, parseInt(amount));
                    }
                });
            });
        }

        // 批准VIP
        function approveVIP(username) {
            if (gameData.users[username]) {
                gameData.users[username].isVIP = true;
                gameData.users[username].vipRequested = false;
                
                // 更新申请状态
                gameData.vipRequests = gameData.vipRequests.map(req => {
                    if (req.username === username && req.status === 'pending') {
                        return { ...req, status: 'approved' };
                    }
                    return req;
                });
                
                saveGameData();
                loadAdminData();
                alert(`已批准 ${username} 的VIP申请`);
            }
        }

        // 拒绝VIP
        function rejectVIP(username) {
            if (gameData.users[username]) {
                gameData.users[username].vipRequested = false;
                
                // 更新申请状态
                gameData.vipRequests = gameData.vipRequests.map(req => {
                    if (req.username === username && req.status === 'pending') {
                        return { ...req, status: 'rejected' };
                    }
                    return req;
                });
                
                saveGameData();
                loadAdminData();
                alert(`已拒绝 ${username} 的VIP申请`);
            }
        }

        // 批准提现
        function approveWithdraw(username, amount) {
            if (gameData.users[username]) {
                // 更新用户提现记录
                gameData.users[username].withdrawHistory = gameData.users[username].withdrawHistory.map(wd => {
                    if (wd.status === 'pending' && wd.amount === amount) {
                        return { ...wd, status: 'approved' };
                    }
                    return wd;
                });
                
                // 更新提现申请状态
                gameData.withdrawRequests = gameData.withdrawRequests.map(req => {
                    if (req.username === username && req.amount === amount && req.status === 'pending') {
                        return { ...req, status: 'approved' };
                    }
                    return req;
                });
                
                saveGameData();
                loadAdminData();
                alert(`已批准 ${username} 的 ${amount} 星脉币提现申请`);
            }
        }

        // 拒绝提现
        function rejectWithdraw(username, amount) {
            if (gameData.users[username]) {
                // 返还星脉币
                gameData.users[username].coins += amount;
                
                // 更新用户提现记录
                gameData.users[username].withdrawHistory = gameData.users[username].withdrawHistory.map(wd => {
                    if (wd.status === 'pending' && wd.amount === amount) {
                        return { ...wd, status: 'rejected' };
                    }
                    return wd;
                });
                
                // 更新提现申请状态
                gameData.withdrawRequests = gameData.withdrawRequests.map(req => {
                    if (req.username === username && req.amount === amount && req.status === 'pending') {
                        return { ...req, status: 'rejected' };
                    }
                    return req;
                });
                
                saveGameData();
                loadAdminData();
                alert(`已拒绝 ${username} 的 ${amount} 星脉币提现申请，星脉币已返还`);
            }
        }

        // 切换VIP状态
        function toggleVIP(username) {
            if (gameData.users[username]) {
                gameData.users[username].isVIP = !gameData.users[username].isVIP;
                gameData.users[username].vipRequested = false;
                
                // 如果是批准VIP，从申请列表中移除
                gameData.vipRequests = gameData.vipRequests.filter(req => 
                    !(req.username === username && req.status === 'pending')
                );
                
                saveGameData();
                searchUsers();
                alert(`${username} 的VIP状态已更新`);
            }
        }

        // 添加星脉币
        function addCoins(username, amount) {
            if (gameData.users[username] && amount > 0) {
                gameData.users[username].coins += amount;
                saveGameData();
                searchUsers();
                alert(`已为 ${username} 添加 ${amount} 星脉币`);
            }
        }

        // 保存管理员设置
        function saveAdminSettings() {
            const newAnnouncements = elements.announcementEdit.value.split('\n').filter(line => line.trim());
            gameData.announcements = newAnnouncements;
            
            saveGameData();
            alert('设置已保存');
        }

        // 保存游戏数据
        function saveGameData() {
            localStorage.setItem('pmGameData', JSON.stringify(gameData));
        }

        // 辅助函数: 打乱数组
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 初始化游戏
        window.onload = initGame;
    </script>
</body>
</html>
