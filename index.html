<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级搬砖人生</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 登录/注册样式 */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
        }
        
        .auth-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 400px;
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        .auth-form .form-group {
            margin-bottom: 15px;
        }
        
        .auth-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .auth-form input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .auth-form button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .auth-form button:hover {
            background: #45a049;
        }
        
        .auth-switch {
            text-align: center;
            margin-top: 15px;
        }
        
        .auth-switch a {
            color: #4CAF50;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* 主界面样式 */
        .main-container {
            display: none;
        }
        
        header {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info span {
            margin-right: 15px;
            font-weight: bold;
        }
        
        .server-time {
            font-size: 14px;
        }
        
        .announcement {
            background: #fff8e1;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
        }
        
        .main-menu {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .menu-btn {
            padding: 20px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        
        /* 内容区域样式 */
        .content-area {
            background: white;
            padding: 20px;
            border-radius: 10px;
            min-height: 400px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        /* 升级功能样式 */
        .upgrade-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .upgrade-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .upgrade-level {
            font-size: 24px;
            font-weight: bold;
            color: #6e8efb;
        }
        
        .upgrade-reward {
            margin: 10px 0;
        }
        
        .upgrade-btn {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .upgrade-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* 小游戏样式 */
        .games-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .game-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
        }
        
        .game-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        /* 交易市场样式 */
        .market-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .market-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
        }
        
        .market-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }
        
        .market-info {
            flex: 1;
        }
        
        .market-price {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .market-btn {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* 会员中心样式 */
        .vip-container {
            text-align: center;
        }
        
        .vip-card {
            background: linear-gradient(135deg, #f6d365, #fda085);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 500px;
        }
        
        .vip-title {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .vip-price {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .vip-benefits {
            text-align: left;
            margin-bottom: 20px;
        }
        
        .vip-benefits li {
            margin-bottom: 10px;
        }
        
        .vip-btn {
            padding: 12px 30px;
            background: white;
            color: #fda085;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* 提现功能样式 */
        .withdraw-container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .withdraw-form .form-group {
            margin-bottom: 15px;
        }
        
        .withdraw-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .withdraw-form input, .withdraw-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .withdraw-form button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* 排行榜样式 */
        .rank-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .rank-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .rank-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .rank-tab.active {
            border-bottom: 3px solid #4CAF50;
            font-weight: bold;
        }
        
        .rank-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .rank-table th, .rank-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .rank-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
        
        .rank-table tr:nth-child(1) {
            background: gold;
        }
        
        .rank-table tr:nth-child(2) {
            background: silver;
        }
        
        .rank-table tr:nth-child(3) {
            background: #cd7f32;
        }
        
        /* 大逃杀游戏样式 */
        .escape-game-container {
            display: none;
        }
        
        .escape-rooms {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .escape-room {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
        }
        
        .escape-room:hover {
            background: #e9e9e9;
        }
        
        .escape-selected {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        .escape-start-btn {
            padding: 12px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        /* 支付弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
        }
        
        .payment-methods {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .payment-method {
            text-align: center;
            cursor: pointer;
        }
        
        .payment-method img {
            width: 120px;
            height: 120px;
            object-fit: contain;
        }
        
        /* 挂机功能样式 */
        .afk-container {
            text-align: center;
            margin-top: 30px;
        }
        
        .afk-btn {
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }
        
        .afk-timer {
            margin-top: 15px;
            font-size: 16px;
        }
        
        /* 管理员样式 */
        .admin-container {
            display: none;
        }
        
        .admin-controls {
            margin-bottom: 20px;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .admin-table th, .admin-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .admin-table th {
            background: #f5f5f5;
        }
        
        .admin-form {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        /* 返回按钮样式 */
        .back-btn {
            padding: 8px 15px;
            background: #6e8efb;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-menu {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .upgrade-container, .games-container, .market-container {
                grid-template-columns: 1fr;
            }
            
            .escape-rooms {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                width: 90%;
            }
            
            header {
                flex-direction: column;
                text-align: center;
            }
            
            .user-info {
                margin-bottom: 10px;
            }
        }
        
        /* 封禁用户样式 */
        .banned-user {
            color: #e74c3c;
            font-weight: bold;
        }
        
        /* 游戏奖励弹窗 */
        .reward-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            text-align: center;
        }
        
        .reward-popup h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        .reward-popup button {
            margin-top: 15px;
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* 游戏界面样式 */
        .game-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .game-board {
            display: inline-block;
            margin: 20px auto;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
        }
        
        .game-button {
            padding: 10px 20px;
            margin: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* 上传图片样式 */
        .upload-container {
            margin: 20px 0;
        }
        
        .upload-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            display: none;
        }
        
        /* 加载指示器 */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 登录/注册容器 -->
    <div class="auth-container" id="auth-container">
        <div class="auth-box">
            <h2 class="auth-title" id="auth-title">用户登录</h2>
            <form class="auth-form" id="auth-form">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" placeholder="请输入用户名" required>
                </div>
                <div class="form-group">
                    <label for="password">密码</label>
                    <input type="password" id="password" placeholder="请输入密码" required>
                </div>
                <div class="form-group" id="invite-group" style="display: none;">
                    <label for="invite-code">邀请码(可选)</label>
                    <input type="text" id="invite-code" placeholder="请输入邀请码">
                </div>
                <div class="form-group" id="admin-group" style="display: none;">
                    <label for="admin-code">管理员代码</label>
                    <input type="password" id="admin-code" placeholder="仅管理员需要填写">
                </div>
                <button type="submit" id="auth-submit">登录</button>
            </form>
            <div class="auth-switch">
                <a id="switch-auth">没有账号？立即注册</a>
            </div>
            <div class="auth-switch">
                <a id="switch-admin">管理员登录</a>
            </div>
            <div id="auth-loading" class="loader" style="display: none;"></div>
        </div>
    </div>
    
    <!-- 主界面容器 -->
    <div class="container main-container" id="main-container">
        <header>
            <div class="user-info">
                <span id="display-username">用户昵称</span>
                <span id="user-level">Lv.1</span>
                <span id="brick-count">砖块: 0.3</span>
                <span id="star-coin-count">人脉币: 0</span>
            </div>
            <div class="server-time">
                开服时间: 2025-5-1 00:00:00 | 已运行: <span id="uptime">0天0时0分</span>
            </div>
        </header>
        
        <div class="announcement" id="announcement">
            <strong>公告:</strong> <span id="announcement-text">欢迎来到高级搬砖人生！邀请好友升级到5级可获得888红包</span>
        </div>
        
        <nav class="main-menu">
            <button class="menu-btn" id="upgrade-btn">升级功能</button>
            <button class="menu-btn" id="games-btn">小游戏</button>
            <button class="menu-btn" id="market-btn">交易市场</button>
            <button class="menu-btn" id="vip-btn">会员中心</button>
            <button class="menu-btn" id="withdraw-btn">提现功能</button>
            <button class="menu-btn" id="rank-btn">排行榜</button>
            <button class="menu-btn" id="escape-btn">大逃杀游戏</button>
            <button class="menu-btn" id="afk-btn">挂机赚币</button>
        </nav>
        
        <div class="content-area" id="content-area">
            <!-- 内容区域将通过JavaScript动态加载 -->
            <h2 class="section-title">欢迎来到高级搬砖人生</h2>
            <p>请从上方菜单选择功能</p>
        </div>
    </div>
    
    <!-- 大逃杀游戏容器 -->
    <div class="container escape-game-container" id="escape-game-container">
        <button class="back-btn" onclick="backToMain()">返回主界面</button>
        <h2 class="section-title">能量石-大谜杀玩法</h2>
        <p>玩家选择一间房间躲避外星人，满足人数后，外星人随机挑选一个房间杀掉里面所有人，其他房间的幸存者平均瓜分被杀掉房间的能量石。</p>
        
        <div class="escape-rooms" id="escape-rooms">
            <!-- 房间将通过JavaScript动态生成 -->
        </div>
        
        <div class="form-group">
            <label for="energy-stones">投入能量石数量:</label>
            <input type="number" id="energy-stones" min="1" value="10">
        </div>
        
        <button class="escape-start-btn" id="escape-start-btn">开始游戏</button>
        
        <div id="escape-result" style="margin-top: 20px;"></div>
    </div>
    
    <!-- 管理员界面 -->
    <div class="container admin-container" id="admin-container">
        <button class="back-btn" onclick="backToMain()">返回主界面</button>
        <h2 class="section-title">管理员控制面板</h2>
        
        <div class="admin-controls">
            <button onclick="loadAdminContent('users')">用户管理</button>
            <button onclick="loadAdminContent('withdraw')">提现申请</button>
            <button onclick="loadAdminContent('vip')">VIP申请</button>
            <button onclick="loadAdminContent('settings')">系统设置</button>
        </div>
        
        <div class="content-area" id="admin-content">
            <!-- 管理员内容区域将通过JavaScript动态加载 -->
            <p>请从上方选择管理功能</p>
        </div>
    </div>
    
    <!-- 支付弹窗 -->
    <div class="modal" id="payment-modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <h2>支付会员费用</h2>
            <p>会员费用: 32元</p>
            
            <div class="payment-methods">
                <div class="payment-method" id="alipay-method">
                    <img id="alipay-qrcode" src="" alt="支付宝" class="upload-preview">
                    <p>支付宝</p>
                    <div class="upload-container">
                        <input type="file" id="alipay-upload" accept="image/*" style="display: none;">
                        <button onclick="document.getElementById('alipay-upload').click()">上传二维码</button>
                    </div>
                </div>
                <div class="payment-method" id="wechat-method">
                    <img id="wechat-qrcode" src="" alt="微信" class="upload-preview">
                    <p>微信支付</p>
                    <div class="upload-container">
                        <input type="file" id="wechat-upload" accept="image/*" style="display: none;">
                        <button onclick="document.getElementById('wechat-upload').click()">上传二维码</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="submitVipApplication()">我已付款</button>
                <button onclick="document.getElementById('payment-modal').style.display = 'none'">取消</button>
            </div>
            
            <p style="margin-top: 15px;">付款后请点击"我已付款"按钮提交申请</p>
        </div>
    </div>
    
    <!-- 游戏奖励弹窗 -->
    <div class="reward-popup" id="reward-popup" style="display: none;">
        <h3 id="reward-title">游戏奖励</h3>
        <p id="reward-message">恭喜您获得了10人脉币！</p>
        <button onclick="document.getElementById('reward-popup').style.display = 'none'">确定</button>
    </div>
    
    <!-- 游戏容器 -->
    <div class="container game-container" id="game-container" style="display: none;">
        <button class="back-btn" onclick="backToMainFromGame()">返回</button>
        <div id="game-content">
            <!-- 游戏内容将通过JavaScript动态加载 -->
        </div>
    </div>
    
    <script>
        // 游戏数据
        const gameData = {
            users: [],
            currentUser: null,
            isLogin: false,
            isRegister: false,
            isAdmin: false,
            adminCode: "admin123", // 管理员密码
            serverStartTime: new Date('2025-05-01T00:00:00'),
            announcement: "欢迎来到高级搬砖人生！邀请好友升级到5级可获得888红包",
            paymentQRCodes: {
                alipay: "",
                wechat: ""
            },
            rooms: [
                "量茶间", "太憩舱", "航指室", "星沙龙", "星洁室", "星悠室",
                "里空间", "音乐舱", "里悠室"
            ],
            vipBenefits: [
                "每日额外获得5个人脉币",
                "升级所需砖块减少10%",
                "提现手续费降低50%",
                "参与大逃杀游戏初始能量石+10",
                "专属客服支持"
            ],
            games: [
                { 
                    id: 1, 
                    name: "猜数字", 
                    description: "猜一个1-100之间的数字，猜中即可获得奖励",
                    reward: "1-5人脉币", 
                    difficulty: "简单", 
                    cost: 0 
                },
                { 
                    id: 2, 
                    name: "剪刀石头布", 
                    description: "与电脑对战，三局两胜",
                    reward: "2-6人脉币", 
                    difficulty: "中等", 
                    cost: 1 
                },
                { 
                    id: 3, 
                    name: "记忆翻牌", 
                    description: "翻开卡片匹配相同的图案",
                    reward: "3-9人脉币", 
                    difficulty: "困难", 
                    cost: 2 
                }
            ],
            marketItems: [
                { id: 1, name: "砖块礼包", price: 5, amount: "10砖块" },
                { id: 2, name: "人脉礼包", price: 50, amount: "1砖块" },
                { id: 3, name: "会员体验卡", price: 10, amount: "1天会员" },
                { id: 4, name: "升级加速器", price: 3, amount: "升级时间减半" }
            ],
            withdrawRate: 0.9, // 提现比例 1砖块=0.9元
            withdrawApplications: [],
            vipApplications: [],
            afkRewardRate: 5, // 每小时获得5人脉币
            afkTimers: {},
            bannedUsers: [], // 封禁用户列表
            currentGame: null // 当前正在玩的游戏
        };
        
        // 增强的远程数据库模拟
        const remoteDB = {
            // 使用localStorage作为基础，模拟远程存储
            storage: {},
            
            // 获取所有设备上的用户数据
            getAllUsers: async function() {
                try {
                    // 尝试从服务器获取数据（模拟）
                    const serverResponse = await this.mockServerRequest('getAllUsers');
                    if (serverResponse && serverResponse.users) {
                        return serverResponse.users;
                    }
                } catch (e) {
                    console.log('无法连接服务器，使用本地数据');
                }
                
                // 从本地存储获取数据
                const localUsers = JSON.parse(localStorage.getItem('gameUsers')) || [];
                
                // 合并来自不同设备的数据
                const device1Users = JSON.parse(localStorage.getItem('device1_users')) || [];
                const device2Users = JSON.parse(localStorage.getItem('device2_users')) || [];
                
                // 合并所有用户，去除重复
                const allUsers = [...localUsers];
                
                device1Users.forEach(user => {
                    if (!allUsers.some(u => u.id === user.id)) {
                        allUsers.push(user);
                    }
                });
                
                device2Users.forEach(user => {
                    if (!allUsers.some(u => u.id === user.id)) {
                        allUsers.push(user);
                    }
                });
                
                return allUsers;
            },
            
            // 保存用户数据到所有设备
            saveAllUsers: async function(users) {
                // 保存到本地存储
                localStorage.setItem('gameUsers', JSON.stringify(users));
                
                try {
                    // 尝试同步到服务器（模拟）
                    await this.mockServerRequest('saveAllUsers', {users});
                } catch (e) {
                    console.log('无法连接服务器，仅保存到本地');
                }
                
                // 触发数据同步事件
                this.triggerDataSync();
            },
            
            // 获取特定键的数据
            getItem: async function(key) {
                // 对于用户数据，使用特殊处理
                if (key === 'gameUsers') {
                    return this.getAllUsers();
                }
                
                // 其他数据正常处理
                try {
                    const serverResponse = await this.mockServerRequest('getItem', {key});
                    if (serverResponse && serverResponse.value) {
                        return serverResponse.value;
                    }
                } catch (e) {
                    console.log('无法连接服务器，使用本地数据');
                }
                
                return JSON.parse(localStorage.getItem(key));
            },
            
            // 设置特定键的数据
            setItem: async function(key, value) {
                // 对于用户数据，使用特殊处理
                if (key === 'gameUsers') {
                    return this.saveAllUsers(value);
                }
                
                // 保存到本地存储
                localStorage.setItem(key, JSON.stringify(value));
                
                try {
                    // 尝试同步到服务器（模拟）
                    await this.mockServerRequest('setItem', {key, value});
                } catch (e) {
                    console.log('无法连接服务器，仅保存到本地');
                }
                
                // 触发数据同步事件
                this.triggerDataSync();
                
                return true;
            },
            
            // 模拟服务器请求
            mockServerRequest: function(action, data = {}) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // 模拟服务器响应
                        if (Math.random() > 0.2) { // 80%成功率
                            if (action === 'getAllUsers') {
                                // 模拟从服务器获取所有用户
                                const serverUsers = JSON.parse(localStorage.getItem('server_users')) || [];
                                resolve({users: serverUsers});
                            } else if (action === 'saveAllUsers') {
                                // 模拟保存用户到服务器
                                localStorage.setItem('server_users', JSON.stringify(data.users));
                                resolve({success: true});
                            } else if (action === 'getItem') {
                                const value = JSON.parse(localStorage.getItem(data.key));
                                resolve({value});
                            } else if (action === 'setItem') {
                                localStorage.setItem(data.key, JSON.stringify(data.value));
                                resolve({success: true});
                            }
                        } else {
                            reject(new Error('模拟服务器错误'));
                        }
                    }, 300);
                });
            },
            
            // 触发数据同步事件
            triggerDataSync: function() {
                // 在实际应用中，这里应该通知所有设备数据已更新
                // 我们使用storage事件来模拟
                const event = new Event('storage');
                window.dispatchEvent(event);
            },
            
            // 初始化数据同步
            initDataSync: function() {
                // 监听storage事件以实现多设备同步
                window.addEventListener('storage', function(e) {
                    if (e.key === 'gameUsers' && gameData.currentUser) {
                        // 重新加载用户数据
                        remoteDB.getAllUsers().then(users => {
                            gameData.users = users;
                            
                            // 更新当前用户
                            const user = users.find(u => u.id === gameData.currentUser.id);
                            if (user) {
                                gameData.currentUser = user;
                                updateUserInfo();
                            }
                        });
                    }
                });
            }
        };
        
        // DOM元素
        const authContainer = document.getElementById('auth-container');
        const mainContainer = document.getElementById('main-container');
        const escapeGameContainer = document.getElementById('escape-game-container');
        const adminContainer = document.getElementById('admin-container');
        const gameContainer = document.getElementById('game-container');
        const authTitle = document.getElementById('auth-title');
        const authForm = document.getElementById('auth-form');
        const authSubmit = document.getElementById('auth-submit');
        const switchAuth = document.getElementById('switch-auth');
        const switchAdmin = document.getElementById('switch-admin');
        const inviteGroup = document.getElementById('invite-group');
        const adminGroup = document.getElementById('admin-group');
        const contentArea = document.getElementById('content-area');
        const adminContent = document.getElementById('admin-content');
        const gameContent = document.getElementById('game-content');
        const displayUsername = document.getElementById('display-username');
        const userLevel = document.getElementById('user-level');
        const brickCount = document.getElementById('brick-count');
        const starCoinCount = document.getElementById('star-coin-count');
        const uptime = document.getElementById('uptime');
        const announcementText = document.getElementById('announcement-text');
        const rewardPopup = document.getElementById('reward-popup');
        const rewardTitle = document.getElementById('reward-title');
        const rewardMessage = document.getElementById('reward-message');
        const alipayQRCode = document.getElementById('alipay-qrcode');
        const wechatQRCode = document.getElementById('wechat-qrcode');
        const authLoading = document.getElementById('auth-loading');
        
        // 菜单按钮
        const upgradeBtn = document.getElementById('upgrade-btn');
        const gamesBtn = document.getElementById('games-btn');
        const marketBtn = document.getElementById('market-btn');
        const vipBtn = document.getElementById('vip-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const rankBtn = document.getElementById('rank-btn');
        const escapeBtn = document.getElementById('escape-btn');
        const afkBtn = document.getElementById('afk-btn');
        
        // 支付相关
        const paymentModal = document.getElementById('payment-modal');
        const closeModal = document.getElementById('close-modal');
        const alipayMethod = document.getElementById('alipay-method');
        const wechatMethod = document.getElementById('wechat-method');
        
        // 大逃杀游戏相关
        const escapeRooms = document.getElementById('escape-rooms');
        const escapeStartBtn = document.getElementById('escape-start-btn');
        const energyStones = document.getElementById('energy-stones');
        const escapeResult = document.getElementById('escape-result');
        
        // 初始化函数
        async function init() {
            // 初始化数据同步
            remoteDB.initDataSync();
            
            // 从远程加载数据
            try {
                authLoading.style.display = 'block';
                
                gameData.users = await remoteDB.getItem('gameUsers') || [];
                gameData.withdrawApplications = await remoteDB.getItem('withdrawApplications') || [];
                gameData.vipApplications = await remoteDB.getItem('vipApplications') || [];
                
                const settings = await remoteDB.getItem('gameSettings');
                if (settings) {
                    gameData.announcement = settings.announcement || gameData.announcement;
                    gameData.paymentQRCodes = settings.paymentQRCodes || gameData.paymentQRCodes;
                    gameData.adminCode = settings.adminCode || gameData.adminCode;
                    gameData.bannedUsers = settings.bannedUsers || gameData.bannedUsers;
                    gameData.withdrawRate = settings.withdrawRate || gameData.withdrawRate;
                    
                    if (gameData.paymentQRCodes.alipay) {
                        alipayQRCode.src = gameData.paymentQRCodes.alipay;
                        alipayQRCode.style.display = 'block';
                    }
                    if (gameData.paymentQRCodes.wechat) {
                        wechatQRCode.src = gameData.paymentQRCodes.wechat;
                        wechatQRCode.style.display = 'block';
                    }
                }
                
                // 设置公告
                announcementText.textContent = gameData.announcement;
                
                // 设置事件监听器
                setupEventListeners();
                
                // 更新服务器运行时间
                updateUptime();
                setInterval(updateUptime, 1000);
                
                // 恢复挂机计时器
                restoreAfkTimers();
                
                // 设置图片上传事件
                document.getElementById('alipay-upload').addEventListener('change', function(e) {
                    handleImageUpload(e, 'alipay');
                });
                
                document.getElementById('wechat-upload').addEventListener('change', function(e) {
                    handleImageUpload(e, 'wechat');
                });
                
            } catch (error) {
                console.error('初始化失败:', error);
                alert('初始化数据失败，请刷新页面重试');
            } finally {
                authLoading.style.display = 'none';
            }
        }
        
        // 处理图片上传
        function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(`${type}-qrcode`);
                img.src = e.target.result;
                img.style.display = 'block';
                
                // 保存到游戏数据
                gameData.paymentQRCodes[type] = e.target.result;
                saveSettings();
            };
            reader.readAsDataURL(file);
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 登录/注册/管理员切换
            switchAuth.addEventListener('click', toggleAuthMode);
            switchAdmin.addEventListener('click', toggleAdminMode);
            
            // 表单提交
            authForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (gameData.isAdmin) {
                    adminLogin();
                } else if (gameData.isRegister) {
                    registerUser();
                } else {
                    loginUser();
                }
                return false;
            });
            
            // 菜单按钮点击
            upgradeBtn.addEventListener('click', () => loadContent('upgrade'));
            gamesBtn.addEventListener('click', () => loadContent('games'));
            marketBtn.addEventListener('click', () => loadContent('market'));
            vipBtn.addEventListener('click', () => loadContent('vip'));
            withdrawBtn.addEventListener('click', () => loadContent('withdraw'));
            rankBtn.addEventListener('click', () => loadContent('rank'));
            escapeBtn.addEventListener('click', showEscapeGame);
            afkBtn.addEventListener('click', () => loadContent('afk'));
            
            // 支付相关
            closeModal.addEventListener('click', () => paymentModal.style.display = 'none');
            
            // 大逃杀游戏
            escapeStartBtn.addEventListener('click', startEscapeGame);
            
            // 窗口点击关闭模态框
            window.addEventListener('click', function(e) {
                if (e.target === paymentModal) {
                    paymentModal.style.display = 'none';
                }
                if (e.target === rewardPopup) {
                    rewardPopup.style.display = 'none';
                }
            });
        }
        
        // 切换登录/注册模式
        function toggleAuthMode() {
            gameData.isRegister = !gameData.isRegister;
            gameData.isAdmin = false;
            
            if (gameData.isRegister) {
                authTitle.textContent = '用户注册';
                authSubmit.textContent = '注册';
                switchAuth.textContent = '已有账号？立即登录';
                inviteGroup.style.display = 'block';
                adminGroup.style.display = 'none';
                switchAdmin.style.display = 'block';
            } else {
                authTitle.textContent = '用户登录';
                authSubmit.textContent = '登录';
                switchAuth.textContent = '没有账号？立即注册';
                inviteGroup.style.display = 'none';
                adminGroup.style.display = 'none';
                switchAdmin.style.display = 'block';
            }
        }
        
        // 切换管理员模式
        function toggleAdminMode() {
            gameData.isAdmin = !gameData.isAdmin;
            gameData.isRegister = false;
            
            if (gameData.isAdmin) {
                authTitle.textContent = '管理员登录';
                authSubmit.textContent = '登录';
                switchAuth.textContent = '用户登录';
                inviteGroup.style.display = 'none';
                adminGroup.style.display = 'block';
                switchAdmin.style.display = 'none';
            } else {
                authTitle.textContent = '用户登录';
                authSubmit.textContent = '登录';
                switchAuth.textContent = '没有账号？立即注册';
                inviteGroup.style.display = 'none';
                adminGroup.style.display = 'none';
                switchAdmin.style.display = 'block';
            }
        }
        
        // 注册用户
        async function registerUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const inviteCode = document.getElementById('invite-code').value;
            
            // 检查是否被封禁
            if (gameData.bannedUsers.includes(username)) {
                alert('该用户名已被封禁，无法注册');
                return;
            }
            
            // 简单验证
            if (!username || !password) {
                alert('请输入用户名和密码');
                return;
            }
            
            // 检查用户名是否已存在
            if (gameData.users.some(user => user.username === username)) {
                alert('用户名已存在');
                return;
            }
            
            // 创建新用户
            const newUser = {
                id: Date.now(),
                username,
                password,
                level: 1,
                bricks: 0.3,
                starCoins: 0,
                vip: false,
                vipExpire: null,
                inviteCode: generateInviteCode(),
                invitedBy: inviteCode || null,
                invitedUsers: 0,
                lastUpgradeTime: null,
                lastWithdrawTime: null,
                lastEscapeGameTime: null,
                lastAfkTime: null,
                afkHours: 0,
                totalWithdrawn: 0,
                totalEarned: 0,
                isAdmin: false,
                isBanned: false,
                device: navigator.userAgent // 记录注册设备信息
            };
            
            // 如果有邀请人，增加邀请人的邀请计数
            if (inviteCode) {
                const inviter = gameData.users.find(u => u.inviteCode === inviteCode);
                if (inviter) {
                    inviter.invitedUsers++;
                    await saveUsers();
                }
            }
            
            gameData.users.push(newUser);
            await saveUsers();
            
            alert('注册成功！您的邀请码是: ' + newUser.inviteCode);
            loginUser();
        }
        
        // 登录用户
        function loginUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // 简单验证
            if (!username || !password) {
                alert('请输入用户名和密码');
                return;
            }
            
            // 检查是否被封禁
            if (gameData.bannedUsers.includes(username)) {
                alert('该账号已被封禁，无法登录');
                return;
            }
            
            // 查找用户
            const user = gameData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                // 检查用户是否被封禁
                if (user.isBanned) {
                    alert('该账号已被封禁，无法登录');
                    return;
                }
                
                gameData.currentUser = user;
                authContainer.style.display = 'none';
                
                if (user.isAdmin) {
                    adminContainer.style.display = 'block';
                    loadAdminContent('users');
                } else {
                    mainContainer.style.display = 'block';
                    updateUserInfo();
                    loadContent('upgrade');
                }
            } else {
                alert('用户名或密码错误');
            }
        }
        
        // 管理员登录
        function adminLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const adminCode = document.getElementById('admin-code').value;
            
            if (!username || !password || !adminCode) {
                alert('请输入用户名、密码和管理员代码');
                return;
            }
            
            if (adminCode !== gameData.adminCode) {
                alert('管理员代码错误');
                return;
            }
            
            // 查找用户或创建管理员账户
            let user = gameData.users.find(u => u.username === username && u.password === password);
            
            if (!user) {
                // 创建管理员账户
                user = {
                    id: Date.now(),
                    username,
                    password,
                    level: 99,
                    bricks: 9999,
                    starCoins: 9999,
                    vip: true,
                    vipExpire: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),
                    inviteCode: 'ADMIN' + generateInviteCode(),
                    invitedBy: null,
                    invitedUsers: 0,
                    lastUpgradeTime: null,
                    lastWithdrawTime: null,
                    lastEscapeGameTime: null,
                    lastAfkTime: null,
                    afkHours: 0,
                    totalWithdrawn: 0,
                    totalEarned: 0,
                    isAdmin: true,
                    isBanned: false,
                    device: navigator.userAgent
                };
                
                gameData.users.push(user);
                saveUsers();
            } else {
                // 设置为管理员
                user.isAdmin = true;
                saveUsers();
            }
            
            gameData.currentUser = user;
            authContainer.style.display = 'none';
            adminContainer.style.display = 'block';
            loadAdminContent('users');
        }
        
        // 生成邀请码
        function generateInviteCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }
        
        // 保存用户数据
        async function saveUsers() {
            await remoteDB.setItem('gameUsers', gameData.users);
        }
        
        // 保存提现申请
        async function saveWithdrawals() {
            await remoteDB.setItem('withdrawApplications', gameData.withdrawApplications);
        }
        
        // 保存VIP申请
        async function saveVipApplications() {
            await remoteDB.setItem('vipApplications', gameData.vipApplications);
        }
        
        // 保存游戏设置
        async function saveSettings() {
            const settings = {
                announcement: gameData.announcement,
                paymentQRCodes: gameData.paymentQRCodes,
                adminCode: gameData.adminCode,
                bannedUsers: gameData.bannedUsers,
                withdrawRate: gameData.withdrawRate
            };
            await remoteDB.setItem('gameSettings', settings);
        }
        
        // 更新用户信息显示
        function updateUserInfo() {
            if (!gameData.currentUser) return;
            
            displayUsername.textContent = gameData.currentUser.username;
            userLevel.textContent = `Lv.${gameData.currentUser.level}`;
            brickCount.textContent = `砖块: ${gameData.currentUser.bricks.toFixed(1)}`;
            starCoinCount.textContent = `人脉币: ${gameData.currentUser.starCoins}`;
        }
        
        // 更新服务器运行时间
        function updateUptime() {
            const now = new Date();
            const diff = now - gameData.serverStartTime;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            uptime.textContent = `${days}天${hours}时${minutes}分${seconds}秒`;
        }
        
        // 加载内容
        function loadContent(type) {
            if (!gameData.currentUser) return;
            
            escapeGameContainer.style.display = 'none';
            gameContainer.style.display = 'none';
            mainContainer.style.display = 'block';
            
            let content = '';
            
            switch (type) {
                case 'upgrade':
                    content = `
                        <h2 class="section-title">升级功能</h2>
                        <p>升级可以获得更多砖块和人脉币，提升等级解锁更多功能</p>
                        <div class="upgrade-container">
                            ${generateUpgradeCards()}
                        </div>
                    `;
                    break;
                    
                case 'games':
                    content = `
                        <h2 class="section-title">小游戏</h2>
                        <p>通过小游戏可以赚取砖块和人脉币</p>
                        <div class="games-container">
                            ${gameData.games.map(game => `
                                <div class="game-card" onclick="startGame(${game.id})">
                                    <img src="https://via.placeholder.com/150?text=${game.name}" alt="${game.name}">
                                    <h3>${game.name}</h3>
                                    <p>${game.description}</p>
                                    <p>奖励: ${game.reward}</p>
                                    <p>难度: ${game.difficulty}</p>
                                    ${game.cost > 0 ? `<p>消耗: ${game.cost}人脉币</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'market':
                    content = `
                        <h2 class="section-title">交易市场</h2>
                        <p>在这里可以交易砖块和人脉币</p>
                        <div class="market-container">
                            ${gameData.marketItems.map(item => `
                                <div class="market-item">
                                    <img src="https://via.placeholder.com/60?text=${item.name}" alt="${item.name}">
                                    <div class="market-info">
                                        <h3>${item.name}</h3>
                                        <p>包含: ${item.amount}</p>
                                    </div>
                                    <div class="market-price">${item.price}人脉币</div>
                                    <button class="market-btn" onclick="buyItem(${item.id})">购买</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'vip':
                    content = `
                        <h2 class="section-title">会员中心</h2>
                        <p>开通会员享受专属特权</p>
                        <div class="vip-container">
                            <div class="vip-card">
                                <h3 class="vip-title">高级会员</h3>
                                <div class="vip-price">32元/月</div>
                                <ul class="vip-benefits">
                                    ${gameData.vipBenefits.map(benefit => `<li>${benefit}</li>`).join('')}
                                </ul>
                                ${gameData.currentUser.vip ? `
                                    <p>您的会员有效期至: ${new Date(gameData.currentUser.vipExpire).toLocaleDateString()}</p>
                                ` : `
                                    <button class="vip-btn" onclick="showPaymentModal()">立即开通</button>
                                `}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'withdraw':
                    const feeRate = gameData.currentUser.vip ? 0.05 : 0.1;
                    const actualRate = gameData.withdrawRate * (1 - feeRate);
                    
                    content = `
                        <h2 class="section-title">提现功能</h2>
                        <p>将您的砖块转换为现金</p>
                        <div class="withdraw-container">
                            <form class="withdraw-form" onsubmit="submitWithdraw(event)">
                                <div class="form-group">
                                    <label for="withdraw-amount">提现金额(元)</label>
                                    <input type="number" id="withdraw-amount" min="10" required>
                                    <p style="font-size: 12px; color: #666;">实际需要: <span id="withdraw-bricks-needed">0</span> 砖块</p>
                                </div>
                                <div class="form-group">
                                    <label for="withdraw-method">提现方式</label>
                                    <select id="withdraw-method" required>
                                        <option value="alipay">支付宝</option>
                                        <option value="wechat">微信</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="withdraw-account">收款账号</label>
                                    <input type="text" id="withdraw-account" required>
                                </div>
                                <button type="submit" class="withdraw-btn">提交提现申请</button>
                            </form>
                            <p style="margin-top: 20px;">提现规则:</p>
                            <ul>
                                <li>最低提现金额: 10元</li>
                                <li>提现手续费: ${feeRate * 100}%</li>
                                <li>提现比例: 1砖块 = ${gameData.withdrawRate}元</li>
                                <li>实际到账: 1砖块 = ${actualRate.toFixed(2)}元</li>
                                <li>提现处理时间: 24小时内</li>
                            </ul>
                        </div>
                    `;
                    
                    // 设置提现金额变化事件
                    setTimeout(() => {
                        const amountInput = document.getElementById('withdraw-amount');
                        if (amountInput) {
                            amountInput.addEventListener('input', function() {
                                const amount = parseFloat(this.value) || 0;
                                const bricksNeeded = amount / actualRate;
                                document.getElementById('withdraw-bricks-needed').textContent = bricksNeeded.toFixed(2);
                            });
                        }
                    }, 100);
                    break;
                    
                case 'rank':
                    content = `
                        <h2 class="section-title">排行榜</h2>
                        <div class="rank-tabs">
                            <div class="rank-tab active" onclick="showRankTab('level')">等级榜</div>
                            <div class="rank-tab" onclick="showRankTab('bricks')">财富榜</div>
                            <div class="rank-tab" onclick="showRankTab('invite')">邀请榜</div>
                        </div>
                        <div id="rank-tab-content">
                            ${generateRankTable('level')}
                        </div>
                        <div style="margin-top: 20px;">
                            <h3>邀请好友</h3>
                            <p>邀请好友升级到5级可获得888红包</p>
                            <p>您的邀请码: <strong>${gameData.currentUser.inviteCode}</strong></p>
                            <p>您已邀请: ${gameData.currentUser.invitedUsers}人</p>
                        </div>
                    `;
                    break;
                    
                case 'afk':
                    const afkHours = gameData.currentUser.afkHours || 0;
                    const afkReward = Math.floor(afkHours) * gameData.afkRewardRate;
                    
                    content = `
                        <h2 class="section-title">挂机赚币</h2>
                        <p>挂机每小时可获得${gameData.afkRewardRate}人脉币</p>
                        <div class="afk-container">
                            <button class="afk-btn" id="start-afk">开始挂机</button>
                            <div class="afk-timer" id="afk-timer">
                                已挂机: ${afkHours.toFixed(2)}小时 | 可获得: ${afkReward}人脉币
                            </div>
                            ${afkReward > 0 ? `
                                <button class="afk-btn" onclick="claimAfkReward()" style="margin-top: 10px;">
                                    领取 ${afkReward}人脉币
                                </button>
                            ` : ''}
                        </div>
                    `;
                    
                    // 设置挂机按钮事件
                    setTimeout(() => {
                        const startAfkBtn = document.getElementById('start-afk');
                        if (startAfkBtn) {
                            startAfkBtn.addEventListener('click', startAfk);
                        }
                    }, 100);
                    break;
                    
                default:
                    content = `
                        <h2 class="section-title">欢迎来到高级搬砖人生</h2>
                        <p>请从上方菜单选择功能</p>
                    `;
            }
            
            contentArea.innerHTML = content;
        }
        
        // 生成升级卡片
        function generateUpgradeCards() {
            const user = gameData.currentUser;
            const maxLevel = 60;
            const cards = [];
            
            // 显示当前等级和接下来4个等级
            const startLevel = Math.max(1, user.level - 1);
            const endLevel = Math.min(maxLevel, startLevel + 4);
            
            for (let level = startLevel; level <= endLevel; level++) {
                const isCurrent = level === user.level;
                const canUpgrade = level === user.level + 1;
                const bricksNeeded = calculateBricksNeeded(level);
                const starCoinsNeeded = calculateStarCoinsNeeded(level);
                
                cards.push(`
                    <div class="upgrade-card">
                        <div class="upgrade-level">等级 ${level}</div>
                        <div class="upgrade-reward">
                            ${level === 1 ? '奖励: 0.3砖块' : ''}
                            ${level === 2 ? '奖励: 0.1砖块 + 积分' : ''}
                            ${level > 2 ? `奖励: ${(level * 0.2).toFixed(1)}砖块` : ''}
                        </div>
                        ${isCurrent ? `
                            <p>当前等级</p>
                        ` : canUpgrade ? `
                            <p>需要: ${bricksNeeded.toFixed(1)}砖块 ${starCoinsNeeded > 0 ? `+ ${starCoinsNeeded}人脉币` : ''}</p>
                            <button class="upgrade-btn" onclick="upgradeUser()" 
                                ${user.bricks >= bricksNeeded && user.starCoins >= starCoinsNeeded ? '' : 'disabled'}>
                                升级
                            </button>
                        ` : `
                            <p>${level < user.level ? '已达成' : '需要先达到前一级'}</p>
                        `}
                    </div>
                `);
            }
            
            return cards.join('');
        }
        
        // 计算升级所需砖块
        function calculateBricksNeeded(level) {
            if (level <= 5) return level - 1;
            let needed = Math.pow(1.2, level - 5) * 5;
            
            // VIP折扣
            if (gameData.currentUser.vip) {
                needed *= 0.9;
            }
            
            return needed;
        }
        
        // 计算升级所需人脉币
        function calculateStarCoinsNeeded(level) {
            if (level <= 10) return 0;
            return (level - 10) * 5;
        }
        
        // 用户升级
        async function upgradeUser() {
            const user = gameData.currentUser;
            const nextLevel = user.level + 1;
            const bricksNeeded = calculateBricksNeeded(nextLevel);
            const starCoinsNeeded = calculateStarCoinsNeeded(nextLevel);
            
            if (user.bricks >= bricksNeeded && user.starCoins >= starCoinsNeeded) {
                user.bricks -= bricksNeeded;
                user.starCoins -= starCoinsNeeded;
                user.level = nextLevel;
                user.lastUpgradeTime = new Date();
                
                // 根据等级给予奖励
                if (nextLevel === 1) {
                    user.bricks += 0.3;
                } else if (nextLevel === 2) {
                    user.bricks += 0.1;
                } else {
                    user.bricks += nextLevel * 0.2;
                }
                
                // 检查是否达到5级，给邀请人奖励
                if (nextLevel === 5 && user.invitedBy) {
                    const inviter = gameData.users.find(u => u.inviteCode === user.invitedBy);
                    if (inviter) {
                        inviter.starCoins += 10;
                        alert(`您的邀请人 ${inviter.username} 获得了10人脉币奖励`);
                    }
                }
                
                await saveUsers();
                updateUserInfo();
                loadContent('upgrade');
                alert(`升级成功！当前等级: ${nextLevel}`);
            }
        }
        
        // 开始游戏
        function startGame(gameId) {
            const game = gameData.games.find(g => g.id === gameId);
            if (!game) return;
            
            const user = gameData.currentUser;
            
            // 检查是否有足够的人脉币
            if (user.starCoins < game.cost) {
                alert(`人脉币不足，需要 ${game.cost} 人脉币`);
                return;
            }
            
            gameData.currentGame = game;
            
            let gameHTML = '';
            switch (gameId) {
                case 1: // 猜数字
                    gameHTML = `
                        <h2 class="section-title">猜数字游戏</h2>
                        <p>猜一个1-100之间的数字，猜中即可获得奖励</p>
                        <div class="game-board">
                            <p>我已经想好了一个1-100之间的数字，你能猜出来吗？</p>
                            <input type="number" id="guess-number" min="1" max="100" placeholder="输入你的猜测">
                            <button class="game-button" onclick="checkGuess()">猜一猜</button>
                            <p id="guess-result"></p>
                        </div>
                    `;
                    break;
                    
                case 2: // 剪刀石头布
                    gameHTML = `
                        <h2 class="section-title">剪刀石头布</h2>
                        <p>与电脑对战，三局两胜</p>
                        <div class="game-board">
                            <p>请选择你的出拳:</p>
                            <button class="game-button" onclick="playRPS('rock')">✊ 石头</button>
                            <button class="game-button" onclick="playRPS('paper')">✋ 布</button>
                            <button class="game-button" onclick="playRPS('scissors')">✌️ 剪刀</button>
                            <div id="rps-result" style="margin-top: 20px;"></div>
                            <div id="rps-score" style="margin-top: 10px;"></div>
                        </div>
                    `;
                    break;
                    
                case 3: // 记忆翻牌
                    gameHTML = `
                        <h2 class="section-title">记忆翻牌</h2>
                        <p>翻开卡片匹配相同的图案</p>
                        <div class="game-board">
                            <div id="memory-board" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;"></div>
                            <div id="memory-result" style="margin-top: 20px;"></div>
                        </div>
                        <button class="game-button" onclick="setupMemoryGame()" style="margin-top: 20px;">开始游戏</button>
                    `;
                    break;
            }
            
            gameContent.innerHTML = gameHTML;
            
            if (gameId === 3) {
                setupMemoryGame();
            }
            
            mainContainer.style.display = 'none';
            gameContainer.style.display = 'block';
        }
        
        // 猜数字游戏
        let secretNumber = 0;
        function checkGuess() {
            if (!secretNumber) {
                secretNumber = Math.floor(Math.random() * 100) + 1;
            }
            
            const guess = parseInt(document.getElementById('guess-number').value);
            const resultElement = document.getElementById('guess-result');
            
            if (isNaN(guess)) {
                resultElement.textContent = '请输入一个有效的数字';
                return;
            }
            
            if (guess < secretNumber) {
                resultElement.textContent = '太小了，再大一点！';
            } else if (guess > secretNumber) {
                resultElement.textContent = '太大了，再小一点！';
            } else {
                // 猜对了
                const reward = 1 + Math.floor(Math.random() * 5); // 1-5人脉币
                gameData.currentUser.starCoins += reward;
                saveUsers();
                updateUserInfo();
                
                resultElement.innerHTML = `恭喜你猜对了！获得 ${reward} 人脉币<br>正确答案是 ${secretNumber}`;
                secretNumber = 0;
                
                setTimeout(() => {
                    backToMainFromGame();
                    showRewardPopup(`猜数字游戏成功！获得 ${reward} 人脉币`);
                }, 2000);
            }
        }
        
        // 剪刀石头布游戏
        let rpsScore = { player: 0, computer: 0 };
        function playRPS(playerChoice) {
            const choices = ['rock', 'paper', 'scissors'];
            const computerChoice = choices[Math.floor(Math.random() * 3)];
            
            let result = '';
            if (playerChoice === computerChoice) {
                result = '平局！';
            } else if (
                (playerChoice === 'rock' && computerChoice === 'scissors') ||
                (playerChoice === 'paper' && computerChoice === 'rock') ||
                (playerChoice === 'scissors' && computerChoice === 'paper')
            ) {
                rpsScore.player++;
                result = '你赢了这一局！';
            } else {
                rpsScore.computer++;
                result = '电脑赢了这一局！';
            }
            
            const resultElement = document.getElementById('rps-result');
            resultElement.innerHTML = `
                你出了 ${getRPSName(playerChoice)}，电脑出了 ${getRPSName(computerChoice)}<br>
                ${result}
            `;
            
            const scoreElement = document.getElementById('rps-score');
            scoreElement.textContent = `比分: 你 ${rpsScore.player} - ${rpsScore.computer} 电脑`;
            
            // 检查游戏是否结束
            if (rpsScore.player >= 2 || rpsScore.computer >= 2) {
                if (rpsScore.player > rpsScore.computer) {
                    const reward = 2 + Math.floor(Math.random() * 5); // 2-6人脉币
                    gameData.currentUser.starCoins += reward;
                    saveUsers();
                    updateUserInfo();
                    
                    setTimeout(() => {
                        backToMainFromGame();
                        showRewardPopup(`剪刀石头布游戏胜利！获得 ${reward} 人脉币`);
                    }, 2000);
                } else {
                    setTimeout(() => {
                        backToMainFromGame();
                        alert('很遗憾，你输给了电脑');
                    }, 2000);
                }
            }
        }
        
        function getRPSName(choice) {
            switch (choice) {
                case 'rock': return '✊ 石头';
                case 'paper': return '✋ 布';
                case 'scissors': return '✌️ 剪刀';
            }
        }
        
        // 记忆翻牌游戏
        let memoryCards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        
        function setupMemoryGame() {
            const symbols = ['🍎', '🍌', '🍒', '🍓', '🍊', '🍋', '🍐', '🍉'];
            memoryCards = [...symbols, ...symbols].sort(() => Math.random() - 0.5);
            flippedCards = [];
            matchedPairs = 0;
            
            const board = document.getElementById('memory-board');
            board.innerHTML = '';
            
            memoryCards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.index = index;
                card.dataset.symbol = symbol;
                card.style.width = '60px';
                card.style.height = '60px';
                card.style.backgroundColor = '#6e8efb';
                card.style.color = 'white';
                card.style.display = 'flex';
                card.style.justifyContent = 'center';
                card.style.alignItems = 'center';
                card.style.cursor = 'pointer';
                card.style.fontSize = '24px';
                card.style.borderRadius = '5px';
                card.addEventListener('click', flipCard);
                board.appendChild(card);
            });
            
            document.getElementById('memory-result').textContent = '';
        }
        
        function flipCard() {
            const index = parseInt(this.dataset.index);
            
            // 如果卡片已经翻开或是已经匹配的，则忽略
            if (flippedCards.includes(index) || this.textContent) {
                return;
            }
            
            // 翻开卡片
            this.textContent = this.dataset.symbol;
            flippedCards.push(index);
            
            // 如果翻开了两张卡片，检查是否匹配
            if (flippedCards.length === 2) {
                const [firstIndex, secondIndex] = flippedCards;
                const firstCard = document.querySelector(`.memory-card[data-index="${firstIndex}"]`);
                const secondCard = document.querySelector(`.memory-card[data-index="${secondIndex}"]`);
                
                if (memoryCards[firstIndex] === memoryCards[secondIndex]) {
                    // 匹配成功
                    matchedPairs++;
                    flippedCards = [];
                    
                    // 检查游戏是否结束
                    if (matchedPairs === 8) {
                        const reward = 3 + Math.floor(Math.random() * 7); // 3-9人脉币
                        gameData.currentUser.starCoins += reward;
                        saveUsers();
                        updateUserInfo();
                        
                        setTimeout(() => {
                            backToMainFromGame();
                            showRewardPopup(`记忆翻牌游戏成功！获得 ${reward} 人脉币`);
                        }, 1000);
                    }
                } else {
                    // 不匹配，翻回去
                    setTimeout(() => {
                        firstCard.textContent = '';
                        secondCard.textContent = '';
                        flippedCards = [];
                    }, 1000);
                }
            }
        }
        
        // 从游戏返回主界面
        function backToMainFromGame() {
            gameContainer.style.display = 'none';
            mainContainer.style.display = 'block';
            gameData.currentGame = null;
        }
        
        // 购买物品
        async function buyItem(itemId) {
            const item = gameData.marketItems.find(i => i.id === itemId);
            if (!item) return;
            
            const user = gameData.currentUser;
            
            if (user.starCoins >= item.price) {
                user.starCoins -= item.price;
                
                // 处理物品效果
                if (item.name.includes('砖块礼包')) {
                    user.bricks += 10;
                    showRewardPopup('购买成功！获得10砖块');
                } else if (item.name.includes('会员体验卡')) {
                    if (!user.vip || new Date(user.vipExpire) < new Date()) {
                        user.vipExpire = new Date(Date.now() + 24 * 60 * 60 * 1000);
                    } else {
                        user.vipExpire = new Date(user.vipExpire.getTime() + 24 * 60 * 60 * 1000);
                    }
                    user.vip = true;
                    showRewardPopup('购买成功！会员已延长1天');
                } else if (item.name.includes('升级加速器')) {
                    showRewardPopup('购买成功！下次升级时间减半');
                }
                
                await saveUsers();
                updateUserInfo();
            } else {
                alert('人脉币不足');
            }
        }
        
        // 显示支付弹窗
        function showPaymentModal() {
            paymentModal.style.display = 'block';
        }
        
        // 提交VIP申请
        async function submitVipApplication() {
            const user = gameData.currentUser;
            
            gameData.vipApplications.push({
                userId: user.id,
                username: user.username,
                amount: 32,
                status: 'pending',
                applyTime: new Date()
            });
            
            await saveVipApplications();
            paymentModal.style.display = 'none';
            alert('VIP申请已提交，请等待管理员处理');
        }
        
        // 提交提现申请
        async function submitWithdraw(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const method = document.getElementById('withdraw-method').value;
            const account = document.getElementById('withdraw-account').value;
            
            const user = gameData.currentUser;
            const feeRate = user.vip ? 0.05 : 0.1;
            const actualRate = gameData.withdrawRate * (1 - feeRate);
            const bricksNeeded = amount / actualRate;
            
            if (amount < 10) {
                alert('最低提现金额为10元');
                return;
            }
            
            if (user.bricks >= bricksNeeded) {
                user.bricks -= bricksNeeded;
                user.lastWithdrawTime = new Date();
                
                gameData.withdrawApplications.push({
                    userId: user.id,
                    username: user.username,
                    amount: amount,
                    bricks: bricksNeeded,
                    method: method,
                    account: account,
                    status: 'pending',
                    applyTime: new Date()
                });
                
                await saveUsers();
                await saveWithdrawals();
                updateUserInfo();
                alert(`提现申请已提交，预计24小时内处理。实际到账: ${amount.toFixed(2)}元 (手续费: ${(bricksNeeded * gameData.withdrawRate - amount).toFixed(2)}元)`);
            } else {
                alert(`砖块不足，需要 ${bricksNeeded.toFixed(1)} 砖块 (含手续费)`);
            }
        }
        
        // 显示排行榜标签
        function showRankTab(type) {
            // 更新标签样式
            document.querySelectorAll('.rank-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 更新内容
            document.getElementById('rank-tab-content').innerHTML = generateRankTable(type);
        }
        
        // 生成排行榜表格
        function generateRankTable(type) {
            let rankedUsers = [];
            
            switch (type) {
                case 'level':
                    rankedUsers = [...gameData.users]
                        .filter(u => !u.isBanned)
                        .sort((a, b) => b.level - a.level || b.bricks - a.bricks)
                        .slice(0, 10);
                    break;
                    
                case 'bricks':
                    rankedUsers = [...gameData.users]
                        .filter(u => !u.isBanned)
                        .sort((a, b) => b.bricks - a.bricks || b.level - a.level)
                        .slice(0, 10);
                    break;
                    
                case 'invite':
                    rankedUsers = [...gameData.users]
                        .filter(u => !u.isBanned)
                        .sort((a, b) => b.invitedUsers - a.invitedUsers || b.level - a.level)
                        .slice(0, 10);
                    break;
            }
            
            return `
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>用户名</th>
                            ${type === 'level' ? '<th>等级</th>' : ''}
                            ${type === 'bricks' ? '<th>砖块</th>' : ''}
                            ${type === 'invite' ? '<th>邀请人数</th>' : ''}
                            <th>人脉币</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rankedUsers.map((user, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${user.username}</td>
                                ${type === 'level' ? `<td>${user.level}</td>` : ''}
                                ${type === 'bricks' ? `<td>${user.bricks.toFixed(1)}</td>` : ''}
                                ${type === 'invite' ? `<td>${user.invitedUsers}</td>` : ''}
                                <td>${user.starCoins}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // 显示大逃杀游戏
        function showEscapeGame() {
            mainContainer.style.display = 'none';
            escapeGameContainer.style.display = 'block';
            
            // 生成房间选择
            escapeRooms.innerHTML = gameData.rooms.map(room => `
                <div class="escape-room" data-room="${room}">
                    <h3>${room}</h3>
                    <p>当前人数: ${Math.floor(Math.random() * 5) + 1}</p>
                </div>
            `).join('');
            
            // 添加房间选择事件
            document.querySelectorAll('.escape-room').forEach(room => {
                room.addEventListener('click', function() {
                    document.querySelectorAll('.escape-room').forEach(r => r.classList.remove('escape-selected'));
                    this.classList.add('escape-selected');
                });
            });
            
            // VIP玩家初始能量石+10
            if (gameData.currentUser.vip) {
                energyStones.value = 20;
            }
        }
        
        // 开始大逃杀游戏
        async function startEscapeGame() {
            const selectedRoom = document.querySelector('.escape-selected');
            const stones = parseInt(energyStones.value) || 10;
            
            if (!selectedRoom) {
                alert('请先选择一个房间');
                return;
            }
            
            if (gameData.currentUser.starCoins < stones) {
                alert('人脉币不足');
                return;
            }
            
            // 扣除能量石
            gameData.currentUser.starCoins -= stones;
            gameData.currentUser.lastEscapeGameTime = new Date();
            await saveUsers();
            updateUserInfo();
            
            // 模拟游戏结果
            const roomName = selectedRoom.dataset.room;
            const allRooms = [...gameData.rooms];
            const killedRoom = allRooms[Math.floor(Math.random() * allRooms.length)];
            
            // 计算奖励
            let resultMessage = '';
            
            if (roomName === killedRoom) {
                resultMessage = `不幸！外星人选中了${killedRoom}房间，您损失了${stones}能量石`;
            } else {
                const totalPlayers = 36; // 35机器人 + 1玩家
                const killedPlayers = Math.floor(Math.random() * 5) + 3;
                const survivingPlayers = totalPlayers - killedPlayers;
                const totalStones = killedPlayers * stones;
                const reward = totalStones / survivingPlayers;
                
                // 返还投入的能量石加上奖励
                gameData.currentUser.starCoins += stones + reward;
                await saveUsers();
                updateUserInfo();
                
                resultMessage = `恭喜！外星人选中了${killedRoom}房间，您幸存并获得${reward.toFixed(2)}能量石奖励`;
            }
            
            escapeResult.innerHTML = `
                <h3>游戏结果</h3>
                <p>${resultMessage}</p>
                <p>当前人脉币: ${gameData.currentUser.starCoins}</p>
            `;
        }
        
        // 开始挂机
        function startAfk() {
            const user = gameData.currentUser;
            user.lastAfkTime = new Date();
            saveUsers();
            
            // 更新按钮状态
            const startAfkBtn = document.getElementById('start-afk');
            if (startAfkBtn) {
                startAfkBtn.textContent = '挂机中...';
                startAfkBtn.disabled = true;
            }
            
            // 存储挂机计时器
            gameData.afkTimers[user.id] = setInterval(() => {
                updateAfkTimer();
            }, 1000);
            
            localStorage.setItem('afkTimers', JSON.stringify({
                [user.id]: user.lastAfkTime.getTime()
            }));
            
            alert('挂机已开始，每小时可获得' + gameData.afkRewardRate + '人脉币');
        }
        
        // 更新挂机计时器显示
        function updateAfkTimer() {
            const user = gameData.currentUser;
            if (!user.lastAfkTime) return;
            
            const now = new Date();
            const diffHours = (now - user.lastAfkTime) / (1000 * 60 * 60);
            user.afkHours = diffHours;
            
            const afkTimer = document.getElementById('afk-timer');
            if (afkTimer) {
                const reward = Math.floor(diffHours) * gameData.afkRewardRate;
                afkTimer.innerHTML = `已挂机: ${diffHours.toFixed(2)}小时 | 可获得: ${reward}人脉币`;
            }
        }
        
        // 领取挂机奖励
        async function claimAfkReward() {
            const user = gameData.currentUser;
            if (!user.lastAfkTime) return;
            
            const hours = Math.floor(user.afkHours);
            if (hours <= 0) return;
            
            const reward = hours * gameData.afkRewardRate;
            user.starCoins += reward;
            user.afkHours -= hours;
            user.lastAfkTime = new Date(); // 重置计时
            
            // 清除计时器
            if (gameData.afkTimers[user.id]) {
                clearInterval(gameData.afkTimers[user.id]);
                delete gameData.afkTimers[user.id];
            }
            
            // 更新按钮状态
            const startAfkBtn = document.getElementById('start-afk');
            if (startAfkBtn) {
                startAfkBtn.textContent = '开始挂机';
                startAfkBtn.disabled = false;
            }
            
            await saveUsers();
            updateUserInfo();
            loadContent('afk');
            alert(`成功领取 ${reward} 人脉币`);
        }
        
        // 恢复挂机计时器
        function restoreAfkTimers() {
            const savedTimers = localStorage.getItem('afkTimers');
            if (!savedTimers) return;
            
            const timers = JSON.parse(savedTimers);
            for (const userId in timers) {
                const user = gameData.users.find(u => u.id === parseInt(userId));
                if (user) {
                    user.lastAfkTime = new Date(timers[userId]);
                    user.afkHours = (new Date() - user.lastAfkTime) / (1000 * 60 * 60);
                    
                    // 如果用户当前已登录，设置计时器
                    if (gameData.currentUser && gameData.currentUser.id === user.id) {
                        gameData.afkTimers[user.id] = setInterval(() => {
                            updateAfkTimer();
                        }, 1000);
                    }
                }
            }
        }
        
        // 加载管理员内容
        function loadAdminContent(type) {
            let content = '';
            
            switch (type) {
                case 'users':
                    content = `
                        <h3>用户管理</h3>
                        <div class="admin-controls">
                            <button onclick="showAddUserForm()">添加用户</button>
                            <button onclick="refreshUserList()">刷新列表</button>
                        </div>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>等级</th>
                                    <th>砖块</th>
                                    <th>人脉币</th>
                                    <th>VIP</th>
                                    <th>设备信息</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${gameData.users.map(user => `
                                    <tr class="${user.isBanned ? 'banned-user' : ''}">
                                        <td>${user.id}</td>
                                        <td>${user.username}</td>
                                        <td>${user.level}</td>
                                        <td>${user.bricks.toFixed(1)}</td>
                                        <td>${user.starCoins}</td>
                                        <td>${user.vip ? '是' : '否'}</td>
                                        <td title="${user.device || '未知设备'}">${getDeviceType(user.device)}</td>
                                        <td>${user.isBanned ? '已封禁' : '正常'}</td>
                                        <td>
                                            <button onclick="editUser(${user.id})">编辑</button>
                                            ${user.id !== gameData.currentUser.id ? `
                                                <button onclick="banUser(${user.id}, ${!user.isBanned})">
                                                    ${user.isBanned ? '解封' : '封禁'}
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div id="user-form" class="admin-form" style="display: none;">
                            <h4 id="user-form-title">添加用户</h4>
                            <div class="form-group">
                                <label for="admin-username">用户名</label>
                                <input type="text" id="admin-username">
                            </div>
                            <div class="form-group">
                                <label for="admin-password">密码</label>
                                <input type="password" id="admin-password">
                            </div>
                            <div class="form-group">
                                <label for="admin-bricks">砖块数量</label>
                                <input type="number" id="admin-bricks" value="0">
                            </div>
                            <div class="form-group">
                                <label for="admin-starcoins">人脉币数量</label>
                                <input type="number" id="admin-starcoins" value="0">
                            </div>
                            <div class="form-group">
                                <label for="admin-level">等级</label>
                                <input type="number" id="admin-level" value="1">
                            </div>
                            <div class="form-group">
                                <label for="admin-vip">VIP会员</label>
                                <input type="checkbox" id="admin-vip">
                            </div>
                            <div class="form-group">
                                <label for="admin-banned">封禁状态</label>
                                <input type="checkbox" id="admin-banned">
                            </div>
                            <button onclick="submitUserForm()">提交</button>
                            <button onclick="document.getElementById('user-form').style.display = 'none'">取消</button>
                            <input type="hidden" id="edit-user-id" value="">
                        </div>
                    `;
                    break;
                    
                case 'withdraw':
                    const pendingWithdrawals = gameData.withdrawApplications.filter(w => w.status === 'pending');
                    const processedWithdrawals = gameData.withdrawApplications.filter(w => w.status !== 'pending');
                    
                    content = `
                        <h3>提现申请</h3>
                        <div class="admin-controls">
                            <button onclick="refreshWithdrawals()">刷新列表</button>
                        </div>
                        
                        <h4>待处理申请</h4>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>金额</th>
                                    <th>砖块</th>
                                    <th>方式</th>
                                    <th>账号</th>
                                    <th>申请时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pendingWithdrawals.map(w => `
                                    <tr>
                                        <td>${w.userId}</td>
                                        <td>${w.username}</td>
                                        <td>${w.amount}元</td>
                                        <td>${w.bricks.toFixed(1)}</td>
                                        <td>${w.method === 'alipay' ? '支付宝' : '微信'}</td>
                                        <td>${w.account}</td>
                                        <td>${new Date(w.applyTime).toLocaleString()}</td>
                                        <td>
                                            <button onclick="processWithdrawal(${w.userId}, 'approved')">通过</button>
                                            <button onclick="processWithdrawal(${w.userId}, 'rejected')">拒绝</button>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${pendingWithdrawals.length === 0 ? '<tr><td colspan="8">没有待处理的提现申请</td></tr>' : ''}
                            </tbody>
                        </table>
                        
                        <h4 style="margin-top: 20px;">已处理申请</h4>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>金额</th>
                                    <th>砖块</th>
                                    <th>方式</th>
                                    <th>状态</th>
                                    <th>处理时间</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${processedWithdrawals.map(w => `
                                    <tr>
                                        <td>${w.userId}</td>
                                        <td>${w.username}</td>
                                        <td>${w.amount}元</td>
                                        <td>${w.bricks.toFixed(1)}</td>
                                        <td>${w.method === 'alipay' ? '支付宝' : '微信'}</td>
                                        <td>${w.status === 'approved' ? '已通过' : '已拒绝'}</td>
                                        <td>${w.processTime ? new Date(w.processTime).toLocaleString() : ''}</td>
                                    </tr>
                                `).join('')}
                                ${processedWithdrawals.length === 0 ? '<tr><td colspan="7">没有已处理的提现申请</td></tr>' : ''}
                            </tbody>
                        </table>
                    `;
                    break;
                    
                case 'vip':
                    const pendingVipApps = gameData.vipApplications.filter(v => v.status === 'pending');
                    const processedVipApps = gameData.vipApplications.filter(v => v.status !== 'pending');
                    
                    content = `
                        <h3>VIP会员申请</h3>
                        <div class="admin-controls">
                            <button onclick="refreshVipApplications()">刷新列表</button>
                        </div>
                        
                        <h4>待处理申请</h4>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>金额</th>
                                    <th>申请时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pendingVipApps.map(v => `
                                    <tr>
                                        <td>${v.userId}</td>
                                        <td>${v.username}</td>
                                        <td>${v.amount}元</td>
                                        <td>${new Date(v.applyTime).toLocaleString()}</td>
                                        <td>
                                            <button onclick="processVipApplication(${v.userId}, 'approved')">通过</button>
                                            <button onclick="processVipApplication(${v.userId}, 'rejected')">拒绝</button>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${pendingVipApps.length === 0 ? '<tr><td colspan="5">没有待处理的VIP申请</td></tr>' : ''}
                            </tbody>
                        </table>
                        
                        <h4 style="margin-top: 20px;">已处理申请</h4>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>金额</th>
                                    <th>状态</th>
                                    <th>处理时间</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${processedVipApps.map(v => `
                                    <tr>
                                        <td>${v.userId}</td>
                                        <td>${v.username}</td>
                                        <td>${v.amount}元</td>
                                        <td>${v.status === 'approved' ? '已通过' : '已拒绝'}</td>
                                        <td>${v.processTime ? new Date(v.processTime).toLocaleString() : ''}</td>
                                    </tr>
                                `).join('')}
                                ${processedVipApps.length === 0 ? '<tr><td colspan="5">没有已处理的VIP申请</td></tr>' : ''}
                            </tbody>
                        </table>
                    `;
                    break;
                    
                case 'settings':
                    content = `
                        <h3>系统设置</h3>
                        <div class="admin-form">
                            <div class="form-group">
                                <label for="admin-announcement">系统公告</label>
                                <textarea id="admin-announcement" rows="3" style="width: 100%;">${gameData.announcement}</textarea>
                            </div>
                            
                            <h4 style="margin-top: 20px;">支付二维码</h4>
                            <div class="form-group">
                                <label>支付宝二维码</label>
                                <img id="alipay-preview" src="${gameData.paymentQRCodes.alipay}" class="upload-preview" ${gameData.paymentQRCodes.alipay ? '' : 'style="display: none;"'}>
                                <input type="file" id="admin-alipay-upload" accept="image/*" style="display: none;">
                                <button onclick="document.getElementById('admin-alipay-upload').click()">上传支付宝二维码</button>
                            </div>
                            
                            <div class="form-group">
                                <label>微信支付二维码</label>
                                <img id="wechat-preview" src="${gameData.paymentQRCodes.wechat}" class="upload-preview" ${gameData.paymentQRCodes.wechat ? '' : 'style="display: none;"'}>
                                <input type="file" id="admin-wechat-upload" accept="image/*" style="display: none;">
                                <button onclick="document.getElementById('admin-wechat-upload').click()">上传微信支付二维码</button>
                            </div>
                            
                            <h4 style="margin-top: 20px;">交易市场设置</h4>
                            <div class="form-group">
                                <label for="market-item-1-price">砖块礼包价格</label>
                                <input type="number" id="market-item-1-price" value="${gameData.marketItems[0].price}">
                            </div>
                            <div class="form-group">
                                <label for="market-item-2-price">人脉礼包价格</label>
                                <input type="number" id="market-item-2-price" value="${gameData.marketItems[1].price}">
                            </div>
                            <div class="form-group">
                                <label for="market-item-3-price">会员体验卡价格</label>
                                <input type="number" id="market-item-3-price" value="${gameData.marketItems[2].price}">
                            </div>
                            <div class="form-group">
                                <label for="market-item-4-price">升级加速器价格</label>
                                <input type="number" id="market-item-4-price" value="${gameData.marketItems[3].price}">
                            </div>
                            
                            <h4 style="margin-top: 20px;">提现设置</h4>
                            <div class="form-group">
                                <label for="withdraw-rate">提现比例 (1砖块=多少元)</label>
                                <input type="number" id="withdraw-rate" step="0.01" value="${gameData.withdrawRate}">
                            </div>
                            
                            <div class="form-group">
                                <label for="admin-code">管理员密码</label>
                                <input type="password" id="admin-new-code" value="${gameData.adminCode}">
                            </div>
                            <button onclick="saveSystemSettings()">保存设置</button>
                        </div>
                    `;
                    
                    // 设置管理员图片上传事件
                    setTimeout(() => {
                        document.getElementById('admin-alipay-upload').addEventListener('change', function(e) {
                            handleAdminImageUpload(e, 'alipay');
                        });
                        
                        document.getElementById('admin-wechat-upload').addEventListener('change', function(e) {
                            handleAdminImageUpload(e, 'wechat');
                        });
                    }, 100);
                    break;
                    
                default:
                    content = '<p>请从上方选择管理功能</p>';
            }
            
            adminContent.innerHTML = content;
        }
        
        // 获取设备类型简写
        function getDeviceType(userAgent) {
            if (!userAgent) return '未知';
            
            if (/mobile/i.test(userAgent)) {
                return '手机';
            } else if (/tablet/i.test(userAgent)) {
                return '平板';
            } else if (/windows/i.test(userAgent)) {
                return 'Win电脑';
            } else if (/macintosh/i.test(userAgent)) {
                return 'Mac电脑';
            } else if (/linux/i.test(userAgent)) {
                return 'Linux电脑';
            } else {
                return '其他设备';
            }
        }
        
        // 处理管理员图片上传
        function handleAdminImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(`${type}-preview`);
                img.src = e.target.result;
                img.style.display = 'block';
                
                // 保存到游戏数据
                gameData.paymentQRCodes[type] = e.target.result;
                saveSettings();
            };
            reader.readAsDataURL(file);
        }
        
        // 显示添加用户表单
        function showAddUserForm() {
            const form = document.getElementById('user-form');
            form.style.display = 'block';
            document.getElementById('user-form-title').textContent = '添加用户';
            document.getElementById('edit-user-id').value = '';
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-bricks').value = '0';
            document.getElementById('admin-starcoins').value = '0';
            document.getElementById('admin-level').value = '1';
            document.getElementById('admin-vip').checked = false;
            document.getElementById('admin-banned').checked = false;
        }
        
        // 编辑用户
        function editUser(userId) {
            const user = gameData.users.find(u => u.id === userId);
            if (!user) return;
            
            const form = document.getElementById('user-form');
            form.style.display = 'block';
            document.getElementById('user-form-title').textContent = '编辑用户';
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('admin-username').value = user.username;
            document.getElementById('admin-password').value = user.password;
            document.getElementById('admin-bricks').value = user.bricks;
            document.getElementById('admin-starcoins').value = user.starCoins;
            document.getElementById('admin-level').value = user.level;
            document.getElementById('admin-vip').checked = user.vip;
            document.getElementById('admin-banned').checked = user.isBanned;
        }
        
        // 封禁/解封用户
        async function banUser(userId, ban) {
            const user = gameData.users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`确定要${ban ? '封禁' : '解封'}用户 ${user.username} 吗？`)) {
                user.isBanned = ban;
                
                // 更新封禁用户列表
                if (ban) {
                    if (!gameData.bannedUsers.includes(user.username)) {
                        gameData.bannedUsers.push(user.username);
                    }
                } else {
                    gameData.bannedUsers = gameData.bannedUsers.filter(u => u !== user.username);
                }
                
                await saveUsers();
                await saveSettings();
                loadAdminContent('users');
                alert(`用户 ${user.username} 已${ban ? '封禁' : '解封'}`);
            }
        }
        
        // 提交用户表单
        async function submitUserForm() {
            const id = document.getElementById('edit-user-id').value;
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const bricks = parseFloat(document.getElementById('admin-bricks').value);
            const starcoins = parseInt(document.getElementById('admin-starcoins').value);
            const level = parseInt(document.getElementById('admin-level').value);
            const vip = document.getElementById('admin-vip').checked;
            const banned = document.getElementById('admin-banned').checked;
            
            if (!username || !password) {
                alert('请输入用户名和密码');
                return;
            }
            
            if (id) {
                // 编辑现有用户
                const user = gameData.users.find(u => u.id === parseInt(id));
                if (user) {
                    user.username = username;
                    user.password = password;
                    user.bricks = bricks;
                    user.starCoins = starcoins;
                    user.level = level;
                    user.vip = vip;
                    user.isBanned = banned;
                    
                    if (vip && !user.vipExpire) {
                        user.vipExpire = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
                    }
                    
                    // 更新封禁用户列表
                    if (banned) {
                        if (!gameData.bannedUsers.includes(username)) {
                            gameData.bannedUsers.push(username);
                        }
                    } else {
                        gameData.bannedUsers = gameData.bannedUsers.filter(u => u !== username);
                    }
                    
                    await saveUsers();
                    await saveSettings();
                    alert('用户信息已更新');
                }
            } else {
                // 添加新用户
                const newUser = {
                    id: Date.now(),
                    username,
                    password,
                    level,
                    bricks,
                    starCoins: starcoins,
                    vip,
                    vipExpire: vip ? new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) : null,
                    inviteCode: generateInviteCode(),
                    invitedBy: null,
                    invitedUsers: 0,
                    lastUpgradeTime: null,
                    lastWithdrawTime: null,
                    lastEscapeGameTime: null,
                    lastAfkTime: null,
                    afkHours: 0,
                    totalWithdrawn: 0,
                    totalEarned: 0,
                    isAdmin: false,
                    isBanned: banned,
                    device: navigator.userAgent
                };
                
                gameData.users.push(newUser);
                
                // 添加到封禁列表
                if (banned) {
                    gameData.bannedUsers.push(username);
                }
                
                await saveUsers();
                await saveSettings();
                alert('用户已添加');
            }
            
            document.getElementById('user-form').style.display = 'none';
            loadAdminContent('users');
        }
        
        // 处理提现申请
        async function processWithdrawal(userId, status) {
            const application = gameData.withdrawApplications.find(w => w.userId === userId && w.status === 'pending');
            if (!application) return;
            
            application.status = status;
            application.processTime = new Date();
            
            if (status === 'rejected') {
                // 拒绝申请，返还砖块
                const user = gameData.users.find(u => u.id === userId);
                if (user) {
                    user.bricks += application.bricks;
                    await saveUsers();
                }
            } else {
                // 通过申请，更新用户提现总额
                const user = gameData.users.find(u => u.id === userId);
                if (user) {
                    user.totalWithdrawn += application.amount;
                    await saveUsers();
                }
            }
            
            await saveWithdrawals();
            loadAdminContent('withdraw');
            alert(`提现申请已${status === 'approved' ? '通过' : '拒绝'}`);
        }
        
        // 处理VIP申请
        async function processVipApplication(userId, status) {
            const application = gameData.vipApplications.find(v => v.userId === userId && v.status === 'pending');
            if (!application) return;
            
            application.status = status;
            application.processTime = new Date();
            
            if (status === 'approved') {
                // 批准申请，设置VIP
                const user = gameData.users.find(u => u.id === userId);
                if (user) {
                    user.vip = true;
                    if (!user.vipExpire || new Date(user.vipExpire) < new Date()) {
                        user.vipExpire = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
                    } else {
                        user.vipExpire = new Date(user.vipExpire.getTime() + 30 * 24 * 60 * 60 * 1000);
                    }
                    await saveUsers();
                }
            }
            
            await saveVipApplications();
            loadAdminContent('vip');
            alert(`VIP申请已${status === 'approved' ? '通过' : '拒绝'}`);
        }
        
        // 保存系统设置
        async function saveSystemSettings() {
            const announcement = document.getElementById('admin-announcement').value;
            const adminCode = document.getElementById('admin-new-code').value;
            
            // 更新市场价格
            gameData.marketItems[0].price = parseInt(document.getElementById('market-item-1-price').value) || 5;
            gameData.marketItems[1].price = parseInt(document.getElementById('market-item-2-price').value) || 50;
            gameData.marketItems[2].price = parseInt(document.getElementById('market-item-3-price').value) || 10;
            gameData.marketItems[3].price = parseInt(document.getElementById('market-item-4-price').value) || 3;
            
            // 更新提现比例
            gameData.withdrawRate = parseFloat(document.getElementById('withdraw-rate').value) || 0.9;
            
            gameData.announcement = announcement;
            gameData.adminCode = adminCode;
            
            announcementText.textContent = announcement;
            await saveSettings();
            alert('系统设置已保存');
        }
        
        // 刷新用户列表
        function refreshUserList() {
            loadAdminContent('users');
        }
        
        // 刷新提现申请列表
        function refreshWithdrawals() {
            loadAdminContent('withdraw');
        }
        
        // 刷新VIP申请列表
        function refreshVipApplications() {
            loadAdminContent('vip');
        }
        
        // 返回主界面
        function backToMain() {
            escapeGameContainer.style.display = 'none';
            adminContainer.style.display = 'none';
            mainContainer.style.display = 'block';
            loadContent('upgrade');
        }
        
        // 显示奖励弹窗
        function showRewardPopup(message) {
            rewardTitle.textContent = "游戏奖励";
            rewardMessage.textContent = message;
            rewardPopup.style.display = 'block';
        }
        
        // 全局函数
        window.startGame = startGame;
        window.checkGuess = checkGuess;
        window.playRPS = playRPS;
        window.setupMemoryGame = setupMemoryGame;
        window.flipCard = flipCard;
        window.buyItem = buyItem;
        window.upgradeUser = upgradeUser;
        window.showPaymentModal = showPaymentModal;
        window.submitVipApplication = submitVipApplication;
        window.submitWithdraw = submitWithdraw;
        window.showRankTab = showRankTab;
        window.startAfk = startAfk;
        window.claimAfkReward = claimAfkReward;
        window.backToMain = backToMain;
        window.backToMainFromGame = backToMainFromGame;
        window.loadAdminContent = loadAdminContent;
        window.showAddUserForm = showAddUserForm;
        window.editUser = editUser;
        window.banUser = banUser;
        window.submitUserForm = submitUserForm;
        window.processWithdrawal = processWithdrawal;
        window.processVipApplication = processVipApplication;
        window.saveSystemSettings = saveSystemSettings;
        window.refreshUserList = refreshUserList;
        window.refreshWithdrawals = refreshWithdrawals;
        window.refreshVipApplications = refreshVipApplications;
        
        // 初始化
        init();
    </script>
</body>
</html>
