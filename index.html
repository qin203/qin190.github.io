<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡å…‹éš†ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 420px;
            height: 800px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #07C160;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            position: relative;
        }
        
        .header .back-btn {
            position: absolute;
            left: 15px;
            top: 15px;
            cursor: pointer;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .footer {
            display: flex;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }
        
        .footer-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }
        
        .footer-btn.active {
            color: #07C160;
        }
        
        /* ç™»å½•/æ³¨å†Œé¡µé¢æ ·å¼ */
        .auth-form {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background-color: #07C160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-secondary {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .switch-auth {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .switch-auth span {
            color: #07C160;
            cursor: pointer;
        }
        
        /* é¦–é¡µæ ·å¼ */
        .chat-list {
            list-style: none;
        }
        
        .chat-item {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .chat-item:hover {
            background-color: #f9f9f9;
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            margin-right: 10px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .chat-name {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .chat-last-msg {
            font-size: 14px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            font-size: 12px;
            color: #999;
        }
        
        /* èŠå¤©é¡µé¢æ ·å¼ */
        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 10px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .chat-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-header-name {
            font-size: 16px;
            font-weight: bold;
        }
        
        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message.received {
            align-items: flex-start;
        }
        
        .message.sent {
            align-items: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }
        
        .message.received .message-content {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .message.sent .message-content {
            background-color: #95EC69;
            color: #333;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .chat-input button {
            margin-left: 10px;
            padding: 10px 15px;
            background-color: #07C160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* é€šè®¯å½•é¡µé¢æ ·å¼ */
        .contact-list {
            list-style: none;
        }
        
        .contact-item {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 10px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .contact-name {
            font-size: 16px;
            line-height: 40px;
        }
        
        /* å‘ç°é¡µé¢æ ·å¼ */
        .discover-list {
            list-style: none;
        }
        
        .discover-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .discover-item:hover {
            background-color: #f9f9f9;
        }
        
        .discover-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            color: #07C160;
        }
        
        .discover-name {
            font-size: 16px;
            flex: 1;
        }
        
        .discover-arrow {
            width: 12px;
            height: 12px;
            border-top: 2px solid #999;
            border-right: 2px solid #999;
            transform: rotate(45deg);
        }
        
        /* æˆ‘é¡µé¢æ ·å¼ */
        .profile-header {
            display: flex;
            padding: 20px;
            background-color: #f9f9f9;
            align-items: center;
        }
        
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .profile-id {
            font-size: 14px;
            color: #999;
        }
        
        .profile-qrcode {
            width: 24px;
            height: 24px;
            color: #999;
        }
        
        .profile-list {
            list-style: none;
            margin-top: 10px;
        }
        
        .profile-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .profile-item:hover {
            background-color: #f9f9f9;
        }
        
        .profile-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            color: #07C160;
        }
        
        .profile-item-name {
            font-size: 16px;
            flex: 1;
        }
        
        .profile-arrow {
            width: 12px;
            height: 12px;
            border-top: 2px solid #999;
            border-right: 2px solid #999;
            transform: rotate(45deg);
        }
        
        /* æ·»åŠ å¥½å‹é¡µé¢æ ·å¼ */
        .search-bar {
            padding: 10px;
            background-color: #f9f9f9;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-results {
            list-style: none;
        }
        
        .search-result-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        
        .search-result-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .search-result-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .search-result-info {
            flex: 1;
        }
        
        .search-result-name {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .search-result-id {
            font-size: 14px;
            color: #999;
        }
        
        .search-result-btn {
            padding: 5px 10px;
            background-color: #07C160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* å¥½å‹è¯·æ±‚é¡µé¢æ ·å¼ */
        .request-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .request-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .request-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .request-info {
            flex: 1;
        }
        
        .request-name {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .request-message {
            font-size: 14px;
            color: #999;
            margin-bottom: 10px;
        }
        
        .request-actions {
            display: flex;
        }
        
        .request-btn {
            padding: 5px 10px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .request-btn.accept {
            background-color: #07C160;
            color: white;
            border-color: #07C160;
        }
        
        .request-btn.reject {
            background-color: #f5f5f5;
            color: #666;
        }
        
        /* è®¾ç½®é¡µé¢æ ·å¼ */
        .settings-list {
            list-style: none;
        }
        
        .settings-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .settings-item:hover {
            background-color: #f9f9f9;
        }
        
        .settings-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            color: #07C160;
        }
        
        .settings-item-name {
            font-size: 16px;
            flex: 1;
        }
        
        .settings-arrow {
            width: 12px;
            height: 12px;
            border-top: 2px solid #999;
            border-right: 2px solid #999;
            transform: rotate(45deg);
        }
        
        /* ä¿®æ”¹å¯†ç é¡µé¢æ ·å¼ */
        .password-form {
            padding: 20px;
        }
        
        /* ä¿®æ”¹å¤´åƒé¡µé¢æ ·å¼ */
        .avatar-form {
            padding: 20px;
            text-align: center;
        }
        
        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 20px auto;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-upload {
            margin-top: 20px;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            display: flex;
            border-top: 1px solid #eee;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
        }
        
        .modal-btn.cancel {
            color: #666;
            border-right: 1px solid #eee;
        }
        
        .modal-btn.confirm {
            color: #07C160;
            font-weight: bold;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•/æ³¨å†Œé¡µé¢ -->
        <div id="auth-page" class="content">
            <div class="auth-form">
                <h2 style="text-align: center; margin-bottom: 20px;">æ¬¢è¿ä½¿ç”¨WeChat Clone</h2>
                <div class="form-group">
                    <label for="auth-username">ç”¨æˆ·å</label>
                    <input type="text" id="auth-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="auth-password">å¯†ç </label>
                    <input type="password" id="auth-password" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div id="auth-confirm-password-group" class="form-group" style="display: none;">
                    <label for="auth-confirm-password">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="auth-confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                </div>
                <button id="auth-submit-btn" class="btn">ç™»å½•</button>
                <button id="auth-switch-btn" class="btn btn-secondary">åˆ‡æ¢åˆ°æ³¨å†Œ</button>
                <div class="switch-auth">
                    æ²¡æœ‰è´¦å·ï¼Ÿ<span id="auth-switch-text">ç«‹å³æ³¨å†Œ</span>
                </div>
            </div>
        </div>
        
        <!-- ä¸»é¡µé¢ç»“æ„ -->
        <div id="main-page" style="display: none;">
            <div class="header">
                <span class="back-btn" id="back-btn" style="display: none;">â†</span>
                <span id="header-title">å¾®ä¿¡</span>
            </div>
            
            <div class="content" id="main-content">
                <!-- é¦–é¡µå†…å®¹ä¼šåœ¨JSä¸­åŠ¨æ€åŠ è½½ -->
            </div>
            
            <div class="footer">
                <div class="footer-btn active" data-page="chats">
                    <span>å¾®ä¿¡</span>
                </div>
                <div class="footer-btn" data-page="contacts">
                    <span>é€šè®¯å½•</span>
                </div>
                <div class="footer-btn" data-page="discover">
                    <span>å‘ç°</span>
                </div>
                <div class="footer-btn" data-page="me">
                    <span>æˆ‘</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡†æ¨¡æ¿ -->
    <div id="modal-template" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header" id="modal-header">æ ‡é¢˜</div>
            <div class="modal-body" id="modal-body">å†…å®¹</div>
            <div class="modal-footer">
                <div class="modal-btn cancel" id="modal-cancel">å–æ¶ˆ</div>
                <div class="modal-btn confirm" id="modal-confirm">ç¡®å®š</div>
            </div>
        </div>
    </div>
    
    <script>
        // æ•°æ®å­˜å‚¨
        const DB = {
            users: JSON.parse(localStorage.getItem('wechat_users')) || [],
            currentUser: JSON.parse(localStorage.getItem('wechat_current_user')) || null,
            friends: JSON.parse(localStorage.getItem('wechat_friends')) || {},
            friendRequests: JSON.parse(localStorage.getItem('wechat_friend_requests')) || {},
            chats: JSON.parse(localStorage.getItem('wechat_chats')) || {},
            settings: JSON.parse(localStorage.getItem('wechat_settings')) || {}
        };
        
        // ä¿å­˜æ•°æ®åˆ°localStorage
        function saveData() {
            localStorage.setItem('wechat_users', JSON.stringify(DB.users));
            localStorage.setItem('wechat_current_user', JSON.stringify(DB.currentUser));
            localStorage.setItem('wechat_friends', JSON.stringify(DB.friends));
            localStorage.setItem('wechat_friend_requests', JSON.stringify(DB.friendRequests));
            localStorage.setItem('wechat_chats', JSON.stringify(DB.chats));
            localStorage.setItem('wechat_settings', JSON.stringify(DB.settings));
        }
        
        // åˆå§‹åŒ–ä¸€äº›æµ‹è¯•æ•°æ®ï¼ˆå¦‚æœæ•°æ®åº“ä¸ºç©ºï¼‰
        if (DB.users.length === 0) {
            DB.users = [
                { id: 'user1', username: 'user1', password: '123456', avatar: 'https://randomuser.me/api/portraits/men/1.jpg' },
                { id: 'user2', username: 'user2', password: '123456', avatar: 'https://randomuser.me/api/portraits/women/2.jpg' },
                { id: 'user3', username: 'user3', password: '123456', avatar: 'https://randomuser.me/api/portraits/men/3.jpg' },
                { id: 'user4', username: 'user4', password: '123456', avatar: 'https://randomuser.me/api/portraits/women/4.jpg' },
                { id: 'user5', username: 'user5', password: '123456', avatar: 'https://randomuser.me/api/portraits/men/5.jpg' }
            ];
            
            DB.friends = {
                user1: ['user2', 'user3'],
                user2: ['user1'],
                user3: ['user1'],
                user4: [],
                user5: []
            };
            
            DB.chats = {
                'user1_user2': [
                    { sender: 'user1', content: 'ä½ å¥½ï¼', time: '10:00' },
                    { sender: 'user2', content: 'ä½ å¥½ï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ', time: '10:02' },
                    { sender: 'user1', content: 'è¿˜ä¸é”™ï¼Œä½ å‘¢ï¼Ÿ', time: '10:05' }
                ],
                'user1_user3': [
                    { sender: 'user3', content: 'å—¨ï¼Œæœ‰ç©ºå—ï¼Ÿ', time: '09:30' },
                    { sender: 'user1', content: 'æœ‰å•Šï¼Œä»€ä¹ˆäº‹ï¼Ÿ', time: '09:35' }
                ]
            };
            
            DB.friendRequests = {
                user4: [
                    { from: 'user1', time: '08:00', status: 'pending' }
                ]
            };
            
            saveData();
        }
        
        // å·¥å…·å‡½æ•°
        function getCurrentUserId() {
            return DB.currentUser ? DB.currentUser.id : null;
        }
        
        function getUserById(id) {
            return DB.users.find(user => user.id === id);
        }
        
        function getUserByUsername(username) {
            return DB.users.find(user => user.username === username);
        }
        
        function getChatId(user1, user2) {
            return [user1, user2].sort().join('_');
        }
        
        function formatTime(date = new Date()) {
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }
        
        function showModal(title, content, onConfirm, onCancel) {
            const modal = document.getElementById('modal-template').cloneNode(true);
            modal.id = '';
            modal.style.display = 'flex';
            
            modal.querySelector('#modal-header').textContent = title;
            modal.querySelector('#modal-body').innerHTML = content;
            
            const confirmBtn = modal.querySelector('#modal-confirm');
            const cancelBtn = modal.querySelector('#modal-cancel');
            
            confirmBtn.onclick = () => {
                if (onConfirm) onConfirm();
                document.body.removeChild(modal);
            };
            
            cancelBtn.onclick = () => {
                if (onCancel) onCancel();
                document.body.removeChild(modal);
            };
            
            document.body.appendChild(modal);
        }
        
        // æ³¨å†Œç™»å½•é€»è¾‘
        let isLoginMode = true;
        
        // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ¨¡å¼
        document.getElementById('auth-switch-btn').addEventListener('click', toggleAuthMode);
        document.getElementById('auth-switch-text').addEventListener('click', toggleAuthMode);
        
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            
            const confirmGroup = document.getElementById('auth-confirm-password-group');
            const submitBtn = document.getElementById('auth-submit-btn');
            const switchBtn = document.getElementById('auth-switch-btn');
            const switchText = document.getElementById('auth-switch-text');
            
            if (isLoginMode) {
                confirmGroup.style.display = 'none';
                submitBtn.textContent = 'ç™»å½•';
                switchBtn.textContent = 'åˆ‡æ¢åˆ°æ³¨å†Œ';
                switchText.textContent = 'ç«‹å³æ³¨å†Œ';
            } else {
                confirmGroup.style.display = 'block';
                submitBtn.textContent = 'æ³¨å†Œ';
                switchBtn.textContent = 'åˆ‡æ¢åˆ°ç™»å½•';
                switchText.textContent = 'ç«‹å³ç™»å½•';
            }
        }
        
        // æäº¤è¡¨å•
        document.getElementById('auth-submit-btn').addEventListener('click', handleAuthSubmit);
        
        function handleAuthSubmit() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            
            if (!username || !password) {
                showModal('é”™è¯¯', 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            if (isLoginMode) {
                login(username, password);
            } else {
                const confirmPassword = document.getElementById('auth-confirm-password').value.trim();
                if (password !== confirmPassword) {
                    showModal('é”™è¯¯', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                    return;
                }
                register(username, password);
            }
        }
        
        function login(username, password) {
            const user = getUserByUsername(username);
            
            if (!user) {
                showModal('é”™è¯¯', 'ç”¨æˆ·åä¸å­˜åœ¨');
                return;
            }
            
            if (user.password !== password) {
                showModal('é”™è¯¯', 'å¯†ç ä¸æ­£ç¡®');
                return;
            }
            
            DB.currentUser = user;
            saveData();
            
            // åˆ‡æ¢åˆ°ä¸»é¡µé¢
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('main-page').style.display = 'block';
            
            // åˆå§‹åŒ–ä¸»é¡µé¢
            initMainPage();
        }
        
        function register(username, password) {
            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            if (getUserByUsername(username)) {
                showModal('é”™è¯¯', 'ç”¨æˆ·åå·²å­˜åœ¨');
                return;
            }
            
            // åˆ›å»ºæ–°ç”¨æˆ·
            const newUser = {
                id: 'user' + (DB.users.length + 1),
                username: username,
                password: password,
                avatar: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 50) + 1}.jpg`
            };
            
            DB.users.push(newUser);
            DB.friends[newUser.id] = [];
            DB.currentUser = newUser;
            saveData();
            
            showModal('æ³¨å†ŒæˆåŠŸ', `æ¬¢è¿ ${username}!`, () => {
                // åˆ‡æ¢åˆ°ä¸»é¡µé¢
                document.getElementById('auth-page').style.display = 'none';
                document.getElementById('main-page').style.display = 'block';
                
                // åˆå§‹åŒ–ä¸»é¡µé¢
                initMainPage();
            });
        }
        
        // ä¸»é¡µé¢åˆå§‹åŒ–
        function initMainPage() {
            // åˆå§‹åŒ–åº•éƒ¨å¯¼èˆª
            document.querySelectorAll('.footer-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.footer-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // åˆ‡æ¢åˆ°å¯¹åº”é¡µé¢
                    const page = btn.dataset.page;
                    navigateTo(page);
                });
            });
            
            // åˆå§‹åŒ–è¿”å›æŒ‰é’®
            document.getElementById('back-btn').addEventListener('click', goBack);
            
            // é»˜è®¤æ˜¾ç¤ºèŠå¤©åˆ—è¡¨
            navigateTo('chats');
        }
        
        // é¡µé¢å¯¼èˆªåŠŸèƒ½
        let currentPage = '';
        let pageHistory = [];
        let currentData = {};
        
        function navigateTo(page, data = {}) {
            if (currentPage === page) return;
            
            pageHistory.push({ page: currentPage, data: currentData });
            currentPage = page;
            currentData = data;
            
            renderPage();
        }
        
        function goBack() {
            if (pageHistory.length === 0) return;
            
            const prevPage = pageHistory.pop();
            currentPage = prevPage.page;
            currentData = prevPage.data;
            
            renderPage();
        }
        
        function renderPage() {
            const mainContent = document.getElementById('main-content');
            const backBtn = document.getElementById('back-btn');
            const headerTitle = document.getElementById('header-title');
            
            // æ˜¾ç¤º/éšè—è¿”å›æŒ‰é’®
            backBtn.style.display = pageHistory.length > 0 ? 'block' : 'none';
            
            // æ ¹æ®å½“å‰é¡µé¢æ¸²æŸ“å†…å®¹
            switch (currentPage) {
                case 'chats':
                    renderChatList();
                    headerTitle.textContent = 'å¾®ä¿¡';
                    break;
                case 'contacts':
                    renderContacts();
                    headerTitle.textContent = 'é€šè®¯å½•';
                    break;
                case 'discover':
                    renderDiscover();
                    headerTitle.textContent = 'å‘ç°';
                    break;
                case 'me':
                    renderMe();
                    headerTitle.textContent = 'æˆ‘';
                    break;
                case 'chat':
                    renderChat(currentData.userId);
                    headerTitle.textContent = getUserById(currentData.userId).username;
                    break;
                case 'add-friend':
                    renderAddFriend();
                    headerTitle.textContent = 'æ·»åŠ æœ‹å‹';
                    break;
                case 'friend-requests':
                    renderFriendRequests();
                    headerTitle.textContent = 'æœ‹å‹éªŒè¯';
                    break;
                case 'settings':
                    renderSettings();
                    headerTitle.textContent = 'è®¾ç½®';
                    break;
                case 'change-password':
                    renderChangePassword();
                    headerTitle.textContent = 'ä¿®æ”¹å¯†ç ';
                    break;
                case 'change-avatar':
                    renderChangeAvatar();
                    headerTitle.textContent = 'ä¿®æ”¹å¤´åƒ';
                    break;
                default:
                    renderChatList();
                    headerTitle.textContent = 'å¾®ä¿¡';
            }
        }
        
        // é¡µé¢æ¸²æŸ“å‡½æ•°
        function renderChatList() {
            const currentUserId = getCurrentUserId();
            const friends = DB.friends[currentUserId] || [];
            
            let html = '<ul class="chat-list">';
            
            // æ˜¾ç¤ºä¸æ¯ä¸ªå¥½å‹çš„æœ€è¿‘èŠå¤©
            friends.forEach(friendId => {
                const friend = getUserById(friendId);
                const chatId = getChatId(currentUserId, friendId);
                const messages = DB.chats[chatId] || [];
                const lastMessage = messages[messages.length - 1];
                
                html += `
                    <li class="chat-item" data-user-id="${friendId}">
                        <div class="chat-avatar">
                            <img src="${friend.avatar}" alt="${friend.username}">
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">${friend.username}</div>
                            <div class="chat-last-msg">${lastMessage ? lastMessage.content : 'æš‚æ— æ¶ˆæ¯'}</div>
                        </div>
                        <div class="chat-time">${lastMessage ? lastMessage.time : ''}</div>
                    </li>
                `;
            });
            
            html += '</ul>';
            
            document.getElementById('main-content').innerHTML = html;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo('chat', { userId: item.dataset.userId });
                });
            });
        }
        
        function renderContacts() {
            const currentUserId = getCurrentUserId();
            const friends = DB.friends[currentUserId] || [];
            
            let html = '<ul class="contact-list">';
            
            // æ·»åŠ "æ–°çš„æœ‹å‹"é¡¹
            html += `
                <li class="contact-item" data-page="friend-requests">
                    <div class="contact-avatar" style="background-color: #07C160; color: white; text-align: center; line-height: 40px;">æ–°</div>
                    <div class="contact-name">æ–°çš„æœ‹å‹</div>
                </li>
                <li class="contact-item" data-page="add-friend">
                    <div class="contact-avatar" style="background-color: #07C160; color: white; text-align: center; line-height: 40px;">+</div>
                    <div class="contact-name">æ·»åŠ æœ‹å‹</div>
                </li>
            `;
            
            // æ˜¾ç¤ºå¥½å‹åˆ—è¡¨
            friends.forEach(friendId => {
                const friend = getUserById(friendId);
                
                html += `
                    <li class="contact-item" data-user-id="${friendId}">
                        <div class="contact-avatar">
                            <img src="${friend.avatar}" alt="${friend.username}">
                        </div>
                        <div class="contact-name">${friend.username}</div>
                    </li>
                `;
            });
            
            html += '</ul>';
            
            document.getElementById('main-content').innerHTML = html;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.contact-item[data-user-id]').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo('chat', { userId: item.dataset.userId });
                });
            });
            
            document.querySelectorAll('.contact-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo(item.dataset.page);
                });
            });
        }
        
        function renderDiscover() {
            const html = `
                <ul class="discover-list">
                    <li class="discover-item">
                        <div class="discover-icon">ğŸ“±</div>
                        <div class="discover-name">æœ‹å‹åœˆ</div>
                        <div class="discover-arrow"></div>
                    </li>
                    <li class="discover-item">
                        <div class="discover-icon">ğŸ”</div>
                        <div class="discover-name">æ‰«ä¸€æ‰«</div>
                        <div class="discover-arrow"></div>
                    </li>
                    <li class="discover-item">
                        <div class="discover-icon">ğŸ‘¥</div>
                        <div class="discover-name">é™„è¿‘çš„äºº</div>
                        <div class="discover-arrow"></div>
                    </li>
                    <li class="discover-item">
                        <div class="discover-icon">ğŸ®</div>
                        <div class="discover-name">æ¸¸æˆ</div>
                        <div class="discover-arrow"></div>
                    </li>
                    <li class="discover-item">
                        <div class="discover-icon">ğŸ›ï¸</div>
                        <div class="discover-name">è´­ç‰©</div>
                        <div class="discover-arrow"></div>
                    </li>
                </ul>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }
        
        function renderMe() {
            const currentUser = DB.currentUser;
            
            const html = `
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img src="${currentUser.avatar}" alt="${currentUser.username}">
                    </div>
                    <div class="profile-info">
                        <div class="profile-name">${currentUser.username}</div>
                        <div class="profile-id">å¾®ä¿¡å·: ${currentUser.id}</div>
                    </div>
                    <div class="profile-qrcode">ğŸ“·</div>
                </div>
                <ul class="profile-list">
                    <li class="profile-item" data-page="settings">
                        <div class="profile-icon">âš™ï¸</div>
                        <div class="profile-item-name">è®¾ç½®</div>
                        <div class="profile-arrow"></div>
                    </li>
                </ul>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.profile-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo(item.dataset.page);
                });
            });
        }
        
        function renderChat(userId) {
            const currentUserId = getCurrentUserId();
            const chatId = getChatId(currentUserId, userId);
            const messages = DB.chats[chatId] || [];
            const otherUser = getUserById(userId);
            
            let html = `
                <div class="chat-messages">
            `;
            
            messages.forEach(msg => {
                const isReceived = msg.sender !== currentUserId;
                
                html += `
                    <div class="message ${isReceived ? 'received' : 'sent'}">
                        <div class="message-content">${msg.content}</div>
                        <div class="message-time">${msg.time}</div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                    <button id="send-btn">å‘é€</button>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const messagesContainer = document.querySelector('.chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // æ·»åŠ å‘é€æ¶ˆæ¯äº‹ä»¶
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            function sendMessage() {
                const input = document.getElementById('chat-input');
                const content = input.value.trim();
                
                if (content) {
                    const newMessage = {
                        sender: currentUserId,
                        content: content,
                        time: formatTime()
                    };
                    
                    // æ·»åŠ åˆ°èŠå¤©è®°å½•
                    if (!DB.chats[chatId]) DB.chats[chatId] = [];
                    DB.chats[chatId].push(newMessage);
                    saveData();
                    
                    // é‡æ–°æ¸²æŸ“èŠå¤©
                    renderChat(userId);
                }
            }
        }
        
        function renderAddFriend() {
            const html = `
                <div class="search-bar">
                    <input type="text" id="search-input" class="search-input" placeholder="å¾®ä¿¡å·/æ‰‹æœºå·">
                </div>
                <ul class="search-results" id="search-results">
                    <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </ul>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // æ·»åŠ æœç´¢äº‹ä»¶
            document.getElementById('search-input').addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (query) {
                    searchUsers(query);
                } else {
                    document.getElementById('search-results').innerHTML = '';
                }
            });
        }
        
        function searchUsers(query) {
            const currentUserId = getCurrentUserId();
            const results = DB.users.filter(user => 
                user.id !== currentUserId && 
                (user.id.includes(query) || user.username.includes(query))
            );
            
            let html = '';
            
            results.forEach(user => {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
                const isFriend = DB.friends[currentUserId] && DB.friends[currentUserId].includes(user.id);
                const hasRequest = DB.friendRequests[user.id] && DB.friendRequests[user.id].some(req => req.from === currentUserId);
                
                html += `
                    <li class="search-result-item">
                        <div class="search-result-avatar">
                            <img src="${user.avatar}" alt="${user.username}">
                        </div>
                        <div class="search-result-info">
                            <div class="search-result-name">${user.username}</div>
                            <div class="search-result-id">å¾®ä¿¡å·: ${user.id}</div>
                        </div>
                        <button class="search-result-btn" data-user-id="${user.id}" ${isFriend || hasRequest ? 'disabled style="background-color: #ccc;"' : ''}>
                            ${isFriend ? 'å·²æ·»åŠ ' : hasRequest ? 'å·²å‘é€' : 'æ·»åŠ '}
                        </button>
                    </li>
                `;
            });
            
            document.getElementById('search-results').innerHTML = html;
            
            // æ·»åŠ æ·»åŠ å¥½å‹äº‹ä»¶
            document.querySelectorAll('.search-result-btn:not(:disabled)').forEach(btn => {
                btn.addEventListener('click', () => {
                    sendFriendRequest(btn.dataset.userId);
                    btn.disabled = true;
                    btn.textContent = 'å·²å‘é€';
                    btn.style.backgroundColor = '#ccc';
                });
            });
        }
        
        function sendFriendRequest(toUserId) {
            const fromUserId = getCurrentUserId();
            
            if (!DB.friendRequests[toUserId]) {
                DB.friendRequests[toUserId] = [];
            }
            
            DB.friendRequests[toUserId].push({
                from: fromUserId,
                time: formatTime(),
                status: 'pending'
            });
            
            saveData();
            
            showModal('å‘é€æˆåŠŸ', 'å¥½å‹è¯·æ±‚å·²å‘é€', () => {
                navigateTo('contacts');
            });
        }
        
        function renderFriendRequests() {
            const currentUserId = getCurrentUserId();
            const requests = DB.friendRequests[currentUserId] || [];
            
            let html = '<ul class="contact-list">';
            
            requests.forEach((request, index) => {
                if (request.status !== 'pending') return;
                
                const fromUser = getUserById(request.from);
                
                html += `
                    <li class="request-item">
                        <div class="request-avatar">
                            <img src="${fromUser.avatar}" alt="${fromUser.username}">
                        </div>
                        <div class="request-info">
                            <div class="request-name">${fromUser.username}</div>
                            <div class="request-message">è¯·æ±‚æ·»åŠ ä½ ä¸ºæœ‹å‹</div>
                            <div class="request-actions">
                                <button class="request-btn accept" data-index="${index}">æ¥å—</button>
                                <button class="request-btn reject" data-index="${index}">æ‹’ç»</button>
                            </div>
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            
            document.getElementById('main-content').innerHTML = html;
            
            // æ·»åŠ æ¥å—/æ‹’ç»äº‹ä»¶
            document.querySelectorAll('.request-btn.accept').forEach(btn => {
                btn.addEventListener('click', () => {
                    handleFriendRequest(btn.dataset.index, true);
                });
            });
            
            document.querySelectorAll('.request-btn.reject').forEach(btn => {
                btn.addEventListener('click', () => {
                    handleFriendRequest(btn.dataset.index, false);
                });
            });
        }
        
        function handleFriendRequest(index, accept) {
            const currentUserId = getCurrentUserId();
            const request = DB.friendRequests[currentUserId][index];
            
            if (accept) {
                // æ·»åŠ å¥½å‹
                if (!DB.friends[currentUserId]) DB.friends[currentUserId] = [];
                if (!DB.friends[request.from]) DB.friends[request.from] = [];
                
                if (!DB.friends[currentUserId].includes(request.from)) {
                    DB.friends[currentUserId].push(request.from);
                }
                
                if (!DB.friends[request.from].includes(currentUserId)) {
                    DB.friends[request.from].push(currentUserId);
                }
                
                // åˆå§‹åŒ–èŠå¤©
                const chatId = getChatId(currentUserId, request.from);
                if (!DB.chats[chatId]) {
                    DB.chats[chatId] = [
                        { 
                            sender: request.from, 
                            content: 'æˆ‘ä»¬å·²ç»æ˜¯æœ‹å‹äº†ï¼Œç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº†', 
                            time: formatTime() 
                        }
                    ];
                }
            }
            
            // æ›´æ–°è¯·æ±‚çŠ¶æ€
            DB.friendRequests[currentUserId][index].status = accept ? 'accepted' : 'rejected';
            saveData();
            
            // é‡æ–°æ¸²æŸ“é¡µé¢
            renderFriendRequests();
        }
        
        function renderSettings() {
            const html = `
                <ul class="settings-list">
                    <li class="settings-item" data-page="change-avatar">
                        <div class="settings-icon">ğŸ–¼ï¸</div>
                        <div class="settings-item-name">ä¿®æ”¹å¤´åƒ</div>
                        <div class="settings-arrow"></div>
                    </li>
                    <li class="settings-item" data-page="change-password">
                        <div class="settings-icon">ğŸ”’</div>
                        <div class="settings-item-name">ä¿®æ”¹å¯†ç </div>
                        <div class="settings-arrow"></div>
                    </li>
                    <li class="settings-item" id="logout-btn">
                        <div class="settings-icon">ğŸšª</div>
                        <div class="settings-item-name">é€€å‡ºç™»å½•</div>
                        <div class="settings-arrow"></div>
                    </li>
                </ul>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.settings-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo(item.dataset.page);
                });
            });
            
            // æ·»åŠ é€€å‡ºç™»å½•äº‹ä»¶
            document.getElementById('logout-btn').addEventListener('click', logout);
        }
        
        function renderChangePassword() {
            const html = `
                <div class="password-form">
                    <div class="form-group">
                        <label for="old-password">æ—§å¯†ç </label>
                        <input type="password" id="old-password" placeholder="è¯·è¾“å…¥æ—§å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label for="new-password">æ–°å¯†ç </label>
                        <input type="password" id="new-password" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-password">ç¡®è®¤æ–°å¯†ç </label>
                        <input type="password" id="confirm-new-password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                    </div>
                    <button id="change-password-btn" class="btn">ç¡®è®¤ä¿®æ”¹</button>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // æ·»åŠ ä¿®æ”¹å¯†ç äº‹ä»¶
            document.getElementById('change-password-btn').addEventListener('click', changePassword);
        }
        
        function changePassword() {
            const oldPassword = document.getElementById('old-password').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            const confirmNewPassword = document.getElementById('confirm-new-password').value.trim();
            
            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showModal('é”™è¯¯', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showModal('é”™è¯¯', 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            if (DB.currentUser.password !== oldPassword) {
                showModal('é”™è¯¯', 'æ—§å¯†ç ä¸æ­£ç¡®');
                return;
            }
            
            DB.currentUser.password = newPassword;
            saveData();
            
            showModal('æˆåŠŸ', 'å¯†ç ä¿®æ”¹æˆåŠŸ', () => {
                navigateTo('me');
            });
        }
        
        function renderChangeAvatar() {
            const currentUser = DB.currentUser;
            
            const html = `
                <div class="avatar-form">
                    <div class="avatar-preview">
                        <img src="${currentUser.avatar}" alt="${currentUser.username}">
                    </div>
                    <div class="avatar-upload">
                        <input type="file" id="avatar-upload" accept="image/*">
                        <button id="save-avatar-btn" class="btn">ä¿å­˜å¤´åƒ</button>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            
            // æ·»åŠ å¤´åƒä¸Šä¼ é¢„è§ˆ
            document.getElementById('avatar-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.querySelector('.avatar-preview img').src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // æ·»åŠ ä¿å­˜å¤´åƒäº‹ä»¶
            document.getElementById('save-avatar-btn').addEventListener('click', saveAvatar);
        }
        
        function saveAvatar() {
            const newAvatar = document.querySelector('.avatar-preview img').src;
            
            if (newAvatar === DB.currentUser.avatar) {
                showModal('æç¤º', 'å¤´åƒæœªæ›´æ”¹');
                return;
            }
            
            DB.currentUser.avatar = newAvatar;
            saveData();
            
            showModal('æˆåŠŸ', 'å¤´åƒä¿®æ”¹æˆåŠŸ', () => {
                navigateTo('me');
            });
        }
        
        function logout() {
            DB.currentUser = null;
            saveData();
            
            // åˆ‡æ¢åˆ°ç™»å½•é¡µé¢
            document.getElementById('auth-page').style.display = 'block';
            document.getElementById('main-page').style.display = 'none';
            
            // é‡ç½®è¡¨å•
            document.getElementById('auth-username').value = '';
            document.getElementById('auth-password').value = '';
            document.getElementById('auth-confirm-password').value = '';
            
            // é‡ç½®é¡µé¢çŠ¶æ€
            currentPage = '';
            pageHistory = [];
            currentData = {};
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        if (DB.currentUser) {
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('main-page').style.display = 'block';
            initMainPage();
        }
    </script>
</body>
</html>
